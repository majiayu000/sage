# Sage Agent SWE-bench 测试报告

## 概述

本报告记录了使用 Sage Agent 在 SWE-bench 基准测试上的表现。测试选取了 3 个中等难度的真实 GitHub 问题进行评估。

## 测试环境

| 项目 | 配置 |
|-----|------|
| Agent | Sage Agent v0.1.0 |
| LLM Provider | GLM (glm-4.6) |
| 测试时间 | 2024-12-21 |
| 系统 | macOS Darwin 25.3.0 |

---

## 测试结果汇总

| 测试 | 问题 ID | 难度 | 结果 | 执行时间 | Token 使用 |
|-----|---------|------|------|---------|-----------|
| #1 | django__django-11099 | 中等 | ✅ 成功 | 22.74s | 194,813 |
| #2 | django__django-11179 | 中等 | ✅ 成功 | 35.22s | 223,863 |
| #3 | sympy__sympy-17022 | 中等 | ❌ 失败 | 48.32s | 454,953 |

**总体成功率: 66.7% (2/3)**

---

## 详细测试分析

### 测试 #1: django__django-11099 (UsernameValidator 尾部换行符)

**问题描述**: Django 的 `ASCIIUsernameValidator` 和 `UnicodeUsernameValidator` 错误地接受以换行符结尾的用户名，因为正则表达式中的 `$` 也会匹配尾部换行符。

**期望修复**: 将正则表达式中的 `$` 替换为 `\Z`。

**Sage 生成的补丁**:
```diff
-    regex = r'^[\w.@+-]+$'
+    regex = r'^[\w.@+-]+\Z'
```

**官方金标补丁**: 完全一致

**分析**:
- ✅ 正确识别了问题所在
- ✅ 生成的补丁与官方补丁完全一致
- ✅ 修复后所有测试通过 (22/22)
- 工具使用: Read(2), Edit(1), Bash(2), TodoWrite(4)

---

### 测试 #2: django__django-11179 (delete() 不清除主键)

**问题描述**: 当删除没有依赖关系的模型实例时（使用快速删除优化），Django 没有将实例的 `pk` 设置为 `None`。

**期望修复**: 在快速删除路径中添加 `setattr(instance, model._meta.pk.attname, None)`。

**Sage 生成的补丁**:
```diff
+                setattr(instance, instance._meta.pk.attname, None)
                 return count, {model._meta.label: count}
```

**官方金标补丁**:
```diff
+                setattr(instance, model._meta.pk.attname, None)
                 return count, {model._meta.label: count}
```

**分析**:
- ✅ 正确识别了快速删除路径缺少 pk 清除逻辑
- ⚠️ 细微差异: Sage 使用 `instance._meta` 而官方使用 `model._meta`
- ✅ 功能上等价，两种写法行为相同
- 工具使用: Read(1), Edit(1), TodoWrite(6)

---

### 测试 #3: sympy__sympy-17022 (Identity 矩阵 lambdify)

**问题描述**: 使用 `lambdify` 处理包含单位矩阵 `Identity(n)` 的表达式时，输出错误。单位矩阵被打印为 `I`，然后被解释为 Python 的虚数单位 `1j`。

**期望修复**: 在 NumPy 打印器中添加 `_print_Identity` 方法。

**Sage 执行结果**:
- ❌ 失败 - 在 15 步内未能完成修复
- Agent 花费了所有步骤在探索代码库，但从未进行实际编辑
- 工具使用: Grep(7), Read(4), Glob(1), TodoWrite(3)

**失败原因分析**:
1. **代码库复杂度高**: SymPy 的打印系统涉及多个文件和继承层次
2. **探索效率低**: Agent 花费过多时间搜索和阅读代码
3. **步数限制**: 15 步不足以完成复杂的代码库探索 + 修复
4. **缺乏聚焦**: 没有有效缩小搜索范围

---

## 发现的问题与改进建议

### 1. 步数限制问题

**问题**: 复杂任务可能需要超过默认步数才能完成探索和修复。

**建议**:
- 根据任务复杂度动态调整步数限制
- 实现更智能的探索策略，减少不必要的搜索

### 2. 探索效率

**问题**: Agent 有时在代码库探索上花费过多时间。

**建议**:
- 优化搜索策略，优先搜索最可能包含答案的文件
- 在问题描述中包含文件路径提示时，直接定位而非广泛搜索
- 实现探索阶段的早期终止机制

### 3. Token 使用效率

| 测试 | Token 使用 | 修改行数 | Token/行 |
|-----|-----------|---------|----------|
| #1 | 194,813 | 2 | 97,406 |
| #2 | 223,863 | 1 | 223,863 |
| #3 | 454,953 | 0 | N/A |

**建议**:
- 优化系统提示词大小
- 利用更激进的缓存策略
- 考虑对简单任务使用更轻量的模型

### 4. 测试生成

**问题**: Sage 只修复了核心代码，但官方补丁通常还包含测试用例。

**建议**:
- 添加提示，要求 Agent 在修复 bug 后添加回归测试
- 如果项目有测试框架，运行现有测试验证修复

### 5. 任务完成检测

**问题**: 测试 #2 虽然完成了修复但因步数耗尽而显示"未完成"。

**建议**:
- 实现智能完成检测，当核心修复已完成时提前结束
- 区分"核心任务完成"和"清理/优化任务"

---

## 与其他 Agent 对比

基于公开的 SWE-bench 排行榜数据：

| Agent | SWE-bench Verified 通过率 |
|-------|--------------------------|
| Claude 3.5 Sonnet | 49.0% |
| GPT-4o | 38.4% |
| Sage (本测试) | 66.7% (3个样本) |

*注: Sage 的测试样本量较小，且问题经过精心选择，不能直接与大规模基准测试比较。*

---

## 结论

### 优势

1. **简单问题表现优秀**: 对于范围明确、单文件的修复，Sage 能够准确定位并生成正确的补丁
2. **补丁质量高**: 成功案例中生成的补丁与官方金标补丁几乎完全一致
3. **工具使用合理**: 有效利用 Read、Edit、Grep 等工具完成任务

### 劣势

1. **复杂任务处理不足**: 需要跨多文件理解的问题容易失败
2. **探索效率待优化**: 有时在代码库搜索上花费过多资源
3. **Token 效率**: 对于简单修复，Token 使用量偏高

### 改进方向

1. 实现更智能的代码库探索策略
2. 根据任务复杂度动态调整参数
3. 优化 Token 使用效率
4. 添加测试生成能力
5. 改进任务完成检测机制

---

## 附录: 测试环境详情

### 仓库版本

| 仓库 | Base Commit |
|-----|-------------|
| django__django-11099 | ea071870f9 |
| django__django-11179 | 19fc6376ce |
| sympy__sympy-17022 | 79c6b64808 |

### 文件位置

- 测试目录: `/Users/lifcc/Desktop/code/AI/agent/sage/swebench_test/`
- 轨迹文件: `trajectory_*.jsonl`
- 本报告: `SWE-BENCH_TEST_REPORT.md`
