# BUG-001: Agent 无限工具调用循环导致无输出

## 问题概述

Agent 在处理开放式分析任务时，陷入无限工具调用循环，持续探索代码库但从未输出最终结论。

## 复现场景

**用户输入：**
```
看下这个库 和这个库上一层目录下的openclaudecode 对比一下 有哪些可以改进的
你应该看openclaude的cli.js 而不是看md等 你先分析
```

**预期行为：** Agent 探索代码后输出对比分析报告

**实际行为：** Agent 连续调用 9 次工具，累计消耗 817,608 tokens，耗时 359.5 秒，但最终没有任何文本输出

## 问题分析

### 会话日志分析

Session ID: `a1524a75-7867-449d-a955-34d3ab30d8e9`

| 步骤 | inputTokens | outputTokens | content | 工具调用 |
|------|-------------|--------------|---------|----------|
| 2 | 23,291 | 70 | 有文本 | Glob, bash |
| 3 | 57,196 | 110 | 有文本 | 3x Glob |
| 4 | 57,357 | 143 | 空 | Read, 2x bash |
| 5 | 59,762 | 149 | 有文本 | Read, 3x Glob |
| 6 | 120,697 | 164 | 有文本 | Read, bash |
| 7 | 121,892 | 146 | 有文本 | Read, bash |
| 8 | 124,312 | 371 | 有文本 | Task subagent |
| 9 | 124,687 | 133 | 有文本 | 3x 工具 |
| 10 | 127,040 | 88 | **空** | Read, bash |

### 关键发现

1. **最后一条消息 content 为空字符串** - LLM 只输出工具调用，没有文本
2. **没有 error 类型的日志记录** - 不是程序错误
3. **Task subagent 被调用** - 第 8 条启动了子任务，可能长时间运行
4. **持续的工具调用模式** - Agent 不断获取更多信息但不总结

### 根本原因

**LLM 行为问题：** 模型在处理开放式对比任务时：
- 持续调用工具探索代码库
- 从未判断"信息已足够"
- 没有触发"停止探索、开始总结"的决策

这不是超时或程序错误，而是 Agent 决策逻辑缺陷。

## 影响

- 用户等待数分钟后没有得到任何有价值的输出
- 大量 token 消耗造成成本浪费
- 用户体验极差

## 建议修复方案

### 1. 添加最大工具调用次数限制

```rust
// 在 agent 配置中添加
pub struct AgentConfig {
    /// 单次响应最大连续工具调用次数
    pub max_consecutive_tool_calls: u32,  // 建议默认值: 10
}
```

当达到限制时，强制 agent 输出文本总结。

### 2. 连续空 content 检测

```rust
// 检测连续多次 content 为空的响应
if consecutive_empty_content_count >= 3 {
    // 注入系统提示：要求输出总结
    inject_summary_prompt();
}
```

### 3. Task subagent 超时控制

```rust
pub struct TaskConfig {
    /// 子任务最大执行时间（秒）
    pub subagent_timeout_secs: u64,  // 建议默认值: 120
}
```

### 4. 改进系统提示

在 system prompt 中添加明确指导：

```
当你已经收集了足够的信息来回答用户问题时，停止调用工具并直接输出分析结论。
不要无限制地探索代码库。如果你已经调用了超过 5 次工具，考虑是否该总结了。
```

### 5. 进度反馈机制

让用户知道 agent 在做什么：

```
[探索中] 已读取 5 个文件，发现 3 个关键模块...
[分析中] 正在对比架构差异...
```

## 相关文件

- `crates/sage-core/src/agent/` - Agent 执行逻辑
- `crates/sage-core/src/trajectory/entry.rs` - 日志记录格式
- `~/.sage/sessions/` - 会话存储位置

## 优先级

**高** - 直接影响用户体验和成本

## 状态

- [x] 问题确认
- [x] 根因分析
- [ ] 方案设计
- [ ] 代码实现
- [ ] 测试验证

## 参考

- 问题会话：`~/.sage/sessions/a1524a75-7867-449d-a955-34d3ab30d8e9/`
- 发现时间：2026-01-08
- 使用模型：glm-4.7
