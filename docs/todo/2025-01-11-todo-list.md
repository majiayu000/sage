# Sage Agent 项目任务清单

**创建日期**: 2025-01-11

## 高优先级问题

### 1. 过多的 unwrap() 调用 (1,810 处)
- **问题**: 生产环境中有 panic 风险
- **影响**: 代码稳定性差，可能导致运行时崩溃
- **解决方案**: 建议用 `?` 操作符或 `.context()` 替换
- **优先级**: 🔴 高

### 2. 大量 println! 调用 (643 处)
- **问题**: 应该使用 tracing 进行结构化日志
- **影响**: 影响可观测性和性能
- **解决方案**: 迁移到 tracing 框架
- **优先级**: 🔴 高

### 3. 文件过大 (违反 200 行规范)
以下文件需要拆分：
- `subagent/types.rs` (983 行)
- `agent/base.rs` (936 行)
- `task_management.rs` (931 行)
- `interactive.rs` (921 行)
- **解决方案**: 建议拆分成更小的模块
- **优先级**: 🟡 中

## 性能优化

### 4. 字符串分配优化 (1,494 处 clone/to_string)
- **问题**: LLM client 配置中有大量克隆
- **影响**: 内存分配开销大
- **解决方案**: 可以用引用和生命周期优化
- **优先级**: 🟡 中

### 5. 集合分配优化 (629 处)
- **问题**: 很多 `Vec::new()` 可以用 `with_capacity()` 预分配
- **影响**: 频繁的内存重新分配
- **解决方案**: 使用 `with_capacity()` 预分配容量
- **优先级**: 🟡 中

### 6. 锁竞争优化 (361 处 RwLock 操作)
- **问题**: 高并发场景下的锁竞争
- **解决方案**:
  - 可以用 `DashMap` 替换 `HashMap + RwLock`
  - 非异步场景可用 `parking_lot::Mutex`
- **优先级**: 🟡 中

## 代码一致性

### 7. 静态初始化不统一
- **问题**: 有 `lazy_static!` (8 处) 和 `once_cell` (5 处)
- **解决方案**: 建议统一使用 `once_cell`
- **优先级**: 🟢 低

## 正面发现

✅ **测试覆盖**: 157 个文件有单元测试
✅ **文档完善**: 357 个文件有文档注释
✅ **代码清洁**: 没有 TODO/FIXME 注释

## 优化建议优先级

### 立即处理 (高优先级)
1. 修复 unwrap() 调用 - 提高代码稳定性
2. 将 println! 迁移到 tracing - 改善可观测性

### 计划处理 (中优先级)
3. 拆分大文件 - 提高代码可维护性
4. 性能优化（预分配、减少克隆）- 提升运行效率

### 逐步改进 (低优先级)
5. 统一静态初始化方式 - 提高代码一致性

## 相关文档

- [优化指南](./optimization-guide.md)
- [多代理优化](./multi-agent-optimization.md)
- [UI 交互改进](./ui-interaction-improvement.md)
- [权限系统改进](./permission-system-improvement.md)

## 更新日志

- **2025-01-11**: 初始版本创建，整理当前项目的技术债务和优化方向
