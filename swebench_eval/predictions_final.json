[
  {
    "instance_id": "django__django-10914",
    "model_patch": "diff --git a/django/conf/global_settings.py b/django/conf/global_settings.py\nindex acee9887..146d0cbd 100644\n--- a/django/conf/global_settings.py\n+++ b/django/conf/global_settings.py\n@@ -304,7 +304,9 @@ FILE_UPLOAD_TEMP_DIR = None\n \n # The numeric mode to set newly-uploaded files to. The value should be a mode\n # you'd pass directly to os.chmod; see https://docs.python.org/library/os.html#files-and-directories.\n-FILE_UPLOAD_PERMISSIONS = None\n+# Default to 0o644 to ensure consistent permissions across different upload methods\n+# (MemoryUploadedFile vs TemporaryUploadedFile) and avoid umask-dependent behavior.\n+FILE_UPLOAD_PERMISSIONS = 0o644\n \n # The numeric mode to assign to newly-created directories, when uploading files.\n # The value should be a mode as you'd pass to os.chmod;\ndiff --git a/docs/ref/settings.txt b/docs/ref/settings.txt\nindex 46e99af9..9589dbaa 100644\n--- a/docs/ref/settings.txt\n+++ b/docs/ref/settings.txt\n@@ -1484,16 +1484,22 @@ This value mirrors the functionality and caveats of the\n ``FILE_UPLOAD_PERMISSIONS``\n ---------------------------\n \n-Default: ``None``\n+Default: ``0o644``\n \n The numeric mode (i.e. ``0o644``) to set newly uploaded files to. For\n more information about what these modes mean, see the documentation for\n :func:`os.chmod`.\n \n-If this isn't given or is ``None``, you'll get operating-system\n-dependent behavior. On most platforms, temporary files will have a mode\n-of ``0o600``, and files saved from memory will be saved using the\n-system's standard umask.\n+If this is set to ``None``, you'll get operating-system dependent behavior. \n+On most platforms, temporary files will have a mode of ``0o600``, and files \n+saved from memory will be saved using the system's standard umask. This can \n+result in inconsistent permissions depending on whether the upload was handled\n+by :class:`~django.core.files.uploadhandler.MemoryFileUploadHandler` or\n+:class:`~django.core.files.uploadhandler.TemporaryFileUploadHandler`.\n+\n+The default of ``0o644`` ensures consistent permissions across different upload\n+methods while maintaining appropriate security (owner read/write, group and \n+others read-only).\n \n For security reasons, these permissions aren't applied to the temporary files\n that are stored in :setting:`FILE_UPLOAD_TEMP_DIR`.\ndiff --git a/docs/topics/http/file-uploads.txt b/docs/topics/http/file-uploads.txt\nindex 21a6f068..db63480c 100644\n--- a/docs/topics/http/file-uploads.txt\n+++ b/docs/topics/http/file-uploads.txt\n@@ -214,6 +214,38 @@ Changing upload handler behavior\n There are a few settings which control Django's file upload behavior. See\n :ref:`File Upload Settings <file-upload-settings>` for details.\n \n+.. _file-upload-permissions:\n+\n+File Upload Permissions\n+-----------------------\n+\n+When files are uploaded using Django's :class:`~django.db.models.FileField` or\n+FileSystemStorage, the permissions of the resulting files are controlled by the\n+:setting:`FILE_UPLOAD_PERMISSIONS` setting. \n+\n+By default, Django sets uploaded file permissions to ``0o644`` (owner read/write,\n+group and others read-only). This ensures:\n+\n+* Consistent permissions regardless of whether the file was handled by\n+  :class:`~django.core.files.uploadhandler.MemoryFileUploadHandler` or\n+  :class:`~django.core.files.uploadhandler.TemporaryFileUploadHandler`\n+* Predictable behavior across different systems and umask configurations\n+* Sufficient permissions for web servers to read uploaded files while maintaining\n+  security\n+\n+Prior to Django 5.0, the default was ``None``, which meant file permissions\n+depended on the system's umask and could vary between the two upload handlers.\n+If you need the old behavior, you can set ``FILE_UPLOAD_PERMISSIONS = None`` in\n+your settings.\n+\n+For directory permissions created during file uploads, see the\n+:setting:`FILE_UPLOAD_DIRECTORY_PERMISSIONS` setting.\n+\n+.. warning::\n+\n+    Be careful when making uploaded files executable or writable by group/others,\n+    as this can create security vulnerabilities on shared systems.\n+\n .. _modifying_upload_handlers_on_the_fly:\n \n Modifying upload handlers on the fly\ndiff --git a/tests/file_storage/tests.py b/tests/file_storage/tests.py\nindex 43486955..85bf55f4 100644\n--- a/tests/file_storage/tests.py\n+++ b/tests/file_storage/tests.py\n@@ -899,6 +899,50 @@ class FileStoragePermissions(unittest.TestCase):\n         mode = os.stat(self.storage.path(fname))[0] & 0o777\n         self.assertEqual(mode, 0o666 & ~self.umask)\n \n+    def test_file_upload_new_default_permissions(self):\n+        \"\"\"\n+        Test that the new default FILE_UPLOAD_PERMISSIONS (0o644) is applied\n+        when no explicit setting is provided.\n+        \"\"\"\n+        self.storage = FileSystemStorage(self.storage_dir)\n+        fname = self.storage.save(\"some_file\", ContentFile(\"data\"))\n+        mode = os.stat(self.storage.path(fname))[0] & 0o777\n+        self.assertEqual(mode, 0o644)\n+\n+    def test_file_upload_permissions_consistency(self):\n+        \"\"\"\n+        Test that file permissions are consistent regardless of upload method.\n+        This addresses the issue where TemporaryUploadedFile and InMemoryUploadedFile\n+        could result in different permissions when FILE_UPLOAD_PERMISSIONS was None.\n+        \"\"\"\n+        from django.core.files.uploadhandler import MemoryFileUploadHandler, TemporaryFileUploadHandler\n+        from django.core.files.uploadedfile import InMemoryUploadedFile, TemporaryUploadedFile\n+        \n+        # Simulate small file upload (InMemoryUploadedFile)\n+        memory_handler = MemoryFileUploadHandler()\n+        memory_handler.new_file('test_file', 'test.txt', 'text/plain', 10, 'utf-8', {})\n+        memory_handler.receive_data_chunk(b'test data', 0)\n+        memory_file = memory_handler.file_complete(10)\n+        \n+        # Save InMemoryUploadedFile\n+        self.storage.save(\"memory_file\", memory_file)\n+        memory_mode = os.stat(self.storage.path(\"memory_file\"))[0] & 0o777\n+        \n+        # Simulate large file upload (TemporaryUploadedFile) \n+        temp_handler = TemporaryFileUploadHandler()\n+        temp_handler.new_file('test_file', 'test.txt', 'text/plain', 10, 'utf-8', {})\n+        temp_handler.receive_data_chunk(b'test data', 0)\n+        temp_file = temp_handler.file_complete(10)\n+        \n+        # Save TemporaryUploadedFile\n+        self.storage.save(\"temp_file\", temp_file)\n+        temp_mode = os.stat(self.storage.path(\"temp_file\"))[0] & 0o777\n+        \n+        # Both should have the same permissions (0o644)\n+        self.assertEqual(memory_mode, 0o644)\n+        self.assertEqual(temp_mode, 0o644)\n+        self.assertEqual(memory_mode, temp_mode)\n+\n     @override_settings(FILE_UPLOAD_DIRECTORY_PERMISSIONS=0o765)\n     def test_file_upload_directory_permissions(self):\n         self.storage = FileSystemStorage(self.storage_dir)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-10924",
    "model_patch": "diff --git a/django/db/models/fields/__init__.py b/django/db/models/fields/__init__.py\nindex 0c64748c..2f099493 100644\n--- a/django/db/models/fields/__init__.py\n+++ b/django/db/models/fields/__init__.py\n@@ -1668,6 +1668,15 @@ class FilePathField(Field):\n         kwargs.setdefault('max_length', 100)\n         super().__init__(verbose_name, name, **kwargs)\n \n+    def _get_path(self):\n+        \"\"\"\n+        Return the evaluated path. If path is a callable, call it and return the result.\n+        Otherwise, return the path as-is.\n+        \"\"\"\n+        if callable(self.path):\n+            return self.path()\n+        return self.path\n+\n     def check(self, **kwargs):\n         return [\n             *super().check(**kwargs),\n@@ -1688,7 +1697,12 @@ class FilePathField(Field):\n     def deconstruct(self):\n         name, path, args, kwargs = super().deconstruct()\n         if self.path != '':\n-            kwargs['path'] = self.path\n+            if callable(self.path):\n+                # For callable paths, we need to preserve the callable in migrations\n+                # We'll store a representation that can be reconstructed\n+                kwargs['path'] = self.path\n+            else:\n+                kwargs['path'] = self.path\n         if self.match is not None:\n             kwargs['match'] = self.match\n         if self.recursive is not False:\n@@ -1709,7 +1723,7 @@ class FilePathField(Field):\n \n     def formfield(self, **kwargs):\n         return super().formfield(**{\n-            'path': self.path,\n+            'path': self._get_path(),\n             'match': self.match,\n             'recursive': self.recursive,\n             'form_class': forms.FilePathField,",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11001",
    "model_patch": "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 7649c392..a83f0dc7 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -353,7 +353,9 @@ class SQLCompiler:\n             # not taken into account so we strip it. When this entire method\n             # is refactored into expressions, then we can check each part as we\n             # generate it.\n-            without_ordering = self.ordering_parts.search(sql).group(1)\n+            # Normalize SQL by removing newlines to handle multiline RawSQL expressions\n+            sql_oneline = ' '.join(sql.splitlines())\n+            without_ordering = self.ordering_parts.search(sql_oneline).group(1)\n             params_hash = make_hashable(params)\n             if (without_ordering, params_hash) in seen:\n                 continue\n@@ -366,7 +368,9 @@ class SQLCompiler:\n         if self.query.distinct and not self.query.distinct_fields:\n             select_sql = [t[1] for t in select]\n             for expr, (sql, params, is_ref) in order_by:\n-                without_ordering = self.ordering_parts.search(sql).group(1)\n+                # Normalize SQL by removing newlines to handle multiline RawSQL expressions\n+                sql_oneline = ' '.join(sql.splitlines())\n+                without_ordering = self.ordering_parts.search(sql_oneline).group(1)\n                 if not is_ref and (without_ordering, params) not in select_sql:\n                     extra_select.append((expr, (without_ordering, params), None))\n         return extra_select",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11019",
    "model_patch": "diff --git a/django/forms/widgets.py b/django/forms/widgets.py\nindex 02aa32b2..02b100b6 100644\n--- a/django/forms/widgets.py\n+++ b/django/forms/widgets.py\n@@ -125,29 +125,96 @@ class Media:\n         in a certain order. In JavaScript you may not be able to reference a\n         global or in CSS you might want to override a style.\n         \"\"\"\n-        # Start with a copy of list_1.\n-        combined_list = list(list_1)\n-        last_insert_index = len(list_1)\n-        # Walk list_2 in reverse, inserting each element into combined_list if\n-        # it doesn't already exist.\n-        for path in reversed(list_2):\n-            try:\n-                # Does path already exist in the list?\n-                index = combined_list.index(path)\n-            except ValueError:\n-                # Add path to combined_list since it doesn't exist.\n-                combined_list.insert(last_insert_index, path)\n-            else:\n-                if index > last_insert_index:\n-                    warnings.warn(\n-                        'Detected duplicate Media files in an opposite order:\\n'\n-                        '%s\\n%s' % (combined_list[last_insert_index], combined_list[index]),\n-                        MediaOrderConflictWarning,\n-                    )\n-                # path already exists in the list. Update last_insert_index so\n-                # that the following elements are inserted in front of this one.\n-                last_insert_index = index\n-        return combined_list\n+        # Check for actual order conflicts between common elements\n+        conflict_files = Media._find_order_conflict(list_1, list_2)\n+        if conflict_files:\n+            warnings.warn(\n+                'Detected duplicate Media files in an opposite order:\\n'\n+                '%s\\n%s' % conflict_files,\n+                MediaOrderConflictWarning,\n+            )\n+        \n+        # Create a set of all unique items\n+        all_items = list(dict.fromkeys(list_1 + list_2))  # Preserve order of first appearance\n+        \n+        # Build ordering constraints from both lists (only for items that appear together)\n+        constraints = {}\n+        \n+        def add_constraints_from_list(items):\n+            for i in range(len(items) - 1):\n+                item = items[i]\n+                next_item = items[i + 1]\n+                if item not in constraints:\n+                    constraints[item] = set()\n+                constraints[item].add(next_item)\n+        \n+        add_constraints_from_list(list_1)\n+        add_constraints_from_list(list_2)\n+        \n+        # Perform topological sort with constraints as \"soft\" preferences\n+        # Start with all items in their original order\n+        result = list(all_items)\n+        \n+        # Iteratively improve the ordering to respect constraints\n+        changed = True\n+        iterations = 0\n+        max_iterations = len(all_items) * 2  # Prevent infinite loops\n+        \n+        while changed and iterations < max_iterations:\n+            changed = False\n+            iterations += 1\n+            \n+            for i in range(len(result)):\n+                for j in range(i + 1, len(result)):\n+                    earlier = result[i]\n+                    later = result[j]\n+                    \n+                    # If there's a constraint that later should come before earlier, swap them\n+                    if later in constraints.get(earlier, set()):\n+                        result[i], result[j] = result[j], result[i]\n+                        changed = True\n+                        break\n+                \n+                if changed:\n+                    break\n+        \n+        return result\n+\n+    @staticmethod\n+    def _find_order_conflict(list_1, list_2):\n+        \"\"\"\n+        Find two files that appear in both lists but in different relative orders.\n+        Returns a tuple of (file1, file2) if a conflict is found, None otherwise.\n+        \"\"\"\n+        # Find files that appear in both lists\n+        common_files = set(list_1) & set(list_2)\n+        if len(common_files) < 2:\n+            return None\n+        \n+        # Create position maps for faster lookup\n+        pos1 = {file: i for i, file in enumerate(list_1)}\n+        pos2 = {file: i for i, file in enumerate(list_2)}\n+        \n+        # Check each pair of common files for conflicting order\n+        common_list = list(common_files)\n+        for i in range(len(common_list)):\n+            for j in range(i + 1, len(common_list)):\n+                file1, file2 = common_list[i], common_list[j]\n+                \n+                # Get positions in both lists\n+                pos1_file1 = pos1[file1]\n+                pos1_file2 = pos1[file2]\n+                pos2_file1 = pos2[file1]\n+                pos2_file2 = pos2[file2]\n+                \n+                # Check if the order is different\n+                list1_order = pos1_file1 < pos1_file2\n+                list2_order = pos2_file1 < pos2_file2\n+                \n+                if list1_order != list2_order:\n+                    return (file1, file2)\n+        \n+        return None\n \n     def __add__(self, other):\n         combined = Media()",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11039",
    "model_patch": "diff --git a/django/core/management/commands/sqlmigrate.py b/django/core/management/commands/sqlmigrate.py\nindex f0b663222a..1cb2b43c23 100644\n--- a/django/core/management/commands/sqlmigrate.py\n+++ b/django/core/management/commands/sqlmigrate.py\n@@ -56,7 +56,8 @@ class Command(BaseCommand):\n         targets = [(app_label, migration.name)]\n \n         # Show begin/end around output only for atomic migrations\n-        self.output_transaction = migration.atomic\n+        # if the database supports transactional DDL\n+        self.output_transaction = migration.atomic and connection.features.can_rollback_ddl\n \n         # Make a plan that represents just the requested migrations and show SQL\n         # for it\ndiff --git a/tests/migrations/test_commands.py b/tests/migrations/test_commands.py\nindex 0e8fa9fdd1..58fca6111f 100644\n--- a/tests/migrations/test_commands.py\n+++ b/tests/migrations/test_commands.py\n@@ -616,6 +616,23 @@ class MigrateTests(MigrationTestBase):\n             self.assertNotIn(connection.ops.start_transaction_sql().lower(), queries)\n         self.assertNotIn(connection.ops.end_transaction_sql().lower(), queries)\n \n+    @override_settings(MIGRATION_MODULES={\"migrations\": \"migrations.test_migrations\"})\n+    def test_sqlmigrate_for_non_transactional_ddl(self):\n+        \"\"\"\n+        Transaction wrappers aren't shown for databases that don't support\n+        transactional DDL, even if the migration is atomic.\n+        \"\"\"\n+        out = io.StringIO()\n+        # Mock can_rollback_ddl to False to simulate a database that doesn't\n+        # support transactional DDL\n+        with mock.patch.object(connection.features, 'can_rollback_ddl', False):\n+            call_command(\"sqlmigrate\", \"migrations\", \"0001\", stdout=out)\n+        output = out.getvalue().lower()\n+        queries = [q.strip() for q in output.splitlines()]\n+        if connection.ops.start_transaction_sql():\n+            self.assertNotIn(connection.ops.start_transaction_sql().lower(), queries)\n+        self.assertNotIn(connection.ops.end_transaction_sql().lower(), queries)\n+\n     @override_settings(\n         INSTALLED_APPS=[\n             \"migrations.migrations_test_apps.migrated_app\",",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11049",
    "model_patch": "diff --git a/django/db/models/fields/__init__.py b/django/db/models/fields/__init__.py\nindex f32ce646..87b944fd 100644\n--- a/django/db/models/fields/__init__.py\n+++ b/django/db/models/fields/__init__.py\n@@ -1587,10 +1587,14 @@ class DurationField(Field):\n     empty_strings_allowed = False\n     default_error_messages = {\n         'invalid': _(\"'%(value)s' value has an invalid format. It must be in \"\n-                     \"[DD] [HH:[MM:]]ss[.uuuuuu] format.\")\n+                     \"[DD] [[HH:]MM:]ss[.uuuuuu] format.\")\n     }\n     description = _(\"Duration\")\n \n+    def __init__(self, *args, **kwargs):\n+        kwargs.setdefault('help_text', _('Enter a duration in the format [DD] [[HH:]MM:]ss[.uuuuuu].'))\n+        super().__init__(*args, **kwargs)\n+\n     def get_internal_type(self):\n         return \"DurationField\"\n \ndiff --git a/tests/model_fields/test_durationfield.py b/tests/model_fields/test_durationfield.py\nindex b73994f8..f1c82ab8 100644\n--- a/tests/model_fields/test_durationfield.py\n+++ b/tests/model_fields/test_durationfield.py\n@@ -75,7 +75,7 @@ class TestValidation(SimpleTestCase):\n         self.assertEqual(\n             cm.exception.message % cm.exception.params,\n             \"'not a datetime' value has an invalid format. \"\n-            \"It must be in [DD] [HH:[MM:]]ss[.uuuuuu] format.\"\n+            \"It must be in [DD] [[HH:]MM:]ss[.uuuuuu] format.\"\n         )",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11099",
    "model_patch": "diff --git a/django/contrib/auth/validators.py b/django/contrib/auth/validators.py\nindex b4878cfd..1304f20a 100644\n--- a/django/contrib/auth/validators.py\n+++ b/django/contrib/auth/validators.py\n@@ -7,7 +7,7 @@ from django.utils.translation import gettext_lazy as _\n \n @deconstructible\n class ASCIIUsernameValidator(validators.RegexValidator):\n-    regex = r'^[\\w.@+-]+$'\n+    regex = r'\\A[\\w.@+-]+\\Z'\n     message = _(\n         'Enter a valid username. This value may contain only English letters, '\n         'numbers, and @/./+/-/_ characters.'\n@@ -17,7 +17,7 @@ class ASCIIUsernameValidator(validators.RegexValidator):\n \n @deconstructible\n class UnicodeUsernameValidator(validators.RegexValidator):\n-    regex = r'^[\\w.@+-]+$'\n+    regex = r'\\A[\\w.@+-]+\\Z'\n     message = _(\n         'Enter a valid username. This value may contain only letters, '\n         'numbers, and @/./+/-/_ characters.'\ndiff --git a/tests/auth_tests/test_validators.py b/tests/auth_tests/test_validators.py\nindex 1c2c6b4a..d3211661 100644\n--- a/tests/auth_tests/test_validators.py\n+++ b/tests/auth_tests/test_validators.py\n@@ -259,3 +259,59 @@ class UsernameValidatorsTests(SimpleTestCase):\n             with self.subTest(invalid=invalid):\n                 with self.assertRaises(ValidationError):\n                     v(invalid)\n+\n+    def test_ascii_validator_rejects_trailing_newline(self):\n+        \"\"\"\n+        ASCIIUsernameValidator should reject usernames that end with a newline.\n+        Tests the fix for the security issue where $ in regex matches trailing newlines.\n+        \"\"\"\n+        v = validators.ASCIIUsernameValidator()\n+        # These should all be rejected\n+        invalid_usernames = [\n+            'testuser\\n',\n+            'testuser\\r\\n',\n+            'testuser\\r',\n+            'user\\nname',  # newline in middle should also be rejected\n+        ]\n+        for invalid in invalid_usernames:\n+            with self.subTest(invalid=invalid):\n+                with self.assertRaises(ValidationError):\n+                    v(invalid)\n+\n+    def test_unicode_validator_rejects_trailing_newline(self):\n+        \"\"\"\n+        UnicodeUsernameValidator should reject usernames that end with a newline.\n+        Tests the fix for the security issue where $ in regex matches trailing newlines.\n+        \"\"\"\n+        v = validators.UnicodeUsernameValidator()\n+        # These should all be rejected\n+        invalid_usernames = [\n+            'testuser\\n',\n+            'testuser\\r\\n', \n+            'testuser\\r',\n+            'user\\nname',  # newline in middle should also be rejected\n+            '\u7528\u6237\\n',  # Unicode username with trailing newline\n+        ]\n+        for invalid in invalid_usernames:\n+            with self.subTest(invalid=invalid):\n+                with self.assertRaises(ValidationError):\n+                    v(invalid)\n+\n+    def test_valid_usernames_without_newlines(self):\n+        \"\"\"\n+        Valid usernames (without newlines) should still be accepted.\n+        \"\"\"\n+        ascii_validator = validators.ASCIIUsernameValidator()\n+        unicode_validator = validators.UnicodeUsernameValidator()\n+        \n+        # Test ASCII usernames\n+        valid_ascii_usernames = ['testuser', 'user.name', 'user@domain', 'user+test', 'user-test', 'user_test']\n+        for valid in valid_ascii_usernames:\n+            with self.subTest(ascii_valid=valid):\n+                ascii_validator(valid)\n+        \n+        # Test Unicode usernames  \n+        valid_unicode_usernames = ['testuser', '\u7528\u6237', 'Ren\u00e9', 'user.name', 'user@domain', 'user+test', 'user-test', 'user_test']\n+        for valid in valid_unicode_usernames:\n+            with self.subTest(unicode_valid=valid):\n+                unicode_validator(valid)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11133",
    "model_patch": "diff --git a/django/http/response.py b/django/http/response.py\nindex 6a84e193..a5072852 100644\n--- a/django/http/response.py\n+++ b/django/http/response.py\n@@ -226,10 +226,10 @@ class HttpResponseBase:\n         # an instance of a subclass, this function returns `bytes(value)`.\n         # This doesn't make a copy when `value` already contains bytes.\n \n-        # Handle string types -- we can't rely on force_bytes here because:\n+        # Handle bytes-like objects -- we can't rely on force_bytes here because:\n         # - Python attempts str conversion first\n         # - when self._charset != 'utf-8' it re-encodes the content\n-        if isinstance(value, bytes):\n+        if isinstance(value, (bytes, memoryview)):\n             return bytes(value)\n         if isinstance(value, str):\n             return bytes(value.encode(self.charset))\n@@ -309,7 +309,7 @@ class HttpResponse(HttpResponseBase):\n     @content.setter\n     def content(self, value):\n         # Consume iterators upon assignment to allow repeated iteration.\n-        if hasattr(value, '__iter__') and not isinstance(value, (bytes, str)):\n+        if hasattr(value, '__iter__') and not isinstance(value, (bytes, memoryview, str)):\n             content = b''.join(self.make_bytes(chunk) for chunk in value)\n             if hasattr(value, 'close'):\n                 try:",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11179",
    "model_patch": "diff --git a/django/db/models/deletion.py b/django/db/models/deletion.py\nindex 92fe4affb9..3a462f1c4c 100644\n--- a/django/db/models/deletion.py\n+++ b/django/db/models/deletion.py\n@@ -277,6 +277,7 @@ class Collector:\n             if self.can_fast_delete(instance):\n                 with transaction.mark_for_rollback_on_error():\n                     count = sql.DeleteQuery(model).delete_batch([instance.pk], self.using)\n+                setattr(instance, model._meta.pk.attname, None)\n                 return count, {model._meta.label: count}\n \n         with transaction.atomic(using=self.using, savepoint=False):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11283",
    "model_patch": "diff --git a/django/contrib/auth/migrations/0011_update_proxy_permissions.py b/django/contrib/auth/migrations/0011_update_proxy_permissions.py\nindex 0e66649695..40fad76870 100644\n--- a/django/contrib/auth/migrations/0011_update_proxy_permissions.py\n+++ b/django/contrib/auth/migrations/0011_update_proxy_permissions.py\n@@ -24,10 +24,23 @@ def update_proxy_model_permissions(apps, schema_editor, reverse=False):\n         proxy_content_type = ContentType.objects.get_for_model(Model, for_concrete_model=False)\n         old_content_type = proxy_content_type if reverse else concrete_content_type\n         new_content_type = concrete_content_type if reverse else proxy_content_type\n-        Permission.objects.filter(\n+        # Handle the case where permissions might already exist with the new content type\n+        # (e.g., if a model was recreated as a proxy)\n+        for permission in Permission.objects.filter(\n             permissions_query,\n             content_type=old_content_type,\n-        ).update(content_type=new_content_type)\n+        ):\n+            try:\n+                existing_permission = Permission.objects.get(\n+                    codename=permission.codename,\n+                    content_type=new_content_type,\n+                )\n+                # Permission already exists with new content type, delete the old one\n+                permission.delete()\n+            except Permission.DoesNotExist:\n+                # Permission doesn't exist with new content type, update it\n+                permission.content_type = new_content_type\n+                permission.save(update_fields=['content_type'])\n \n \n def revert_proxy_model_permissions(apps, schema_editor):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "astropy__astropy-6938",
    "model_patch": "diff --git a/astropy/io/fits/fitsrec.py b/astropy/io/fits/fitsrec.py\nindex 574b4073b1..cb79142dce 100644\n--- a/astropy/io/fits/fitsrec.py\n+++ b/astropy/io/fits/fitsrec.py\n@@ -1261,7 +1261,7 @@ class FITS_rec(np.recarray):\n \n         # Replace exponent separator in floating point numbers\n         if 'D' in format:\n-            output_field.replace(encode_ascii('E'), encode_ascii('D'))\n+            output_field = output_field.replace(encode_ascii('E'), encode_ascii('D'))\n \n \n def _get_recarray_field(array, key):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "astropy__astropy-7746",
    "model_patch": "diff --git a/astropy/wcs/wcs.py b/astropy/wcs/wcs.py\nindex d3a06f2b31..ccb707b6a8 100644\n--- a/astropy/wcs/wcs.py\n+++ b/astropy/wcs/wcs.py\n@@ -1218,6 +1218,12 @@ reduce these to 2 dimensions using the naxis kwarg.\n                 raise ValueError(\n                     \"Coordinate arrays are not broadcastable to each other\")\n \n+            # Check if any axis is empty, and if so, return empty arrays\n+            if axes[0].size == 0:\n+                if ra_dec_order and sky == 'output':\n+                    return tuple(np.array([], dtype=np.float64) for _ in range(2))\n+                return [np.array([], dtype=np.float64) for _ in range(self.naxis)]\n+\n             xy = np.hstack([x.reshape((x.size, 1)) for x in axes])\n \n             if ra_dec_order and sky == 'input':\n@@ -1235,6 +1241,11 @@ reduce these to 2 dimensions using the naxis kwarg.\n                 raise ValueError(\n                     \"When providing two arguments, the array must be \"\n                     \"of shape (N, {0})\".format(self.naxis))\n+\n+            # Check if the array is empty, and if so, return empty array\n+            if xy.size == 0:\n+                return xy.copy()\n+\n             if ra_dec_order and sky == 'input':\n                 xy = self._denormalize_sky(xy)\n             result = func(xy, origin)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11422",
    "model_patch": "diff --git a/django/utils/autoreload.py b/django/utils/autoreload.py\nindex 7ca0d68fae..cb7cd1c725 100644\n--- a/django/utils/autoreload.py\n+++ b/django/utils/autoreload.py\n@@ -114,7 +114,15 @@ def iter_modules_and_files(modules, extra_files):\n         # During debugging (with PyDev) the 'typing.io' and 'typing.re' objects\n         # are added to sys.modules, however they are types not modules and so\n         # cause issues here.\n-        if not isinstance(module, ModuleType) or getattr(module, '__spec__', None) is None:\n+        if not isinstance(module, ModuleType):\n+            continue\n+        if module.__name__ == '__main__':\n+            # __main__ (usually manage.py) doesn't always have a __spec__ set.\n+            # Handle this by falling back to using __file__, resolved below.\n+            # See https://docs.python.org/reference/import.html#main-spec\n+            sys_file_paths.append(module.__file__)\n+            continue\n+        if getattr(module, '__spec__', None) is None:\n             continue\n         spec = module.__spec__\n         # Modules could be loaded from places without a concrete location. If",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11583",
    "model_patch": "diff --git a/django/utils/autoreload.py b/django/utils/autoreload.py\nindex 25c3b44250..3654675136 100644\n--- a/django/utils/autoreload.py\n+++ b/django/utils/autoreload.py\n@@ -139,9 +139,9 @@ def iter_modules_and_files(modules, extra_files):\n         path = Path(filename)\n         try:\n             resolved_path = path.resolve(strict=True).absolute()\n-        except FileNotFoundError:\n-            # The module could have been removed, don't fail loudly if this\n-            # is the case.\n+        except (FileNotFoundError, ValueError):\n+            # The module could have been removed, or the path could contain a null\n+            # byte. Don't fail loudly if this is the case.\n             continue\n         results.add(resolved_path)\n     return frozenset(results)\n@@ -187,7 +187,9 @@ def sys_path_directories():\n         path = Path(path)\n         try:\n             resolved_path = path.resolve(strict=True).absolute()\n-        except FileNotFoundError:\n+        except (FileNotFoundError, ValueError):\n+            # The path could have been removed, or the path could contain a null\n+            # byte. Skip it.\n             continue\n         # If the path is a file (like a zip file), watch the parent directory.\n         if resolved_path.is_file():",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11620",
    "model_patch": "diff --git a/django/urls/resolvers.py b/django/urls/resolvers.py\nindex 2154a46320..bc8b12abf6 100644\n--- a/django/urls/resolvers.py\n+++ b/django/urls/resolvers.py\n@@ -17,6 +17,7 @@ from django.conf import settings\n from django.core.checks import Error, Warning\n from django.core.checks.urls import check_resolver\n from django.core.exceptions import ImproperlyConfigured, ViewDoesNotExist\n+from django.http import Http404\n from django.utils.datastructures import MultiValueDict\n from django.utils.functional import cached_property\n from django.utils.http import RFC3986_SUBDELIMS, escape_leading_slashes\n@@ -260,6 +261,8 @@ class RoutePattern(CheckURLMixin):\n                     kwargs[key] = converter.to_python(value)\n                 except ValueError:\n                     return None\n+                except Http404 as e:\n+                    raise Resolver404({'path': path}) from e\n             return path[match.end():], (), kwargs\n         return None\n \ndiff --git a/tests/urlpatterns/tests.py b/tests/urlpatterns/tests.py\nindex 214739f678..1ecbfe422d 100644\n--- a/tests/urlpatterns/tests.py\n+++ b/tests/urlpatterns/tests.py\n@@ -212,6 +212,18 @@ class ConversionExceptionTests(SimpleTestCase):\n         with self.assertRaises(Resolver404):\n             resolve('/dynamic/abc/')\n \n+    def test_resolve_http404(self):\n+        \"\"\"Http404 in to_python() should be converted to Resolver404.\"\"\"\n+        from django.http import Http404\n+\n+        @DynamicConverter.register_to_python\n+        def raises_http404(value):\n+            raise Http404('Object not found')\n+        with self.assertRaises(Resolver404) as cm:\n+            resolve('/dynamic/abc/')\n+        # The Resolver404 should contain path information\n+        self.assertIn('path', cm.exception.args[0])\n+\n     def test_resolve_type_error_propagates(self):\n         @DynamicConverter.register_to_python\n         def raises_type_error(value):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11630",
    "model_patch": "diff --git a/django/core/checks/model_checks.py b/django/core/checks/model_checks.py\nindex 5c2266ca1d..00d53a7d63 100644\n--- a/django/core/checks/model_checks.py\n+++ b/django/core/checks/model_checks.py\n@@ -5,6 +5,7 @@ from itertools import chain\n \n from django.apps import apps\n from django.core.checks import Error, Tags, register\n+from django.db import connections\n \n \n @register(Tags.models)\n@@ -37,14 +38,65 @@ def check_all_models(app_configs=None, **kwargs):\n             constraints[model_constraint.name].append(model._meta.label)\n     for db_table, model_labels in db_table_models.items():\n         if len(model_labels) != 1:\n-            errors.append(\n-                Error(\n-                    \"db_table '%s' is used by multiple models: %s.\"\n-                    % (db_table, ', '.join(db_table_models[db_table])),\n-                    obj=db_table,\n-                    id='models.E028',\n+            # Check if models with the same db_table can coexist in different databases.\n+            # Build a mapping of model labels to actual model objects\n+            model_map = {}\n+            for model in models:\n+                if model._meta.managed and not model._meta.proxy and model._meta.db_table == db_table:\n+                    model_map[model._meta.label] = model\n+            \n+            # Check each pair of models with the same table name\n+            conflicts = []\n+            model_labels_list = list(model_labels)\n+            \n+            for i in range(len(model_labels_list)):\n+                for j in range(i + 1, len(model_labels_list)):\n+                    model1_label = model_labels_list[i]\n+                    model2_label = model_labels_list[j]\n+                    model1 = model_map[model1_label]\n+                    model2 = model_map[model2_label]\n+                    \n+                    # Check if these two models can coexist in different databases\n+                    # If there exists any database where both can migrate, it's a conflict\n+                    has_conflict = False\n+                    for db in connections:\n+                        try:\n+                            router = connections[db].router\n+                            # Check if both models can migrate to this database\n+                            model1_allowed = router.allow_migrate(\n+                                db, model1._meta.app_label,\n+                                model_name=model1._meta.model_name,\n+                                model=model1\n+                            )\n+                            model2_allowed = router.allow_migrate(\n+                                db, model2._meta.app_label,\n+                                model_name=model2._meta.model_name,\n+                                model=model2\n+                            )\n+                            \n+                            # If both can migrate to the same database, it's a conflict\n+                            if model1_allowed and model2_allowed:\n+                                has_conflict = True\n+                                break\n+                        except (AttributeError, TypeError):\n+                            # If router checking fails, assume conflict for safety\n+                            has_conflict = True\n+                            break\n+                    \n+                    if has_conflict:\n+                        conflicts.extend([model1_label, model2_label])\n+            \n+            # Only raise error if there are actual conflicts\n+            if conflicts:\n+                unique_conflicts = sorted(set(conflicts))\n+                errors.append(\n+                    Error(\n+                        \"db_table '%s' is used by multiple models: %s.\"\n+                        % (db_table, ', '.join(unique_conflicts)),\n+                        obj=db_table,\n+                        id='models.E028',\n+                    )\n                 )\n-            )\n     for index_name, model_labels in indexes.items():\n         if len(model_labels) > 1:\n             model_labels = set(model_labels)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11742",
    "model_patch": "diff --git a/django/db/models/fields/__init__.py b/django/db/models/fields/__init__.py\nindex 9ce46e3f73..c6fd26e296 100644\n--- a/django/db/models/fields/__init__.py\n+++ b/django/db/models/fields/__init__.py\n@@ -955,6 +955,7 @@ class CharField(Field):\n         return [\n             *super().check(**kwargs),\n             *self._check_max_length_attribute(**kwargs),\n+            *self._check_max_length_with_choices(),\n         ]\n \n     def _check_max_length_attribute(self, **kwargs):\n@@ -978,6 +979,39 @@ class CharField(Field):\n         else:\n             return []\n \n+    def _check_max_length_with_choices(self):\n+        if not self.choices or self.max_length is None:\n+            return []\n+\n+        # Find the longest choice value\n+        max_choice_length = 0\n+        for choice in self.choices:\n+            # Handle grouped choices: [group_name, [value, display]]\n+            if isinstance(choice, (list, tuple)) and len(choice) == 2:\n+                group_name, group_choices = choice\n+                if isinstance(group_choices, (list, tuple)):\n+                    # This is a grouped choice\n+                    for value, _ in group_choices:\n+                        if isinstance(value, str):\n+                            max_choice_length = max(max_choice_length, len(value))\n+                else:\n+                    # This is a regular choice: [value, display]\n+                    value, display = choice\n+                    if isinstance(value, str):\n+                        max_choice_length = max(max_choice_length, len(value))\n+\n+        if max_choice_length > self.max_length:\n+            return [\n+                checks.Error(\n+                    \"'max_length' is too small to fit the longest value in 'choices' \"\n+                    \"(%d characters).\" % max_choice_length,\n+                    hint=\"Increase 'max_length' to at least %d.\" % max_choice_length,\n+                    obj=self,\n+                    id='fields.E122',\n+                )\n+            ]\n+        return []\n+\n     def cast_db_type(self, connection):\n         if self.max_length is None:\n             return connection.ops.cast_char_field_without_max_length\ndiff --git a/tests/invalid_models_tests/test_ordinary_fields.py b/tests/invalid_models_tests/test_ordinary_fields.py\nindex 5bb1847a70..7182084970 100644\n--- a/tests/invalid_models_tests/test_ordinary_fields.py\n+++ b/tests/invalid_models_tests/test_ordinary_fields.py\n@@ -352,6 +352,47 @@ class CharFieldTests(SimpleTestCase):\n             )\n         ])\n \n+    def test_max_length_with_long_choice_value(self):\n+        class Model(models.Model):\n+            field = models.CharField(max_length=2, choices=[('aaa', 'AAA'), ('b', 'B')])\n+\n+        field = Model._meta.get_field('field')\n+        self.assertEqual(field.check(), [\n+            Error(\n+                \"'max_length' is too small to fit the longest value in 'choices' (3 characters).\",\n+                hint=\"Increase 'max_length' to at least 3.\",\n+                obj=field,\n+                id='fields.E122',\n+            ),\n+        ])\n+\n+    def test_max_length_with_long_choice_value_grouped(self):\n+        class Model(models.Model):\n+            field = models.CharField(\n+                max_length=2,\n+                choices=[\n+                    ['Group 1', [['aaa', 'AAA'], ['b', 'B']]],\n+                    ['Group 2', [['cc', 'CC']]],\n+                ]\n+            )\n+\n+        field = Model._meta.get_field('field')\n+        self.assertEqual(field.check(), [\n+            Error(\n+                \"'max_length' is too small to fit the longest value in 'choices' (3 characters).\",\n+                hint=\"Increase 'max_length' to at least 3.\",\n+                obj=field,\n+                id='fields.E122',\n+            ),\n+        ])\n+\n+    def test_max_length_with_fitting_choice_values(self):\n+        class Model(models.Model):\n+            field = models.CharField(max_length=5, choices=[('a', 'A'), ('bb', 'BB'), ('ccc', 'CCC')])\n+\n+        field = Model._meta.get_field('field')\n+        self.assertEqual(field.check(), [])\n+\n \n @isolate_apps('invalid_models_tests')\n class DateFieldTests(SimpleTestCase):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11797",
    "model_patch": "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex e287a6f55a..856223109f 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -107,10 +107,14 @@ class SQLCompiler:\n         # Note that even if the group_by is set, it is only the minimal\n         # set to group by. So, we need to add cols in select, order_by, and\n         # having into the select in any case.\n-        for expr, _, _ in select:\n-            cols = expr.get_group_by_cols()\n-            for col in cols:\n-                expressions.append(col)\n+        # However, if the group_by is explicitly set (a tuple), then don't\n+        # add columns from the select clause as this will override the\n+        # explicitly set GROUP BY.\n+        if self.query.group_by is True or self.query.group_by is None:\n+            for expr, _, _ in select:\n+                cols = expr.get_group_by_cols()\n+                for col in cols:\n+                    expressions.append(col)\n         for expr, (sql, params, is_ref) in order_by:\n             # Skip References to the select clause, as all expressions in the\n             # select clause are already part of the group by.",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11815",
    "model_patch": "diff --git a/django/db/migrations/serializer.py b/django/db/migrations/serializer.py\nindex 27b5cbd379..23e70672ff 100644\n--- a/django/db/migrations/serializer.py\n+++ b/django/db/migrations/serializer.py\n@@ -120,9 +120,7 @@ class EnumSerializer(BaseSerializer):\n     def serialize(self):\n         enum_class = self.value.__class__\n         module = enum_class.__module__\n-        v_string, v_imports = serializer_factory(self.value.value).serialize()\n-        imports = {'import %s' % module, *v_imports}\n-        return \"%s.%s(%s)\" % (module, enum_class.__name__, v_string), imports\n+        return \"%s.%s[%r]\" % (module, enum_class.__name__, self.value.name), {'import %s' % module}\n \n \n class FloatSerializer(BaseSimpleSerializer):\ndiff --git a/tests/migrations/test_writer.py b/tests/migrations/test_writer.py\nindex f97d76e9ad..39c9ab47b9 100644\n--- a/tests/migrations/test_writer.py\n+++ b/tests/migrations/test_writer.py\n@@ -267,15 +267,15 @@ class WriterTests(SimpleTestCase):\n \n         self.assertSerializedResultEqual(\n             TextEnum.A,\n-            (\"migrations.test_writer.TextEnum('a-value')\", {'import migrations.test_writer'})\n+            (\"migrations.test_writer.TextEnum['A']\", {'import migrations.test_writer'})\n         )\n         self.assertSerializedResultEqual(\n             BinaryEnum.A,\n-            (\"migrations.test_writer.BinaryEnum(b'a-value')\", {'import migrations.test_writer'})\n+            (\"migrations.test_writer.BinaryEnum['A']\", {'import migrations.test_writer'})\n         )\n         self.assertSerializedResultEqual(\n             IntEnum.B,\n-            (\"migrations.test_writer.IntEnum(2)\", {'import migrations.test_writer'})\n+            (\"migrations.test_writer.IntEnum['B']\", {'import migrations.test_writer'})\n         )\n \n         field = models.CharField(default=TextEnum.B, choices=[(m.value, m) for m in TextEnum])\n@@ -283,27 +283,27 @@ class WriterTests(SimpleTestCase):\n         self.assertEqual(\n             string,\n             \"models.CharField(choices=[\"\n-            \"('a-value', migrations.test_writer.TextEnum('a-value')), \"\n-            \"('value-b', migrations.test_writer.TextEnum('value-b'))], \"\n-            \"default=migrations.test_writer.TextEnum('value-b'))\"\n+            \"('a-value', migrations.test_writer.TextEnum['A']), \"\n+            \"('value-b', migrations.test_writer.TextEnum['B'])], \"\n+            \"default=migrations.test_writer.TextEnum['B'])\"\n         )\n         field = models.CharField(default=BinaryEnum.B, choices=[(m.value, m) for m in BinaryEnum])\n         string = MigrationWriter.serialize(field)[0]\n         self.assertEqual(\n             string,\n             \"models.CharField(choices=[\"\n-            \"(b'a-value', migrations.test_writer.BinaryEnum(b'a-value')), \"\n-            \"(b'value-b', migrations.test_writer.BinaryEnum(b'value-b'))], \"\n-            \"default=migrations.test_writer.BinaryEnum(b'value-b'))\"\n+            \"(b'a-value', migrations.test_writer.BinaryEnum['A']), \"\n+            \"(b'value-b', migrations.test_writer.BinaryEnum['B'])], \"\n+            \"default=migrations.test_writer.BinaryEnum['B'])\"\n         )\n         field = models.IntegerField(default=IntEnum.A, choices=[(m.value, m) for m in IntEnum])\n         string = MigrationWriter.serialize(field)[0]\n         self.assertEqual(\n             string,\n             \"models.IntegerField(choices=[\"\n-            \"(1, migrations.test_writer.IntEnum(1)), \"\n-            \"(2, migrations.test_writer.IntEnum(2))], \"\n-            \"default=migrations.test_writer.IntEnum(1))\"\n+            \"(1, migrations.test_writer.IntEnum['A']), \"\n+            \"(2, migrations.test_writer.IntEnum['B'])], \"\n+            \"default=migrations.test_writer.IntEnum['A'])\"\n         )\n \n     def test_serialize_choices(self):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11848",
    "model_patch": "diff --git a/django/utils/http.py b/django/utils/http.py\nindex 572cfb4347..d1cedb4349 100644\n--- a/django/utils/http.py\n+++ b/django/utils/http.py\n@@ -176,10 +176,16 @@ def parse_http_date(date):\n     try:\n         year = int(m.group('year'))\n         if year < 100:\n-            if year < 70:\n-                year += 2000\n-            else:\n-                year += 1900\n+            # RFC 7231: Recipients of timestamp in rfc850-date format (two-digit year)\n+            # MUST interpret a timestamp that appears to be more than 50 years in the\n+            # future as representing the most recent year in the past that had the\n+            # same last two digits.\n+            current_year = datetime.datetime.utcnow().year\n+            current_century = current_year // 100 * 100\n+            year += current_century\n+            # \"more than 50 years\" means > 50, not >= 50\n+            if year - current_year > 50:\n+                year -= 100\n         month = MONTHS.index(m.group('mon').lower()) + 1\n         day = int(m.group('day'))\n         hour = int(m.group('hour'))",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11905",
    "model_patch": "diff --git a/django/db/models/lookups.py b/django/db/models/lookups.py\nindex 9344979c56..424c2a98b4 100644\n--- a/django/db/models/lookups.py\n+++ b/django/db/models/lookups.py\n@@ -462,6 +462,14 @@ class IsNull(BuiltinLookup):\n     lookup_name = 'isnull'\n     prepare_rhs = False\n \n+    def __init__(self, lhs, rhs):\n+        if not hasattr(rhs, 'resolve_expression') and rhs is not None and not isinstance(rhs, bool):\n+            raise ValueError(\n+                \"The __isnull lookup only accepts boolean values (True or False). \"\n+                \"Got %r instead.\" % rhs\n+            )\n+        super().__init__(lhs, rhs)\n+\n     def as_sql(self, compiler, connection):\n         sql, params = compiler.compile(self.lhs)\n         if self.rhs:",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11910",
    "model_patch": "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex 1c40161c7f..d9ced5315e 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -915,41 +915,43 @@ class MigrationAutodetector:\n             dependencies = []\n             # Implement any model renames on relations; these are handled by RenameModel\n             # so we need to exclude them from the comparison\n-            if hasattr(new_field, \"remote_field\") and getattr(new_field.remote_field, \"model\", None):\n+            # Clone the field to avoid mutating the original which is needed for the AlterField operation\n+            new_field_clone = new_field.clone() if hasattr(new_field, \"remote_field\") else new_field\n+            if hasattr(new_field_clone, \"remote_field\") and getattr(new_field_clone.remote_field, \"model\", None):\n                 rename_key = (\n-                    new_field.remote_field.model._meta.app_label,\n-                    new_field.remote_field.model._meta.model_name,\n+                    new_field_clone.remote_field.model._meta.app_label,\n+                    new_field_clone.remote_field.model._meta.model_name,\n                 )\n                 if rename_key in self.renamed_models:\n-                    new_field.remote_field.model = old_field.remote_field.model\n+                    new_field_clone.remote_field.model = old_field.remote_field.model\n                 # Handle ForeignKey which can only have a single to_field.\n-                remote_field_name = getattr(new_field.remote_field, 'field_name', None)\n+                remote_field_name = getattr(new_field_clone.remote_field, 'field_name', None)\n                 if remote_field_name:\n                     to_field_rename_key = rename_key + (remote_field_name,)\n                     if to_field_rename_key in self.renamed_fields:\n-                        new_field.remote_field.field_name = old_field.remote_field.field_name\n+                        new_field_clone.remote_field.field_name = old_field.remote_field.field_name\n                 # Handle ForeignObjects which can have multiple from_fields/to_fields.\n-                from_fields = getattr(new_field, 'from_fields', None)\n+                from_fields = getattr(new_field_clone, 'from_fields', None)\n                 if from_fields:\n                     from_rename_key = (app_label, model_name)\n-                    new_field.from_fields = tuple([\n+                    new_field_clone.from_fields = tuple([\n                         self.renamed_fields.get(from_rename_key + (from_field,), from_field)\n                         for from_field in from_fields\n                     ])\n-                    new_field.to_fields = tuple([\n+                    new_field_clone.to_fields = tuple([\n                         self.renamed_fields.get(rename_key + (to_field,), to_field)\n-                        for to_field in new_field.to_fields\n+                        for to_field in new_field_clone.to_fields\n                     ])\n                 dependencies.extend(self._get_dependencies_for_foreign_key(new_field))\n-            if hasattr(new_field, \"remote_field\") and getattr(new_field.remote_field, \"through\", None):\n+            if hasattr(new_field_clone, \"remote_field\") and getattr(new_field_clone.remote_field, \"through\", None):\n                 rename_key = (\n-                    new_field.remote_field.through._meta.app_label,\n-                    new_field.remote_field.through._meta.model_name,\n+                    new_field_clone.remote_field.through._meta.app_label,\n+                    new_field_clone.remote_field.through._meta.model_name,\n                 )\n                 if rename_key in self.renamed_models:\n-                    new_field.remote_field.through = old_field.remote_field.through\n+                    new_field_clone.remote_field.through = old_field.remote_field.through\n             old_field_dec = self.deep_deconstruct(old_field)\n-            new_field_dec = self.deep_deconstruct(new_field)\n+            new_field_dec = self.deep_deconstruct(new_field_clone)\n             if old_field_dec != new_field_dec:\n                 both_m2m = old_field.many_to_many and new_field.many_to_many\n                 neither_m2m = not old_field.many_to_many and not new_field.many_to_many\ndiff --git a/tests/migrations/test_autodetector.py b/tests/migrations/test_autodetector.py\nindex 1d5b8ef463..f642923570 100644\n--- a/tests/migrations/test_autodetector.py\n+++ b/tests/migrations/test_autodetector.py\n@@ -863,6 +863,38 @@ class AutodetectorTests(TestCase):\n         self.assertOperationTypes(changes, 'app', 0, ['RenameField'])\n         self.assertOperationAttributes(changes, 'app', 0, 0, old_name='field', new_name='renamed_field')\n \n+    def test_rename_primary_key_with_foreign_key(self):\n+        \"\"\"\n+        Test that when a primary key field is renamed, ForeignKeys that\n+        reference it (without explicit to_field) have their to_field updated.\n+        \"\"\"\n+        before = [\n+            ModelState('app', 'ModelA', [\n+                ('field_wrong', models.CharField(max_length=50, primary_key=True)),\n+            ]),\n+            ModelState('app', 'ModelB', [\n+                ('id', models.AutoField(primary_key=True)),\n+                ('field_fk', models.ForeignKey('app.ModelA', models.CASCADE)),\n+            ]),\n+        ]\n+        after = [\n+            ModelState('app', 'ModelA', [\n+                ('field_fixed', models.CharField(max_length=50, primary_key=True)),\n+            ]),\n+            ModelState('app', 'ModelB', [\n+                ('id', models.AutoField(primary_key=True)),\n+                ('field_fk', models.ForeignKey('app.ModelA', models.CASCADE)),\n+            ]),\n+        ]\n+        changes = self.get_changes(before, after, MigrationQuestioner({'ask_rename': True}))\n+        # Right number/type of migrations?\n+        self.assertNumberMigrations(changes, 'app', 1)\n+        self.assertOperationTypes(changes, 'app', 0, ['RenameField', 'AlterField'])\n+        self.assertOperationAttributes(changes, 'app', 0, 0, old_name='field_wrong', new_name='field_fixed')\n+        # Verify the AlterField operation has the correct to_field\n+        alter_field_op = changes['app'][0].operations[1]\n+        self.assertEqual(alter_field_op.field.remote_field.field_name, 'field_fixed')\n+\n     def test_rename_foreign_object_fields(self):\n         fields = ('first', 'second')\n         renamed_fields = ('first_renamed', 'second_renamed')",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11964",
    "model_patch": "diff --git a/django/db/models/fields/__init__.py b/django/db/models/fields/__init__.py\nindex d610dc86f0..ac8f308f76 100644\n--- a/django/db/models/fields/__init__.py\n+++ b/django/db/models/fields/__init__.py\n@@ -2,6 +2,7 @@ import collections.abc\n import copy\n import datetime\n import decimal\n+import enum\n import operator\n import uuid\n import warnings\n@@ -1009,6 +1010,8 @@ class CharField(Field):\n \n     def to_python(self, value):\n         if isinstance(value, str) or value is None:\n+            if isinstance(value, enum.Enum):\n+                value = value.value\n             return value\n         return str(value)\n \n@@ -1769,6 +1772,8 @@ class IntegerField(Field):\n     def to_python(self, value):\n         if value is None:\n             return value\n+        if isinstance(value, enum.Enum):\n+            value = value.value\n         try:\n             return int(value)\n         except (TypeError, ValueError):\n@@ -2024,6 +2029,8 @@ class TextField(Field):\n \n     def to_python(self, value):\n         if isinstance(value, str) or value is None:\n+            if isinstance(value, enum.Enum):\n+                value = value.value\n             return value\n         return str(value)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11999",
    "model_patch": "diff --git a/django/db/models/fields/__init__.py b/django/db/models/fields/__init__.py\nindex ee45bb941e..64b4a8c35e 100644\n--- a/django/db/models/fields/__init__.py\n+++ b/django/db/models/fields/__init__.py\n@@ -763,8 +763,10 @@ class Field(RegisterLookupMixin):\n             if not getattr(cls, self.attname, None):\n                 setattr(cls, self.attname, self.descriptor_class(self))\n         if self.choices is not None:\n-            setattr(cls, 'get_%s_display' % self.name,\n-                    partialmethod(cls._get_FIELD_display, field=self))\n+            display_method = 'get_%s_display' % self.name\n+            # Only set the display method if it's not already defined.\n+            if not getattr(cls, display_method, None):\n+                setattr(cls, display_method, partialmethod(cls._get_FIELD_display, field=self))\n \n     def get_filter_kwargs_for_object(self, obj):\n         \"\"\"\ndiff --git a/tests/model_fields/models.py b/tests/model_fields/models.py\nindex 98b32d0c1e..087840e4dd 100644\n--- a/tests/model_fields/models.py\n+++ b/tests/model_fields/models.py\n@@ -68,6 +68,20 @@ class WhizIterEmpty(models.Model):\n     c = models.CharField(choices=iter(()), blank=True, max_length=1)\n \n \n+class WhizWithCustomDisplay(models.Model):\n+    \"\"\"\n+    A model that overrides the auto-generated get_c_display method.\n+    \"\"\"\n+    CHOICES = (\n+        (1, 'First'),\n+        (2, 'Second'),\n+    )\n+    c = models.IntegerField(choices=CHOICES, null=True)\n+\n+    def get_c_display(self):\n+        return \"Custom Display\"\n+\n+\n class Choiceful(models.Model):\n     no_choices = models.IntegerField(null=True)\n     empty_choices = models.IntegerField(choices=(), null=True)\ndiff --git a/tests/model_fields/tests.py b/tests/model_fields/tests.py\nindex 0d6e930b06..07d61d79b8 100644\n--- a/tests/model_fields/tests.py\n+++ b/tests/model_fields/tests.py\n@@ -8,7 +8,7 @@ from django.utils.functional import lazy\n \n from .models import (\n     Bar, Choiceful, Foo, RenamedField, VerboseNameField, Whiz, WhizDelayed,\n-    WhizIter, WhizIterEmpty,\n+    WhizIter, WhizIterEmpty, WhizWithCustomDisplay,\n )\n \n \n@@ -186,6 +186,14 @@ class GetFieldDisplayTests(SimpleTestCase):\n         self.assertIsNone(WhizIterEmpty(c=None).c)         # Blank value\n         self.assertEqual(WhizIterEmpty(c='').c, '')        # Empty value\n \n+    def test_can_override_get_FIELD_display(self):\n+        \"\"\"\n+        get_FIELD_display() can be overridden.\n+        \"\"\"\n+        obj = WhizWithCustomDisplay(c=1)\n+        # The overridden method should return our custom value, not 'First'\n+        self.assertEqual(obj.get_c_display(), 'Custom Display')\n+\n \n class GetChoicesTests(SimpleTestCase):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12113",
    "model_patch": "diff --git a/django/db/backends/sqlite3/base.py b/django/db/backends/sqlite3/base.py\nindex a3ae1f048e..6559b4e204 100644\n--- a/django/db/backends/sqlite3/base.py\n+++ b/django/db/backends/sqlite3/base.py\n@@ -202,6 +202,7 @@ class DatabaseWrapper(BaseDatabaseWrapper):\n     @async_unsafe\n     def get_new_connection(self, conn_params):\n         conn = Database.connect(**conn_params)\n+        conn.timeout = 30.0\n         conn.create_function(\"django_date_extract\", 2, _sqlite_datetime_extract)\n         conn.create_function(\"django_date_trunc\", 2, _sqlite_date_trunc)\n         conn.create_function('django_datetime_cast_date', 3, _sqlite_datetime_cast_date)\ndiff --git a/tests/test_sqlite.py b/tests/test_sqlite.py\nindex f1b65f7d01..9ce4e32e14 100644\n--- a/tests/test_sqlite.py\n+++ b/tests/test_sqlite.py\n@@ -15,9 +15,15 @@\n DATABASES = {\n     'default': {\n         'ENGINE': 'django.db.backends.sqlite3',\n+        'TEST': {\n+            'NAME': 'test_default.sqlite3'\n+        },\n     },\n     'other': {\n         'ENGINE': 'django.db.backends.sqlite3',\n+        'TEST': {\n+            'NAME': 'test_other.sqlite3'\n+        },\n     }\n }",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12125",
    "model_patch": "diff --git a/django/db/migrations/serializer.py b/django/db/migrations/serializer.py\nindex 7d226955d5..ead81c398a 100644\n--- a/django/db/migrations/serializer.py\n+++ b/django/db/migrations/serializer.py\n@@ -269,7 +269,7 @@ class TypeSerializer(BaseSerializer):\n             if module == builtins.__name__:\n                 return self.value.__name__, set()\n             else:\n-                return \"%s.%s\" % (module, self.value.__name__), {\"import %s\" % module}\n+                return \"%s.%s\" % (module, self.value.__qualname__), {\"import %s\" % module}\n \n \n class UUIDSerializer(BaseSerializer):\ndiff --git a/tests/migrations/test_writer.py b/tests/migrations/test_writer.py\nindex ca924f35ec..ad8c79f702 100644\n--- a/tests/migrations/test_writer.py\n+++ b/tests/migrations/test_writer.py\n@@ -744,6 +744,20 @@ class WriterTests(SimpleTestCase):\n         with self.assertRaisesMessage(ValueError, 'Cannot serialize: (1+2j)'):\n             self.assertSerializedEqual(complex(1, 2))\n \n+    def test_serialize_inner_class(self):\n+        \"\"\"\n+        Test that inner classes are correctly serialized with their full path.\n+        \"\"\"\n+        class Outer:\n+            class Inner:\n+                pass\n+\n+        # Inner classes should be serialized with their outer class path\n+        self.assertSerializedResultEqual(\n+            Outer.Inner,\n+            (\"migrations.test_writer.Outer.Inner\", {\"import migrations.test_writer\"})\n+        )\n+\n     def test_register_non_serializer(self):\n         with self.assertRaisesMessage(ValueError, \"'TestModel1' must inherit from 'BaseSerializer'.\"):\n             MigrationWriter.register_serializer(complex, TestModel1)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12184",
    "model_patch": "diff --git a/django/urls/resolvers.py b/django/urls/resolvers.py\nindex 2d4610aac4..7a67661ce4 100644\n--- a/django/urls/resolvers.py\n+++ b/django/urls/resolvers.py\n@@ -159,7 +159,7 @@ class RegexPattern(CheckURLMixin):\n             # non-named groups. Otherwise, pass all non-named arguments as\n             # positional arguments.\n             kwargs = {k: v for k, v in match.groupdict().items() if v is not None}\n-            args = () if kwargs else match.groups()\n+            args = () if kwargs else tuple(g for g in match.groups() if g is not None)\n             return path[match.end():], args, kwargs\n         return None",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12284",
    "model_patch": "diff --git a/django/db/models/fields/__init__.py b/django/db/models/fields/__init__.py\nindex 1a55d3d417..cccb56d08c 100644\n--- a/django/db/models/fields/__init__.py\n+++ b/django/db/models/fields/__init__.py\n@@ -764,12 +764,11 @@ class Field(RegisterLookupMixin):\n             if not getattr(cls, self.attname, None):\n                 setattr(cls, self.attname, self.descriptor_class(self))\n         if self.choices is not None:\n-            if not hasattr(cls, 'get_%s_display' % self.name):\n-                setattr(\n-                    cls,\n-                    'get_%s_display' % self.name,\n-                    partialmethod(cls._get_FIELD_display, field=self),\n-                )\n+            setattr(\n+                cls,\n+                'get_%s_display' % self.name,\n+                partialmethod(cls._get_FIELD_display, field=self),\n+            )\n \n     def get_filter_kwargs_for_object(self, obj):\n         \"\"\"",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12286",
    "model_patch": "diff --git a/django/core/checks/translation.py b/django/core/checks/translation.py\nindex 138ed07ff8..a2743fc49b 100644\n--- a/django/core/checks/translation.py\n+++ b/django/core/checks/translation.py\n@@ -56,6 +56,11 @@ def check_setting_languages_bidi(app_configs, **kwargs):\n def check_language_settings_consistent(app_configs, **kwargs):\n     \"\"\"Error if language settings are not consistent with each other.\"\"\"\n     available_tags = {i for i, _ in settings.LANGUAGES} | {'en-us'}\n-    if settings.LANGUAGE_CODE not in available_tags:\n-        return [E004]\n-    return []\n+    # Check if LANGUAGE_CODE is directly available\n+    if settings.LANGUAGE_CODE in available_tags:\n+        return []\n+    # Check if the base language is available for sublanguages\n+    base_language = settings.LANGUAGE_CODE.split('-')[0].lower()\n+    if base_language in available_tags:\n+        return []\n+    return [E004]\ndiff --git a/tests/check_framework/test_translation.py b/tests/check_framework/test_translation.py\nindex 4cd79d803f..33cf8f85c7 100644\n--- a/tests/check_framework/test_translation.py\n+++ b/tests/check_framework/test_translation.py\n@@ -84,3 +84,21 @@ class TranslationCheckTests(SimpleTestCase):\n             self.assertEqual(check_language_settings_consistent(None), [\n                 Error(msg, id='translation.E004'),\n             ])\n+\n+    def test_sublanguage_with_base_language_available(self):\n+        \"\"\"Sublanguage should be accepted when base language is available.\"\"\"\n+        # Test de-at with base language de available\n+        with self.settings(LANGUAGE_CODE='de-at', LANGUAGES=[('de', 'German')]):\n+            self.assertEqual(check_language_settings_consistent(None), [])\n+\n+    def test_sublanguage_without_base_language_available(self):\n+        \"\"\"Sublanguage should raise error when base language is not available.\"\"\"\n+        msg = (\n+            'You have provided a value for the LANGUAGE_CODE setting that is '\n+            'not in the LANGUAGES setting.'\n+        )\n+        # Test de-at without base language de available\n+        with self.settings(LANGUAGE_CODE='de-at', LANGUAGES=[('en', 'English')]):\n+            self.assertEqual(check_language_settings_consistent(None), [\n+                Error(msg, id='translation.E004'),\n+            ])",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12308",
    "model_patch": "diff --git a/django/contrib/admin/utils.py b/django/contrib/admin/utils.py\nindex e4ddc8f017..7a85b11bba 100644\n--- a/django/contrib/admin/utils.py\n+++ b/django/contrib/admin/utils.py\n@@ -1,5 +1,6 @@\n import datetime\n import decimal\n+import json\n from collections import defaultdict\n \n from django.core.exceptions import FieldDoesNotExist\n@@ -390,7 +391,9 @@ def display_for_field(value, field, empty_value_display):\n         return empty_value_display\n     elif isinstance(field, models.DateTimeField):\n         return formats.localize(timezone.template_localtime(value))\n-    elif isinstance(field, (models.DateField, models.TimeField)):\n+    elif isinstance(field, models.DateField):\n+        return formats.localize(value)\n+    elif isinstance(field, models.TimeField):\n         return formats.localize(value)\n     elif isinstance(field, models.DecimalField):\n         return formats.number_format(value, field.decimal_places)\n@@ -398,6 +401,11 @@ def display_for_field(value, field, empty_value_display):\n         return formats.number_format(value)\n     elif isinstance(field, models.FileField) and value:\n         return format_html('<a href=\"{}\">{}</a>', value.url, value)\n+    elif isinstance(field, models.JSONField):\n+        try:\n+            return json.dumps(value, cls=field.encoder)\n+        except TypeError:\n+            return str(value)\n     else:\n         return display_for_value(value, empty_value_display)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12453",
    "model_patch": "diff --git a/django/db/backends/base/creation.py b/django/db/backends/base/creation.py\nindex c50fc90171..5cf1f5b3c2 100644\n--- a/django/db/backends/base/creation.py\n+++ b/django/db/backends/base/creation.py\n@@ -5,7 +5,7 @@ from io import StringIO\n from django.apps import apps\n from django.conf import settings\n from django.core import serializers\n-from django.db import router\n+from django.db import router, transaction\n \n # The prefix to put on the default database name when creating\n # the test database.\n@@ -126,8 +126,9 @@ class BaseDatabaseCreation:\n         the serialize_db_to_string() method.\n         \"\"\"\n         data = StringIO(data)\n-        for obj in serializers.deserialize(\"json\", data, using=self.connection.alias):\n-            obj.save()\n+        with transaction.atomic(using=self.connection.alias):\n+            for obj in serializers.deserialize(\"json\", data, using=self.connection.alias):\n+                obj.save()\n \n     def _get_database_display_str(self, verbosity, database_name):\n         \"\"\"",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12470",
    "model_patch": "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 92213a4e67..8c941f8f18 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -727,7 +727,7 @@ class SQLCompiler:\n                     results.append((item, False))\n                     continue\n                 results.extend(self.find_ordering_name(item, opts, alias,\n-                                                       order, already_seen))\n+                                                       default_order, already_seen))\n             return results\n         targets, alias, _ = self.query.trim_joins(targets, joins, path)\n         return [(OrderBy(transform_function(t, alias), descending=descending), False) for t in targets]",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12497",
    "model_patch": "diff --git a/django/db/models/fields/related.py b/django/db/models/fields/related.py\nindex 8ddbb5ba68..536b3dd601 100644\n--- a/django/db/models/fields/related.py\n+++ b/django/db/models/fields/related.py\n@@ -1309,7 +1309,7 @@ class ManyToManyField(RelatedField):\n                              \"through_fields keyword argument.\") % (self, from_model_name),\n                             hint=(\n                                 'If you want to create a recursive relationship, '\n-                                'use ForeignKey(\"%s\", symmetrical=False, through=\"%s\").'\n+                                'use ManyToManyField(\"%s\", through=\"%s\").'\n                             ) % (\n                                 RECURSIVE_RELATIONSHIP_CONSTANT,\n                                 relationship_model_name,\n@@ -1329,7 +1329,7 @@ class ManyToManyField(RelatedField):\n                             \"through_fields keyword argument.\" % (self, to_model_name),\n                             hint=(\n                                 'If you want to create a recursive relationship, '\n-                                'use ForeignKey(\"%s\", symmetrical=False, through=\"%s\").'\n+                                'use ManyToManyField(\"%s\", through=\"%s\").'\n                             ) % (\n                                 RECURSIVE_RELATIONSHIP_CONSTANT,\n                                 relationship_model_name,\ndiff --git a/tests/invalid_models_tests/test_relative_fields.py b/tests/invalid_models_tests/test_relative_fields.py\nindex 24f27168c2..6ff5a2fa41 100644\n--- a/tests/invalid_models_tests/test_relative_fields.py\n+++ b/tests/invalid_models_tests/test_relative_fields.py\n@@ -152,7 +152,7 @@ class RelativeFieldTests(SimpleTestCase):\n                 \"keyword argument.\",\n                 hint=(\n                     'If you want to create a recursive relationship, use '\n-                    'ForeignKey(\"self\", symmetrical=False, through=\"AmbiguousRelationship\").'\n+                    'ManyToManyField(\"self\", through=\"AmbiguousRelationship\").'\n                 ),\n                 obj=field,\n                 id='fields.E335',",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12700",
    "model_patch": "diff --git a/django/views/debug.py b/django/views/debug.py\nindex e6b7d4d821..856ca36972 100644\n--- a/django/views/debug.py\n+++ b/django/views/debug.py\n@@ -84,12 +84,17 @@ class SafeExceptionReporterFilter:\n         \"\"\"\n         Cleanse an individual setting key/value of sensitive content. If the\n         value is a dictionary, recursively cleanse the keys in that dictionary.\n+        If the value is an iterable (list, tuple, set), recursively cleanse\n+        all elements in that iterable.\n         \"\"\"\n         try:\n             if self.hidden_settings.search(key):\n                 cleansed = self.cleansed_substitute\n             elif isinstance(value, dict):\n                 cleansed = {k: self.cleanse_setting(k, v) for k, v in value.items()}\n+            elif isinstance(value, (list, tuple, set)):\n+                # Recursively cleanse all items in the iterable\n+                cleansed = type(value)(self.cleanse_setting(key, v) for v in value)\n             else:\n                 cleansed = value\n         except TypeError:",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12708",
    "model_patch": "diff --git a/django/db/backends/base/schema.py b/django/db/backends/base/schema.py\nindex 61f88401ab..1f521cfc5c 100644\n--- a/django/db/backends/base/schema.py\n+++ b/django/db/backends/base/schema.py\n@@ -393,7 +393,7 @@ class BaseDatabaseSchemaEditor:\n         news = {tuple(fields) for fields in new_index_together}\n         # Deleted indexes\n         for fields in olds.difference(news):\n-            self._delete_composed_index(model, fields, {'index': True}, self.sql_delete_index)\n+            self._delete_composed_index(model, fields, {'index': True, 'unique': False}, self.sql_delete_index)\n         # Created indexes\n         for field_names in news.difference(olds):\n             fields = [model._meta.get_field(field) for field in field_names]\ndiff --git a/tests/schema/models.py b/tests/schema/models.py\nindex 6d4465807a..088be2b4eb 100644\n--- a/tests/schema/models.py\n+++ b/tests/schema/models.py\n@@ -80,6 +80,20 @@ class AuthorWithUniqueNameAndBirthday(models.Model):\n         unique_together = [['name', 'birthday']]\n \n \n+class AuthorWithUniqueAndIndexedNameAndBirthday(models.Model):\n+    \"\"\"\n+    Model with both unique_together and index_together on the same fields.\n+    Used for testing that deleting index_together doesn't fail when unique_together exists.\n+    \"\"\"\n+    name = models.CharField(max_length=255)\n+    birthday = models.DateField()\n+\n+    class Meta:\n+        apps = new_apps\n+        unique_together = [['name', 'birthday']]\n+        index_together = [['name', 'birthday']]\n+\n+\n class Book(models.Model):\n     author = models.ForeignKey(Author, models.CASCADE)\n     title = models.CharField(max_length=100, db_index=True)\ndiff --git a/tests/schema/tests.py b/tests/schema/tests.py\nindex 9aa1e239ac..5659c35c71 100644\n--- a/tests/schema/tests.py\n+++ b/tests/schema/tests.py\n@@ -29,7 +29,8 @@ from .models import (\n     Author, AuthorCharFieldWithIndex, AuthorTextFieldWithIndex,\n     AuthorWithDefaultHeight, AuthorWithEvenLongerName, AuthorWithIndexedName,\n     AuthorWithIndexedNameAndBirthday, AuthorWithUniqueName,\n-    AuthorWithUniqueNameAndBirthday, Book, BookForeignObj, BookWeak,\n+    AuthorWithUniqueNameAndBirthday, AuthorWithUniqueAndIndexedNameAndBirthday,\n+    Book, BookForeignObj, BookWeak,\n     BookWithLongName, BookWithO2O, BookWithoutAuthor, BookWithSlug, IntegerPK,\n     Node, Note, NoteRename, Tag, TagIndexed, TagM2MTest, TagUniqueRename,\n     Thing, UniqueTest, new_apps,\n@@ -52,6 +53,7 @@ class SchemaTests(TransactionTestCase):\n         AuthorWithDefaultHeight, AuthorWithEvenLongerName, Book, BookWeak,\n         BookWithLongName, BookWithO2O, BookWithSlug, IntegerPK, Node, Note,\n         Tag, TagIndexed, TagM2MTest, TagUniqueRename, Thing, UniqueTest,\n+        AuthorWithUniqueAndIndexedNameAndBirthday,\n     ]\n \n     # Utility functions\n@@ -2245,6 +2247,51 @@ class SchemaTests(TransactionTestCase):\n             AuthorWithIndexedNameAndBirthday._meta.indexes = []\n             editor.remove_index(AuthorWithIndexedNameAndBirthday, index)\n \n+    @skipUnlessDBFeature('allows_multiple_constraints_on_same_fields')\n+    def test_delete_index_together_with_unique_together(self):\n+        \"\"\"\n+        Tests that deleting index_together when unique_together exists on the\n+        same fields doesn't fail. This is a regression test for #12708.\n+        \"\"\"\n+        # Create the table with both unique_together and index_together\n+        with connection.schema_editor() as editor:\n+            editor.create_model(AuthorWithUniqueAndIndexedNameAndBirthday)\n+\n+        # Ensure both constraints exist\n+        constraints = self.get_constraints(AuthorWithUniqueAndIndexedNameAndBirthday._meta.db_table)\n+        unique_constraints = [\n+            name for name, details in constraints.items()\n+            if details['columns'] == ['name', 'birthday'] and details['unique']\n+        ]\n+        index_constraints = [\n+            name for name, details in constraints.items()\n+            if details['columns'] == ['name', 'birthday'] and details['index'] and not details['unique']\n+        ]\n+        self.assertEqual(len(unique_constraints), 1, \"Should have 1 unique constraint\")\n+        self.assertEqual(len(index_constraints), 1, \"Should have 1 index constraint\")\n+\n+        # Delete the index_together (this should not fail)\n+        index_together = AuthorWithUniqueAndIndexedNameAndBirthday._meta.index_together\n+        with connection.schema_editor() as editor:\n+            editor.alter_index_together(\n+                AuthorWithUniqueAndIndexedNameAndBirthday,\n+                index_together,\n+                []\n+            )\n+\n+        # Ensure the unique constraint still exists but the index is gone\n+        constraints = self.get_constraints(AuthorWithUniqueAndIndexedNameAndBirthday._meta.db_table)\n+        unique_constraints = [\n+            name for name, details in constraints.items()\n+            if details['columns'] == ['name', 'birthday'] and details['unique']\n+        ]\n+        index_constraints = [\n+            name for name, details in constraints.items()\n+            if details['columns'] == ['name', 'birthday'] and details['index'] and not details['unique']\n+        ]\n+        self.assertEqual(len(unique_constraints), 1, \"Unique constraint should still exist\")\n+        self.assertEqual(len(index_constraints), 0, \"Index constraint should be removed\")\n+\n     @isolate_apps('schema')\n     def test_db_table(self):\n         \"\"\"",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12747",
    "model_patch": "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex d9c9b0db04..814ff79fef 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -735,6 +735,11 @@ class QuerySet:\n         collector.collect(del_query)\n         deleted, _rows_count = collector.delete()\n \n+        # Ensure that the model being deleted is always present in the result,\n+        # even when no objects were deleted.\n+        if self.model._meta.label not in _rows_count:\n+            _rows_count[self.model._meta.label] = 0\n+\n         # Clear the result cache, in case this QuerySet gets reused.\n         self._result_cache = None\n         return deleted, _rows_count",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12856",
    "model_patch": "diff --git a/django/db/models/base.py b/django/db/models/base.py\nindex 7bb3fa4706..aa8c787f35 100644\n--- a/django/db/models/base.py\n+++ b/django/db/models/base.py\n@@ -1866,6 +1866,10 @@ class Model(metaclass=ModelBase):\n     @classmethod\n     def _check_constraints(cls, databases):\n         errors = []\n+        # Check that fields mentioned in UniqueConstraints exist.\n+        for constraint in cls._meta.constraints:\n+            if isinstance(constraint, UniqueConstraint):\n+                errors.extend(cls._check_local_fields(constraint.fields, 'constraints'))\n         for db in databases:\n             if not router.allow_migrate_model(db, cls):\n                 continue",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12908",
    "model_patch": "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex e0eeccefa6..5c70229263 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -1138,6 +1138,7 @@ class QuerySet:\n         \"\"\"\n         Return a new QuerySet instance that will select only distinct results.\n         \"\"\"\n+        self._not_support_combined_queries('distinct')\n         assert not self.query.is_sliced, \\\n             \"Cannot create distinct fields once a slice has been taken.\"\n         obj = self._chain()\ndiff --git a/tests/queries/test_qs_combinators.py b/tests/queries/test_qs_combinators.py\nindex 1d159e1fed..d2e7d2b80d 100644\n--- a/tests/queries/test_qs_combinators.py\n+++ b/tests/queries/test_qs_combinators.py\n@@ -272,6 +272,7 @@ class QuerySetSetOperationTests(TestCase):\n                 'annotate',\n                 'defer',\n                 'delete',\n+                'distinct',\n                 'exclude',\n                 'extra',\n                 'filter',",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12915",
    "model_patch": "diff --git a/django/contrib/staticfiles/handlers.py b/django/contrib/staticfiles/handlers.py\nindex 711d8864ad..9db4d33b33 100644\n--- a/django/contrib/staticfiles/handlers.py\n+++ b/django/contrib/staticfiles/handlers.py\n@@ -52,6 +52,12 @@ class StaticFilesHandlerMixin:\n         except Http404 as e:\n             return response_for_exception(request, e)\n \n+    async def get_response_async(self, request):\n+        try:\n+            return self.serve(request)\n+        except Http404 as e:\n+            return response_for_exception(request, e)\n+\n \n class StaticFilesHandler(StaticFilesHandlerMixin, WSGIHandler):\n     \"\"\"",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12983",
    "model_patch": "diff --git a/django/utils/text.py b/django/utils/text.py\nindex fb5f6298c4..3ba4bbb3f4 100644\n--- a/django/utils/text.py\n+++ b/django/utils/text.py\n@@ -403,7 +403,7 @@ def slugify(value, allow_unicode=False):\n     else:\n         value = unicodedata.normalize('NFKD', value).encode('ascii', 'ignore').decode('ascii')\n     value = re.sub(r'[^\\w\\s-]', '', value.lower()).strip()\n-    return re.sub(r'[-\\s]+', '-', value)\n+    return re.sub(r'[-\\s]+', '-', value).strip('-_')\n \n \n def camel_case_to_spaces(value):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13028",
    "model_patch": "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex ce18098fd2..d7091aa8b4 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -1124,6 +1124,8 @@ class Query(BaseExpression):\n \n     def check_filterable(self, expression):\n         \"\"\"Raise an error if expression cannot be used in a WHERE clause.\"\"\"\n+        if hasattr(expression, '_meta'):\n+            return\n         if not getattr(expression, 'filterable', True):\n             raise NotSupportedError(\n                 expression.__class__.__name__ + ' is disallowed in the filter '",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13033",
    "model_patch": "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex abbb1e37cb..a8f5b61fbe 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -727,7 +727,7 @@ class SQLCompiler:\n         # If we get to this point and the field is a relation to another model,\n         # append the default ordering for that model unless it is the pk\n         # shortcut or the attribute name of the field that is specified.\n-        if field.is_relation and opts.ordering and getattr(field, 'attname', None) != name and name != 'pk':\n+        if field.is_relation and opts.ordering and getattr(field, 'attname', None) != pieces[-1] and name != 'pk':\n             # Firstly, avoid infinite loops.\n             already_seen = already_seen or set()\n             join_tuple = tuple(getattr(self.query.alias_map[j], 'join_cols', None) for j in joins)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13158",
    "model_patch": "diff --git a/django/db/models/query.py b/django/db/models/query.py\nindex 07d6ffd4ca..8f7a81d9e3 100644\n--- a/django/db/models/query.py\n+++ b/django/db/models/query.py\n@@ -920,6 +920,13 @@ class QuerySet:\n         \"\"\"Return an empty QuerySet.\"\"\"\n         clone = self._chain()\n         clone.query.set_empty()\n+        # Also set empty on all combined queries if this is a combined queryset\n+        if clone.query.combinator:\n+            clone.query.combined_queries = tuple(\n+                q.clone() for q in clone.query.combined_queries\n+            )\n+            for combined_query in clone.query.combined_queries:\n+                combined_query.set_empty()\n         return clone\n \n     ##################################################################",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13220",
    "model_patch": "diff --git a/django/core/exceptions.py b/django/core/exceptions.py\nindex dc084b8692..019f059f35 100644\n--- a/django/core/exceptions.py\n+++ b/django/core/exceptions.py\n@@ -182,6 +182,75 @@ class ValidationError(Exception):\n     def __repr__(self):\n         return 'ValidationError(%s)' % self\n \n+    def __eq__(self, other):\n+        if not isinstance(other, ValidationError):\n+            return NotImplemented\n+        return self._compare_errors(other)\n+\n+    def _compare_errors(self, other):\n+        \"\"\"Compare two ValidationErrors, handling dict and list structures.\"\"\"\n+        self_has_dict = hasattr(self, 'error_dict')\n+        other_has_dict = hasattr(other, 'error_dict')\n+\n+        # Both have error_dict\n+        if self_has_dict and other_has_dict:\n+            return self._compare_error_dict(other)\n+        # Neither has error_dict\n+        elif not self_has_dict and not other_has_dict:\n+            return self._compare_error_list(other)\n+        # One has error_dict, one doesn't\n+        else:\n+            return False\n+\n+    def _compare_error_dict(self, other):\n+        \"\"\"Compare error_dict in an order-independent way.\"\"\"\n+        if set(self.error_dict.keys()) != set(other.error_dict.keys()):\n+            return False\n+        for field in self.error_dict:\n+            self_errors = self.error_dict[field]\n+            other_errors = other.error_dict[field]\n+            # Compare as lists of ValidationError objects\n+            if len(self_errors) != len(other_errors):\n+                return False\n+            # Sort both lists by their comparison key for order-independent comparison\n+            self_sorted = sorted(self_errors, key=_error_key)\n+            other_sorted = sorted(other_errors, key=_error_key)\n+            for self_error, other_error in zip(self_sorted, other_sorted):\n+                if not self_error._compare_single_error(other_error):\n+                    return False\n+        return True\n+\n+    def _compare_error_list(self, other):\n+        \"\"\"Compare error_list in an order-independent way.\"\"\"\n+        if len(self.error_list) != len(other.error_list):\n+            return False\n+        # Sort both lists by their comparison key for order-independent comparison\n+        self_sorted = sorted(self.error_list, key=_error_key)\n+        other_sorted = sorted(other.error_list, key=_error_key)\n+        for self_error, other_error in zip(self_sorted, other_sorted):\n+            if not self_error._compare_single_error(other_error):\n+                return False\n+        return True\n+\n+    def _compare_single_error(self, other):\n+        \"\"\"Compare a single ValidationError (message, code, params).\"\"\"\n+        self_message = self.message\n+        other_message = other.message\n+        # Apply params if they exist to get the final message\n+        if self.params:\n+            self_message = self_message % self.params\n+        if other.params:\n+            other_message = other_message % other.params\n+        return str(self_message) == str(other_message)\n+\n+\n+def _error_key(error):\n+    \"\"\"Generate a comparison key for a ValidationError.\"\"\"\n+    message = error.message\n+    if error.params:\n+        message = message % error.params\n+    return (str(message), error.code or '', error.params or ())\n+\n \n class EmptyResultSet(Exception):\n     \"\"\"A database query predicate is impossible.\"\"\"\ndiff --git a/tests/test_exceptions/test_validation_error.py b/tests/test_exceptions/test_validation_error.py\nindex a0bbfaf77e..417f8d8e7d 100644\n--- a/tests/test_exceptions/test_validation_error.py\n+++ b/tests/test_exceptions/test_validation_error.py\n@@ -14,3 +14,62 @@ class TestValidationError(unittest.TestCase):\n         message_dict['field2'] = ['E3', 'E4']\n         exception = ValidationError(message_dict)\n         self.assertEqual(sorted(exception.messages), ['E1', 'E2', 'E3', 'E4'])\n+\n+    def test_eq_simple_validation_errors(self):\n+        # Simple ValidationErrors with same message are equal\n+        e1 = ValidationError('error1')\n+        e2 = ValidationError('error1')\n+        self.assertEqual(e1, e2)\n+\n+    def test_eq_simple_validation_errors_different_messages(self):\n+        # Simple ValidationErrors with different messages are not equal\n+        e1 = ValidationError('error1')\n+        e2 = ValidationError('error2')\n+        self.assertNotEqual(e1, e2)\n+\n+    def test_eq_list_validation_errors_same_order(self):\n+        # List ValidationErrors with same messages in same order are equal\n+        e1 = ValidationError(['error1', 'error2'])\n+        e2 = ValidationError(['error1', 'error2'])\n+        self.assertEqual(e1, e2)\n+\n+    def test_eq_list_validation_errors_different_order(self):\n+        # List ValidationErrors with same messages in different order are equal\n+        e1 = ValidationError(['error2', 'error1'])\n+        e2 = ValidationError(['error1', 'error2'])\n+        self.assertEqual(e1, e2)\n+\n+    def test_eq_dict_validation_errors_same_order(self):\n+        # Dict ValidationErrors with same fields and messages in same order are equal\n+        e1 = ValidationError({'field1': ['error1', 'error2']})\n+        e2 = ValidationError({'field1': ['error1', 'error2']})\n+        self.assertEqual(e1, e2)\n+\n+    def test_eq_dict_validation_errors_different_order(self):\n+        # Dict ValidationErrors with same fields and messages in different order are equal\n+        e1 = ValidationError({'field1': ['error2', 'error1']})\n+        e2 = ValidationError({'field1': ['error1', 'error2']})\n+        self.assertEqual(e1, e2)\n+\n+    def test_eq_dict_validation_errors_different_fields(self):\n+        # Dict ValidationErrors with same messages but different fields are not equal\n+        e1 = ValidationError({'field1': ['error1']})\n+        e2 = ValidationError({'field2': ['error1']})\n+        self.assertNotEqual(e1, e2)\n+\n+    def test_eq_different_types(self):\n+        # ValidationError is not equal to other types\n+        e1 = ValidationError('error')\n+        self.assertNotEqual(e1, 'error')\n+\n+    def test_eq_with_params(self):\n+        # ValidationErrors with same params are equal\n+        e1 = ValidationError('Error %(value)s', params={'value': 1})\n+        e2 = ValidationError('Error %(value)s', params={'value': 1})\n+        self.assertEqual(e1, e2)\n+\n+    def test_eq_with_different_params(self):\n+        # ValidationErrors with different params are not equal\n+        e1 = ValidationError('Error %(value)s', params={'value': 1})\n+        e2 = ValidationError('Error %(value)s', params={'value': 2})\n+        self.assertNotEqual(e1, e2)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13230",
    "model_patch": "diff --git a/django/contrib/syndication/views.py b/django/contrib/syndication/views.py\nindex 68ffb0bfe0..1be9d97b8a 100644\n--- a/django/contrib/syndication/views.py\n+++ b/django/contrib/syndication/views.py\n@@ -74,6 +74,9 @@ class Feed:\n             return [enc]\n         return []\n \n+    def item_comments(self, item):\n+        return None\n+\n     def _get_dynamic_attr(self, attname, obj, default=None):\n         try:\n             attr = getattr(self, attname)\n@@ -214,6 +217,7 @@ class Feed:\n                 author_link=author_link,\n                 categories=self._get_dynamic_attr('item_categories', item),\n                 item_copyright=self._get_dynamic_attr('item_copyright', item),\n+                comments=self._get_dynamic_attr('item_comments', item),\n                 **self.item_extra_kwargs(item)\n             )\n         return feed",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13265",
    "model_patch": "diff --git a/django/db/migrations/autodetector.py b/django/db/migrations/autodetector.py\nindex 89e2dceeaf..a9532d8263 100644\n--- a/django/db/migrations/autodetector.py\n+++ b/django/db/migrations/autodetector.py\n@@ -1015,12 +1015,27 @@ class MigrationAutodetector:\n     def generate_added_indexes(self):\n         for (app_label, model_name), alt_indexes in self.altered_indexes.items():\n             for index in alt_indexes['added_indexes']:\n+                # Determine if the index fields include the _order field\n+                # and if order_with_respect_to is being added.\n+                old_model_name = self.renamed_models.get((app_label, model_name), model_name)\n+                old_model_state = self.from_state.models[app_label, old_model_name]\n+                new_model_state = self.to_state.models[app_label, model_name]\n+                old_order_with_respect_to = old_model_state.options.get(\"order_with_respect_to\")\n+                new_order_with_respect_to = new_model_state.options.get(\"order_with_respect_to\")\n+                order_with_respect_to_added = (\n+                    new_order_with_respect_to and not old_order_with_respect_to\n+                )\n+                dependencies = []\n+                if order_with_respect_to_added and '_order' in index.fields:\n+                    # AddIndex operation must come after AlterOrderWithRespectTo.\n+                    dependencies.append((app_label, model_name, new_order_with_respect_to, True))\n                 self.add_operation(\n                     app_label,\n                     operations.AddIndex(\n                         model_name=model_name,\n                         index=index,\n-                    )\n+                    ),\n+                    dependencies=dependencies,\n                 )\n \n     def generate_removed_indexes(self):\ndiff --git a/tests/migrations/test_autodetector.py b/tests/migrations/test_autodetector.py\nindex 236af43834..4359194c8a 100644\n--- a/tests/migrations/test_autodetector.py\n+++ b/tests/migrations/test_autodetector.py\n@@ -2137,6 +2137,33 @@ class AutodetectorTests(TestCase):\n         self.assertOperationAttributes(changes, 'testapp', 0, 0, name=\"author\", order_with_respect_to=None)\n         self.assertOperationAttributes(changes, 'testapp', 0, 1, model_name=\"author\", name=\"book\")\n \n+    def test_add_alter_order_with_respect_to_with_index(self):\n+        \"\"\"\n+        Setting order_with_respect_to when adding an index on _order field\n+        generates operations in the correct order.\n+        \"\"\"\n+        # Author with order_with_respect_to and an index including _order\n+        author_with_order_and_index = ModelState(\"testapp\", \"Author\", [\n+            (\"id\", models.AutoField(primary_key=True)),\n+            (\"name\", models.CharField(max_length=200)),\n+            (\"book\", models.ForeignKey(\"otherapp.Book\", models.CASCADE)),\n+        ], options={\n+            \"order_with_respect_to\": \"book\",\n+            \"indexes\": [\n+                models.Index(fields=['book', '_order'], name='book_order_idx'),\n+            ],\n+        })\n+        changes = self.get_changes([self.book, self.author_with_book], [self.book, author_with_order_and_index])\n+        # Right number/type of migrations?\n+        self.assertNumberMigrations(changes, 'testapp', 1)\n+        # AlterOrderWithRespectTo should come before AddIndex\n+        self.assertOperationTypes(changes, 'testapp', 0, [\"AlterOrderWithRespectTo\", \"AddIndex\"])\n+        self.assertOperationAttributes(changes, 'testapp', 0, 0, name=\"author\", order_with_respect_to=\"book\")\n+        self.assertOperationAttributes(changes, 'testapp', 0, 1, model_name=\"author\", index__name='book_order_idx')\n+        # Verify the dependency exists\n+        add_index_op = changes['testapp'][0].operations[1]\n+        self.assertEqual(add_index_op._auto_deps, [('testapp', 'author', 'book', True)])\n+\n     def test_add_model_order_with_respect_to(self):\n         \"\"\"\n         Setting order_with_respect_to when adding the whole model",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13315",
    "model_patch": "diff --git a/django/forms/models.py b/django/forms/models.py\nindex 5d115458a1..f993bb9c98 100644\n--- a/django/forms/models.py\n+++ b/django/forms/models.py\n@@ -100,7 +100,7 @@ def apply_limit_choices_to_to_formfield(formfield):\n     if hasattr(formfield, 'queryset') and hasattr(formfield, 'get_limit_choices_to'):\n         limit_choices_to = formfield.get_limit_choices_to()\n         if limit_choices_to is not None:\n-            formfield.queryset = formfield.queryset.complex_filter(limit_choices_to)\n+            formfield.queryset = formfield.queryset.complex_filter(limit_choices_to).distinct()\n \n \n def fields_for_model(model, fields=None, exclude=None, widgets=None,",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13321",
    "model_patch": "diff --git a/django/contrib/sessions/backends/base.py b/django/contrib/sessions/backends/base.py\nindex 187e14b1b7..4678f756d9 100644\n--- a/django/contrib/sessions/backends/base.py\n+++ b/django/contrib/sessions/backends/base.py\n@@ -1,4 +1,5 @@\n import base64\n+import binascii\n import logging\n import string\n import warnings\n@@ -132,7 +133,10 @@ class SessionBase:\n \n     def _legacy_decode(self, session_data):\n         # RemovedInDjango40Warning: pre-Django 3.1 format will be invalid.\n-        encoded_data = base64.b64decode(session_data.encode('ascii'))\n+        try:\n+            encoded_data = base64.b64decode(session_data.encode('ascii'))\n+        except binascii.Error:\n+            return {}\n         try:\n             # could produce ValueError if there is no ':'\n             hash, serialized = encoded_data.split(b':', 1)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13401",
    "model_patch": "diff --git a/django/db/models/fields/__init__.py b/django/db/models/fields/__init__.py\nindex 28374272f4..bdab6b905f 100644\n--- a/django/db/models/fields/__init__.py\n+++ b/django/db/models/fields/__init__.py\n@@ -516,16 +516,28 @@ class Field(RegisterLookupMixin):\n     def __eq__(self, other):\n         # Needed for @total_ordering\n         if isinstance(other, Field):\n-            return self.creation_counter == other.creation_counter\n+            return (self.creation_counter == other.creation_counter) and (\n+                hasattr(self, 'model') and hasattr(other, 'model') and\n+                self.model == other.model\n+            )\n         return NotImplemented\n \n     def __lt__(self, other):\n         # This is needed because bisect does not take a comparison function.\n         if isinstance(other, Field):\n+            # Order by model first, then by creation_counter to avoid\n+            # re-ordering fields in cases not affected by this equality collision\n+            if hasattr(self, 'model') and hasattr(other, 'model'):\n+                if self.model != other.model:\n+                    return self.model._meta.label < other.model._meta.label\n             return self.creation_counter < other.creation_counter\n         return NotImplemented\n \n     def __hash__(self):\n+        # Include model in hash to ensure fields from different models\n+        # have different hashes even if they have the same creation_counter\n+        if hasattr(self, 'model'):\n+            return hash((self.creation_counter, self.model._meta.label))\n         return hash(self.creation_counter)\n \n     def __deepcopy__(self, memodict):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13447",
    "model_patch": "diff --git a/django/contrib/admin/sites.py b/django/contrib/admin/sites.py\nindex 837dabfea8..252706d837 100644\n--- a/django/contrib/admin/sites.py\n+++ b/django/contrib/admin/sites.py\n@@ -430,7 +430,7 @@ class AdminSite:\n                     return HttpResponsePermanentRedirect(path)\n         raise Http404\n \n-    def _build_app_dict(self, request, label=None):\n+    def build_app_dict(self, request, label=None):\n         \"\"\"\n         Build the app dictionary. The optional `label` parameter filters models\n         of a specific app.\n@@ -463,6 +463,7 @@ class AdminSite:\n             model_dict = {\n                 'name': capfirst(model._meta.verbose_name_plural),\n                 'object_name': model._meta.object_name,\n+                'model': model,\n                 'perms': perms,\n                 'admin_url': None,\n                 'add_url': None,\n@@ -503,7 +504,7 @@ class AdminSite:\n         Return a sorted list of all the installed apps that have been\n         registered in this site.\n         \"\"\"\n-        app_dict = self._build_app_dict(request)\n+        app_dict = self.build_app_dict(request)\n \n         # Sort the apps alphabetically.\n         app_list = sorted(app_dict.values(), key=lambda x: x['name'].lower())\n@@ -534,7 +535,7 @@ class AdminSite:\n         return TemplateResponse(request, self.index_template or 'admin/index.html', context)\n \n     def app_index(self, request, app_label, extra_context=None):\n-        app_dict = self._build_app_dict(request, app_label)\n+        app_dict = self.build_app_dict(request, app_label)\n         if not app_dict:\n             raise Http404('The requested admin page does not exist.')\n         # Sort the models alphabetically within each app.",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13448",
    "model_patch": "diff --git a/django/db/backends/base/creation.py b/django/db/backends/base/creation.py\nindex 503f7f56fd..093bb59943 100644\n--- a/django/db/backends/base/creation.py\n+++ b/django/db/backends/base/creation.py\n@@ -74,7 +74,7 @@ class BaseDatabaseCreation:\n         # and store it on the connection. This slightly horrific process is so people\n         # who are testing on databases without transactions or who are using\n         # a TransactionTestCase still get a clean database on every test run.\n-        if serialize:\n+        if serialize and self.connection.settings_dict['TEST']['MIGRATE']:\n             self.connection._test_serialized_contents = self.serialize_db_to_string()\n \n         call_command('createcachetable', database=self.connection.alias)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13551",
    "model_patch": "diff --git a/django/contrib/auth/tokens.py b/django/contrib/auth/tokens.py\nindex 93e2d71af2..807d923e81 100644\n--- a/django/contrib/auth/tokens.py\n+++ b/django/contrib/auth/tokens.py\n@@ -85,6 +85,8 @@ class PasswordResetTokenGenerator:\n            same password is chosen, due to password salting).\n         2. The last_login field will usually be updated very shortly after\n            a password reset.\n+        3. The email field is included to invalidate tokens when the email\n+           address is changed.\n         Failing those things, settings.PASSWORD_RESET_TIMEOUT eventually\n         invalidates the token.\n \n@@ -94,7 +96,8 @@ class PasswordResetTokenGenerator:\n         # Truncate microseconds so that tokens are consistent even if the\n         # database doesn't support microseconds.\n         login_timestamp = '' if user.last_login is None else user.last_login.replace(microsecond=0, tzinfo=None)\n-        return str(user.pk) + user.password + str(login_timestamp) + str(timestamp)\n+        email = getattr(user, user.get_email_field_name(), '')\n+        return str(user.pk) + user.password + str(login_timestamp) + str(timestamp) + str(email)\n \n     def _num_seconds(self, dt):\n         return int((dt - datetime(2001, 1, 1)).total_seconds())",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13590",
    "model_patch": "diff --git a/django/db/models/sql/query.py b/django/db/models/sql/query.py\nindex 4648daf395..ac88bae97b 100644\n--- a/django/db/models/sql/query.py\n+++ b/django/db/models/sql/query.py\n@@ -1078,8 +1078,8 @@ class Query(BaseExpression):\n             # The items of the iterable may be expressions and therefore need\n             # to be resolved independently.\n             return type(value)(\n-                self.resolve_lookup_value(sub_value, can_reuse, allow_joins)\n-                for sub_value in value\n+                *(self.resolve_lookup_value(sub_value, can_reuse, allow_joins)\n+                for sub_value in value)\n             )\n         return value",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13658",
    "model_patch": "diff --git a/django/core/management/__init__.py b/django/core/management/__init__.py\nindex 1ba093e51f..4e30a28f33 100644\n--- a/django/core/management/__init__.py\n+++ b/django/core/management/__init__.py\n@@ -344,7 +344,12 @@ class ManagementUtility:\n         # Preprocess options to extract --settings and --pythonpath.\n         # These options could affect the commands that are available, so they\n         # must be processed early.\n-        parser = CommandParser(usage='%(prog)s subcommand [options] [args]', add_help=False, allow_abbrev=False)\n+        parser = CommandParser(\n+            prog=self.prog_name,\n+            usage='%(prog)s subcommand [options] [args]',\n+            add_help=False,\n+            allow_abbrev=False,\n+        )\n         parser.add_argument('--settings')\n         parser.add_argument('--pythonpath')\n         parser.add_argument('args', nargs='*')  # catch-all",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15819",
    "model_patch": "diff --git a/django/core/management/commands/inspectdb.py b/django/core/management/commands/inspectdb.py\nindex f33bcbdccf..98b1a354b8 100644\n--- a/django/core/management/commands/inspectdb.py\n+++ b/django/core/management/commands/inspectdb.py\n@@ -133,6 +133,7 @@ class Command(BaseCommand):\n                 known_models.append(table2model(table_name))\n                 used_column_names = []  # Holds column names used in the table so far\n                 column_to_field_name = {}  # Maps column names to names of model fields\n+                used_relations = {}  # Track relations to avoid reverse accessor clashes\n                 for row in table_description:\n                     comment_notes = (\n                         []\n@@ -182,6 +183,10 @@ class Command(BaseCommand):\n                             if ref_db_table == table_name\n                             else table2model(ref_db_table)\n                         )\n+                        # Add related_name if this model has multiple relations to the same table\n+                        if rel_to in used_relations:\n+                            extra_params[\"related_name\"] = att_name\n+                        used_relations[rel_to] = used_relations.get(rel_to, 0) + 1\n                         if rel_to in known_models:\n                             field_type = \"%s(%s\" % (rel_type, rel_to)\n                         else:",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15851",
    "model_patch": "diff --git a/django/db/backends/postgresql/client.py b/django/db/backends/postgresql/client.py\nindex 4c9bd63546..3b5ddafaca 100644\n--- a/django/db/backends/postgresql/client.py\n+++ b/django/db/backends/postgresql/client.py\n@@ -32,9 +32,9 @@ class DatabaseClient(BaseDatabaseClient):\n             args += [\"-h\", host]\n         if port:\n             args += [\"-p\", str(port)]\n+        args.extend(parameters)\n         if dbname:\n             args += [dbname]\n-        args.extend(parameters)\n \n         env = {}\n         if passwd:\ndiff --git a/tests/dbshell/test_postgresql.py b/tests/dbshell/test_postgresql.py\nindex 02924d0bcc..53dedaca01 100644\n--- a/tests/dbshell/test_postgresql.py\n+++ b/tests/dbshell/test_postgresql.py\n@@ -154,7 +154,7 @@ class PostgreSqlDbshellCommandTestCase(SimpleTestCase):\n     def test_parameters(self):\n         self.assertEqual(\n             self.settings_to_cmd_args_env({\"NAME\": \"dbname\"}, [\"--help\"]),\n-            ([\"psql\", \"dbname\", \"--help\"], None),\n+            ([\"psql\", \"--help\", \"dbname\"], None),\n         )\n \n     @skipUnless(connection.vendor == \"postgresql\", \"Requires a PostgreSQL connection\")",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15902",
    "model_patch": "diff --git a/django/forms/utils.py b/django/forms/utils.py\nindex 905babce4d..8252a35fac 100644\n--- a/django/forms/utils.py\n+++ b/django/forms/utils.py\n@@ -65,9 +65,15 @@ class RenderableMixin:\n         renderer = renderer or self.renderer\n         template = template_name or self.template_name\n         context = context or self.get_context()\n+        # Avoid the deprecation warning for ManagementForm as it only renders\n+        # hidden inputs and the template used is insignificant.\n+        from django.forms.formsets import ManagementForm\n         if (\n-            template == \"django/forms/default.html\"\n-            or template == \"django/forms/formsets/default.html\"\n+            not isinstance(self, ManagementForm)\n+            and (\n+                template == \"django/forms/default.html\"\n+                or template == \"django/forms/formsets/default.html\"\n+            )\n         ):\n             warnings.warn(\n                 DEFAULT_TEMPLATE_DEPRECATION_MSG, RemovedInDjango50Warning, stacklevel=2",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-16041",
    "model_patch": "diff --git a/django/forms/formsets.py b/django/forms/formsets.py\nindex 57676428ff..e1a0c830d1 100644\n--- a/django/forms/formsets.py\n+++ b/django/forms/formsets.py\n@@ -257,14 +257,12 @@ class BaseFormSet(RenderableFormMixin):\n \n     @property\n     def empty_form(self):\n-        form = self.form(\n-            auto_id=self.auto_id,\n-            prefix=self.add_prefix(\"__prefix__\"),\n-            empty_permitted=True,\n-            use_required_attribute=False,\n-            **self.get_form_kwargs(None),\n-            renderer=self.renderer,\n-        )\n+        defaults = {\"auto_id\": self.auto_id, \"prefix\": self.add_prefix(\"__prefix__\"), \"empty_permitted\": True, \"use_required_attribute\": False}\n+        defaults.update(self.get_form_kwargs(None))\n+        # Always use empty_permitted=True for empty_form.\n+        defaults[\"empty_permitted\"] = True\n+        defaults[\"renderer\"] = self.renderer\n+        form = self.form(**defaults)\n         self.add_fields(form, None)\n         return form",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-16046",
    "model_patch": "diff --git a/django/utils/numberformat.py b/django/utils/numberformat.py\nindex 488d6a77cd..e952af3fdc 100644\n--- a/django/utils/numberformat.py\n+++ b/django/utils/numberformat.py\n@@ -68,7 +68,7 @@ def format(\n             str_number = \"{:f}\".format(number)\n     else:\n         str_number = str(number)\n-    if str_number[0] == \"-\":\n+    if str_number and str_number[0] == \"-\":\n         sign = \"-\"\n         str_number = str_number[1:]\n     # decimal part",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-16139",
    "model_patch": "diff --git a/django/contrib/auth/forms.py b/django/contrib/auth/forms.py\nindex b3cfc6723c..f6c4b7fc2f 100644\n--- a/django/contrib/auth/forms.py\n+++ b/django/contrib/auth/forms.py\n@@ -163,7 +163,7 @@ class UserChangeForm(forms.ModelForm):\n         super().__init__(*args, **kwargs)\n         password = self.fields.get(\"password\")\n         if password:\n-            password.help_text = password.help_text.format(\"../password/\")\n+            password.help_text = password.help_text.format(f\"../../{self.instance.pk}/password/\")\n         user_permissions = self.fields.get(\"user_permissions\")\n         if user_permissions:\n             user_permissions.queryset = user_permissions.queryset.select_related(",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-16229",
    "model_patch": "diff --git a/django/db/models/fields/__init__.py b/django/db/models/fields/__init__.py\nindex 2a98396cad..7588be8d66 100644\n--- a/django/db/models/fields/__init__.py\n+++ b/django/db/models/fields/__init__.py\n@@ -1014,7 +1014,6 @@ class Field(RegisterLookupMixin):\n         if self.has_default():\n             if callable(self.default):\n                 defaults[\"initial\"] = self.default\n-                defaults[\"show_hidden_initial\"] = True\n             else:\n                 defaults[\"initial\"] = self.get_default()\n         if self.choices is not None:",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-16255",
    "model_patch": "diff --git a/django/contrib/sitemaps/__init__.py b/django/contrib/sitemaps/__init__.py\nindex 27756d9d96..b40ad806ed 100644\n--- a/django/contrib/sitemaps/__init__.py\n+++ b/django/contrib/sitemaps/__init__.py\n@@ -168,7 +168,7 @@ class Sitemap:\n         if callable(self.lastmod):\n             try:\n                 return max([self.lastmod(item) for item in self.items()])\n-            except TypeError:\n+            except (TypeError, ValueError):\n                 return None\n         else:\n             return self.lastmod",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-16379",
    "model_patch": "diff --git a/django/core/cache/backends/filebased.py b/django/core/cache/backends/filebased.py\nindex 631da49444..215fefbcc0 100644\n--- a/django/core/cache/backends/filebased.py\n+++ b/django/core/cache/backends/filebased.py\n@@ -90,10 +90,11 @@ class FileBasedCache(BaseCache):\n \n     def has_key(self, key, version=None):\n         fname = self._key_to_file(key, version)\n-        if os.path.exists(fname):\n+        try:\n             with open(fname, \"rb\") as f:\n                 return not self._is_expired(f)\n-        return False\n+        except FileNotFoundError:\n+            return False\n \n     def _cull(self):\n         \"\"\"",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-16400",
    "model_patch": "diff --git a/django/contrib/contenttypes/models.py b/django/contrib/contenttypes/models.py\nindex 759a53ce67..f6a6975774 100644\n--- a/django/contrib/contenttypes/models.py\n+++ b/django/contrib/contenttypes/models.py\n@@ -46,14 +46,17 @@ class ContentTypeManager(models.Manager):\n \n         # The ContentType entry was not found in the cache, therefore we\n         # proceed to load or create it.\n+        # Use self.using(self._db) if self._db is set to bypass the router\n+        # and respect the explicit database parameter.\n+        manager = self.using(self._db) if self._db is not None else self\n         try:\n             # Start with get() and not get_or_create() in order to use\n             # the db_for_read (see #20401).\n-            ct = self.get(app_label=opts.app_label, model=opts.model_name)\n+            ct = manager.get(app_label=opts.app_label, model=opts.model_name)\n         except self.model.DoesNotExist:\n             # Not found in the database; we proceed to create it. This time\n             # use get_or_create to take care of any race conditions.\n-            ct, created = self.get_or_create(\n+            ct, created = manager.get_or_create(\n                 app_label=opts.app_label,\n                 model=opts.model_name,\n             )",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-16408",
    "model_patch": "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 7c433b3f06..fdddde97c0 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -1275,7 +1275,7 @@ class SQLCompiler:\n                     final_field.remote_field.set_cached_value(from_obj, obj)\n \n             def remote_setter(name, obj, from_obj):\n-                setattr(from_obj, name, obj)\n+                setattr(obj, name, from_obj)\n \n             for name in list(requested):\n                 # Filtered relations work only on the topmost level.",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-16527",
    "model_patch": "diff --git a/django/contrib/admin/templatetags/admin_modify.py b/django/contrib/admin/templatetags/admin_modify.py\nindex 9df4b7aadb..5b742af46a 100644\n--- a/django/contrib/admin/templatetags/admin_modify.py\n+++ b/django/contrib/admin/templatetags/admin_modify.py\n@@ -100,6 +100,7 @@ def submit_row(context):\n                 and context.get(\"show_delete\", True)\n             ),\n             \"show_save_as_new\": not is_popup\n+            and has_add_permission\n             and has_change_permission\n             and change\n             and save_as,",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-16595",
    "model_patch": "diff --git a/django/db/migrations/operations/fields.py b/django/db/migrations/operations/fields.py\nindex cd3aab43ad..12c988c441 100644\n--- a/django/db/migrations/operations/fields.py\n+++ b/django/db/migrations/operations/fields.py\n@@ -247,7 +247,11 @@ class AlterField(FieldOperation):\n         return \"alter_%s_%s\" % (self.model_name_lower, self.name_lower)\n \n     def reduce(self, operation, app_label):\n-        if isinstance(operation, RemoveField) and self.is_same_field_operation(\n+        if isinstance(operation, AlterField) and self.is_same_field_operation(\n+            operation\n+        ):\n+            return [operation]\n+        elif isinstance(operation, RemoveField) and self.is_same_field_operation(\n             operation\n         ):\n             return [operation]",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-16816",
    "model_patch": "diff --git a/django/contrib/admin/checks.py b/django/contrib/admin/checks.py\nindex 0fefe65e48..84ae0f9916 100644\n--- a/django/contrib/admin/checks.py\n+++ b/django/contrib/admin/checks.py\n@@ -927,6 +927,17 @@ class ModelAdminChecks(BaseModelAdminChecks):\n                     id=\"admin.E109\",\n                 )\n             ]\n+        # Check for reverse relations (e.g., when Choice has ForeignKey to Question,\n+        # Question has a reverse relation 'choice_set' or custom related_name).\n+        if getattr(field, \"is_relation\", False) and getattr(field, \"one_to_many\", False):\n+            return [\n+                checks.Error(\n+                    f\"The value of '{label}' must not be a many-to-many field or a \"\n+                    f\"reverse foreign key.\",\n+                    obj=obj.__class__,\n+                    id=\"admin.E109\",\n+                )\n+            ]\n         return []\n \n     def _check_list_display_links(self, obj):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "psf__requests-1963",
    "model_patch": "diff --git a/requests/sessions.py b/requests/sessions.py\nindex 425db22c..a4e4b850 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -88,7 +88,7 @@ class SessionRedirectMixin(object):\n         i = 0\n \n         while resp.is_redirect:\n-            prepared_request = req.copy()\n+            prepared_request = resp.request.copy()\n \n             resp.content  # Consume socket so it can be released\n \n@@ -99,7 +99,7 @@ class SessionRedirectMixin(object):\n             resp.close()\n \n             url = resp.headers['location']\n-            method = req.method\n+            method = resp.request.method\n \n             # Handle redirection without scheme (see: RFC 1808 Section 4)\n             if url.startswith('//'):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "psf__requests-2148",
    "model_patch": "diff --git a/requests/models.py b/requests/models.py\nindex 0dc55568..f60ea75c 100644\n--- a/requests/models.py\n+++ b/requests/models.py\n@@ -9,6 +9,7 @@ This module contains the primary objects that power Requests.\n \n import collections\n import datetime\n+import socket\n \n from io import BytesIO, UnsupportedOperation\n from .hooks import default_hooks\n@@ -22,7 +23,7 @@ from .packages.urllib3.util import parse_url\n from .packages.urllib3.exceptions import DecodeError\n from .exceptions import (\n     HTTPError, RequestException, MissingSchema, InvalidURL,\n-    ChunkedEncodingError, ContentDecodingError)\n+    ChunkedEncodingError, ContentDecodingError, ConnectionError)\n from .utils import (\n     guess_filename, get_auth_from_url, requote_uri,\n     stream_decode_response_unicode, to_key_val_list, parse_header_links,\n@@ -636,6 +637,8 @@ class Response(object):\n                 try:\n                     for chunk in self.raw.stream(chunk_size, decode_content=True):\n                         yield chunk\n+                except socket.error as sockerr:\n+                    raise ConnectionError(sockerr)\n                 except IncompleteRead as e:\n                     raise ChunkedEncodingError(e)\n                 except DecodeError as e:",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "psf__requests-2317",
    "model_patch": "diff --git a/requests/sessions.py b/requests/sessions.py\nindex d701ff2e..adcfbac7 100644\n--- a/requests/sessions.py\n+++ b/requests/sessions.py\n@@ -425,7 +425,7 @@ class Session(SessionRedirectMixin):\n             If Tuple, ('cert', 'key') pair.\n         \"\"\"\n \n-        method = builtin_str(method)\n+        method = to_native_string(method)\n \n         # Create the Request.\n         req = Request(",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "psf__requests-2674",
    "model_patch": "diff --git a/requests/adapters.py b/requests/adapters.py\nindex 841cbbfe..dd68c68e 100644\n--- a/requests/adapters.py\n+++ b/requests/adapters.py\n@@ -20,6 +20,7 @@ from .utils import (DEFAULT_CA_BUNDLE_PATH, get_encoding_from_headers,\n                     prepend_scheme_if_needed, get_auth_from_url, urldefragauth)\n from .structures import CaseInsensitiveDict\n from .packages.urllib3.exceptions import ConnectTimeoutError\n+from .packages.urllib3.exceptions import DecodeError as _DecodeError\n from .packages.urllib3.exceptions import HTTPError as _HTTPError\n from .packages.urllib3.exceptions import MaxRetryError\n from .packages.urllib3.exceptions import ProxyError as _ProxyError\n@@ -27,9 +28,10 @@ from .packages.urllib3.exceptions import ProtocolError\n from .packages.urllib3.exceptions import ReadTimeoutError\n from .packages.urllib3.exceptions import SSLError as _SSLError\n from .packages.urllib3.exceptions import ResponseError\n+from .packages.urllib3.exceptions import TimeoutError as _TimeoutError\n from .cookies import extract_cookies_to_jar\n from .exceptions import (ConnectionError, ConnectTimeout, ReadTimeout, SSLError,\n-                         ProxyError, RetryError)\n+                         ProxyError, RetryError, ContentDecodingError)\n from .auth import _basic_auth_str\n \n DEFAULT_POOLBLOCK = False\n@@ -429,6 +431,10 @@ class HTTPAdapter(BaseAdapter):\n                 raise SSLError(e, request=request)\n             elif isinstance(e, ReadTimeoutError):\n                 raise ReadTimeout(e, request=request)\n+            elif isinstance(e, _DecodeError):\n+                raise ContentDecodingError(e, request=request)\n+            elif isinstance(e, _TimeoutError):\n+                raise ConnectTimeout(e, request=request)\n             else:\n                 raise",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "psf__requests-3362",
    "model_patch": "diff --git a/requests/utils.py b/requests/utils.py\nindex 8d17b6b2..330db97a 100644\n--- a/requests/utils.py\n+++ b/requests/utils.py\n@@ -360,9 +360,11 @@ def stream_decode_response_unicode(iterator, r):\n     \"\"\"Stream decodes a iterator.\"\"\"\n \n     if r.encoding is None:\n-        for item in iterator:\n-            yield item\n-        return\n+        r.encoding = r.apparent_encoding\n+        if r.encoding is None:\n+            for item in iterator:\n+                yield item\n+            return\n \n     decoder = codecs.getincrementaldecoder(r.encoding)(errors='replace')\n     for chunk in iterator:",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pydata__xarray-3364",
    "model_patch": "diff --git a/xarray/core/concat.py b/xarray/core/concat.py\nindex ecae2566..846ac532 100644\n--- a/xarray/core/concat.py\n+++ b/xarray/core/concat.py\n@@ -1,3 +1,4 @@\n+import numpy as np\n import pandas as pd\n \n from . import dtypes, utils\n@@ -312,15 +313,24 @@ def _dataset_concat(\n         to_merge = {var: [] for var in variables_to_merge}\n \n         for ds in datasets:\n-            absent_merge_vars = variables_to_merge - set(ds.variables)\n-            if absent_merge_vars:\n-                raise ValueError(\n-                    \"variables %r are present in some datasets but not others. \"\n-                    % absent_merge_vars\n-                )\n-\n             for var in variables_to_merge:\n-                to_merge[var].append(ds.variables[var])\n+                if var in ds.variables:\n+                    to_merge[var].append(ds.variables[var])\n+                else:\n+                    # Create a filled variable for missing data\n+                    if var in datasets[0].variables:\n+                        template_var = datasets[0].variables[var]\n+                        # Create a variable filled with fill_value\n+                        missing_var = template_var.copy()\n+                        missing_var.data = np.full(\n+                            template_var.shape, fill_value, dtype=template_var.dtype\n+                        )\n+                        to_merge[var].append(missing_var)\n+                    else:\n+                        raise ValueError(\n+                            \"variables %r are present in some datasets but not others. \"\n+                            % var\n+                        )\n \n         for var in variables_to_merge:\n             result_vars[var] = unique_variable(\n@@ -356,12 +366,36 @@ def _dataset_concat(\n \n     # stack up each variable to fill-out the dataset (in order)\n     # n.b. this loop preserves variable order, needed for groupby.\n-    for k in datasets[0].variables:\n+    # Get all variables that need to be concatenated\n+    all_vars = set()\n+    for ds in datasets:\n+        all_vars.update(ds.variables)\n+    \n+    for k in all_vars:\n         if k in concat_over:\n-            try:\n-                vars = ensure_common_dims([ds.variables[k] for ds in datasets])\n-            except KeyError:\n-                raise ValueError(\"%r is not present in all datasets.\" % k)\n+            vars_to_concat = []\n+            for ds in datasets:\n+                if k in ds.variables:\n+                    vars_to_concat.append(ds.variables[k])\n+                else:\n+                    # Create a filled variable for missing data\n+                    # Find a template from any dataset that has this variable\n+                    for template_ds in datasets:\n+                        if k in template_ds.variables:\n+                            template_var = template_ds.variables[k]\n+                            break\n+                    missing_var = template_var.copy()\n+                    # Get the shape for this dataset along the concat dimension\n+                    dim_len = ds.dims.get(dim, 1)\n+                    # Calculate the full shape for the missing variable\n+                    common_dims = tuple(pd.unique([d for v in [template_var] for d in v.dims]))\n+                    if dim not in common_dims:\n+                        common_dims = (dim,) + common_dims\n+                    common_shape = tuple(dims_sizes.get(d, dim_len) for d in common_dims)\n+                    missing_var.data = np.full(common_shape, fill_value, dtype=template_var.dtype)\n+                    vars_to_concat.append(missing_var)\n+\n+            vars = ensure_common_dims(vars_to_concat)\n             combined = concat_vars(vars, dim, positions)\n             assert isinstance(combined, Variable)\n             result_vars[k] = combined",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-22711",
    "model_patch": "diff --git a/lib/matplotlib/widgets.py b/lib/matplotlib/widgets.py\nindex da5b40a5ef..b3101cdbbc 100644\n--- a/lib/matplotlib/widgets.py\n+++ b/lib/matplotlib/widgets.py\n@@ -903,13 +903,11 @@ class RangeSlider(SliderBase):\n             xy[1] = .25, val[1]\n             xy[2] = .75, val[1]\n             xy[3] = .75, val[0]\n-            xy[4] = .25, val[0]\n         else:\n             xy[0] = val[0], .25\n             xy[1] = val[0], .75\n             xy[2] = val[1], .75\n             xy[3] = val[1], .25\n-            xy[4] = val[0], .25\n         self.poly.xy = xy\n         self.valtext.set_text(self._format(val))\n         if self.drawon:",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-22835",
    "model_patch": "diff --git a/lib/matplotlib/artist.py b/lib/matplotlib/artist.py\nindex 1f33b9d3ec..3fc64b4a1f 100644\n--- a/lib/matplotlib/artist.py\n+++ b/lib/matplotlib/artist.py\n@@ -1304,10 +1304,15 @@ class Artist:\n             normed = self.norm(data)\n             if np.isfinite(normed):\n                 # Midpoints of neighboring color intervals.\n-                neighbors = self.norm.inverse(\n-                    (int(self.norm(data) * n) + np.array([0, 1])) / n)\n-                delta = abs(neighbors - data).max()\n-                g_sig_digits = cbook._g_sig_digits(data, delta)\n+                try:\n+                    neighbors = self.norm.inverse(\n+                        (int(self.norm(data) * n) + np.array([0, 1])) / n)\n+                    delta = abs(neighbors - data).max()\n+                    g_sig_digits = cbook._g_sig_digits(data, delta)\n+                except (ValueError, AttributeError):\n+                    # ValueError: norm is not invertible (e.g., BoundaryNorm)\n+                    # AttributeError: norm does not have inverse method\n+                    g_sig_digits = 3  # Consistent with default below.\n             else:\n                 g_sig_digits = 3  # Consistent with default below.\n             return \"[{:-#.{}g}]\".format(data, g_sig_digits)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-23299",
    "model_patch": "diff --git a/lib/matplotlib/__init__.py b/lib/matplotlib/__init__.py\nindex c268a56724..1e0c781bea 100644\n--- a/lib/matplotlib/__init__.py\n+++ b/lib/matplotlib/__init__.py\n@@ -674,7 +674,10 @@ class RcParams(MutableMapping, dict):\n             val = dict.__getitem__(self, key)\n             if val is rcsetup._auto_backend_sentinel:\n                 from matplotlib import pyplot as plt\n-                plt.switch_backend(rcsetup._auto_backend_sentinel)\n+                # Only call switch_backend if the backend hasn't been\n+                # initialized yet, to avoid closing all existing figures.\n+                if plt._backend_mod is None:\n+                    plt.switch_backend(rcsetup._auto_backend_sentinel)\n \n         return dict.__getitem__(self, key)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-23314",
    "model_patch": "diff --git a/lib/mpl_toolkits/mplot3d/axes3d.py b/lib/mpl_toolkits/mplot3d/axes3d.py\nindex 9db44b7994..5479bc1af0 100644\n--- a/lib/mpl_toolkits/mplot3d/axes3d.py\n+++ b/lib/mpl_toolkits/mplot3d/axes3d.py\n@@ -387,6 +387,8 @@ class Axes3D(Axes):\n \n     @martist.allow_rasterization\n     def draw(self, renderer):\n+        if not self.get_visible():\n+            return\n         self._unstale_viewLim()\n \n         # draw the background patch",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-23476",
    "model_patch": "diff --git a/lib/matplotlib/figure.py b/lib/matplotlib/figure.py\nindex c55864243a..f96d1e0bff 100644\n--- a/lib/matplotlib/figure.py\n+++ b/lib/matplotlib/figure.py\n@@ -3044,7 +3044,11 @@ class Figure(FigureBase):\n         self.__dict__ = state\n \n         # re-initialise some of the unstored state information\n+        # Store the current DPI before creating the canvas to avoid it being\n+        # scaled by the device pixel ratio on high DPI displays (e.g., macOS)\n+        _dpi = self.dpi\n         FigureCanvasBase(self)  # Set self.canvas.\n+        self.dpi = _dpi\n \n         if restore_to_pylab:\n             # lazy import to avoid circularity",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-23562",
    "model_patch": "diff --git a/lib/mpl_toolkits/mplot3d/art3d.py b/lib/mpl_toolkits/mplot3d/art3d.py\nindex 8fe6e7a9c1..936b59faaa 100644\n--- a/lib/mpl_toolkits/mplot3d/art3d.py\n+++ b/lib/mpl_toolkits/mplot3d/art3d.py\n@@ -765,6 +765,10 @@ class Poly3DCollection(PolyCollection):\n         self._facecolor3d = PolyCollection.get_facecolor(self)\n         self._edgecolor3d = PolyCollection.get_edgecolor(self)\n         self._alpha3d = PolyCollection.get_alpha(self)\n+        # Initialize 2d colors to avoid AttributeError when get_facecolor()\n+        # or get_edgecolor() is called before do_3d_projection()\n+        self._facecolors2d = self._facecolor3d\n+        self._edgecolors2d = self._edgecolor3d\n         self.stale = True\n \n     def set_sort_zpos(self, val):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-23563",
    "model_patch": "diff --git a/lib/mpl_toolkits/mplot3d/art3d.py b/lib/mpl_toolkits/mplot3d/art3d.py\nindex 8fe6e7a9c1..69ae65b9b0 100644\n--- a/lib/mpl_toolkits/mplot3d/art3d.py\n+++ b/lib/mpl_toolkits/mplot3d/art3d.py\n@@ -222,6 +222,9 @@ def line_2d_to_3d(line, zs=0, zdir='z'):\n     \"\"\"Convert a 2D line to 3D.\"\"\"\n \n     line.__class__ = Line3D\n+    # Initialize _verts3d before calling set_3d_properties to ensure\n+    # the attribute exists even if set_3d_properties fails\n+    line._verts3d = ([], [], [])\n     line.set_3d_properties(zs, zdir)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-23913",
    "model_patch": "diff --git a/lib/matplotlib/legend.py b/lib/matplotlib/legend.py\nindex 9e5b903d59..e76b0df66e 100644\n--- a/lib/matplotlib/legend.py\n+++ b/lib/matplotlib/legend.py\n@@ -286,6 +286,11 @@ handler_map : dict or None\n     The custom dictionary mapping instances or types to a legend\n     handler. This *handler_map* updates the default handler map\n     found at `matplotlib.legend.Legend.get_legend_handler_map`.\n+\n+draggable : bool, default: False\n+    Whether the legend can be dragged with the mouse. If ``True``, the\n+    legend can be dragged interactively. See `set_draggable` for more\n+    details.\n \"\"\")\n \n \n@@ -342,7 +347,8 @@ class Legend(Artist):\n         title_fontproperties=None,  # properties for the legend title\n         alignment=\"center\",       # control the alignment within the legend box\n         *,\n-        ncol=1  # synonym for ncols (backward compatibility)\n+        ncol=1,  # synonym for ncols (backward compatibility)\n+        draggable=None  # whether the legend can be dragged with mouse\n     ):\n         \"\"\"\n         Parameters\n@@ -539,6 +545,10 @@ class Legend(Artist):\n         self.set_title(title, prop=title_prop_fp)\n         self._draggable = None\n \n+        # set draggable state if requested\n+        if draggable is not None:\n+            self.set_draggable(draggable)\n+\n         # set the text color\n \n         color_getters = {  # getter function depends on line or patch",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-23964",
    "model_patch": "diff --git a/lib/matplotlib/backends/backend_ps.py b/lib/matplotlib/backends/backend_ps.py\nindex f209e811f1..bd996b7509 100644\n--- a/lib/matplotlib/backends/backend_ps.py\n+++ b/lib/matplotlib/backends/backend_ps.py\n@@ -666,7 +666,8 @@ grestore\n                     (item.x, item.ft_object.get_glyph_name(item.glyph_idx))\n                 )\n             # append the last entry\n-            stream.append(curr_stream)\n+            if curr_stream:\n+                stream.append(curr_stream)\n \n         self.set_color(*gc.get_rgb())",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-23987",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-24149",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-24265",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-24334",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-24970",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-25079",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-25311",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-25332",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-25433",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-25442",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-25498",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-26011",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-26020",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "mwaskom__seaborn-2848",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "mwaskom__seaborn-3010",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-5221",
    "model_patch": "diff --git a/src/_pytest/python.py b/src/_pytest/python.py\nindex 377357846..a30f14fb6 100644\n--- a/src/_pytest/python.py\n+++ b/src/_pytest/python.py\n@@ -1347,6 +1347,7 @@ def _showfixtures_main(config, session):\n         else:\n             funcargspec = argname\n         tw.line(funcargspec, green=True)\n+        tw.line(\"    scope: %s\" % (fixturedef.scope,), yellow=True)\n         loc = getlocation(fixturedef.func, curdir)\n         doc = fixturedef.func.__doc__ or \"\"\n         if doc:",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-5227",
    "model_patch": "diff --git a/src/_pytest/logging.py b/src/_pytest/logging.py\nindex 757cb2797..08670d2b2 100644\n--- a/src/_pytest/logging.py\n+++ b/src/_pytest/logging.py\n@@ -15,7 +15,7 @@ from _pytest.compat import dummy_context_manager\n from _pytest.config import create_terminal_writer\n from _pytest.pathlib import Path\n \n-DEFAULT_LOG_FORMAT = \"%(filename)-25s %(lineno)4d %(levelname)-8s %(message)s\"\n+DEFAULT_LOG_FORMAT = \"%(levelname)-8s %(name)s:%(filename)s:%(lineno)d %(message)s\"\n DEFAULT_LOG_DATE_FORMAT = \"%H:%M:%S\"",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-5413",
    "model_patch": "diff --git a/src/_pytest/_code/code.py b/src/_pytest/_code/code.py\nindex c4ed961ac..d270e4eb6 100644\n--- a/src/_pytest/_code/code.py\n+++ b/src/_pytest/_code/code.py\n@@ -539,7 +539,8 @@ class ExceptionInfo:\n             return repr(self)\n         entry = self.traceback[-1]\n         loc = ReprFileLocation(entry.path, entry.lineno + 1, self.exconly())\n-        return str(loc)\n+        # Return the full exception message, not truncated by ReprFileLocation\n+        return str(self.value)\n \n     def match(self, regexp):\n         \"\"\"",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-5495",
    "model_patch": "diff --git a/src/_pytest/assertion/util.py b/src/_pytest/assertion/util.py\nindex 762e5761d..34d757c52 100644\n--- a/src/_pytest/assertion/util.py\n+++ b/src/_pytest/assertion/util.py\n@@ -268,20 +268,28 @@ def _compare_eq_sequence(left, right, verbose=0):\n     if len_diff:\n         if len_diff > 0:\n             dir_with_more = \"Left\"\n-            extra = saferepr(left[len_right])\n+            extra = left[len_right]\n         else:\n             len_diff = 0 - len_diff\n             dir_with_more = \"Right\"\n-            extra = saferepr(right[len_left])\n+            extra = right[len_left]\n+\n+        # Format bytes values more clearly\n+        if isinstance(extra, int) and isinstance(left, (bytes, bytearray)):\n+            extra_repr = \"{!r} ({})\".format(bytes([extra]), extra)\n+        elif isinstance(extra, int) and isinstance(right, (bytes, bytearray)):\n+            extra_repr = \"{!r} ({})\".format(bytes([extra]), extra)\n+        else:\n+            extra_repr = saferepr(extra)\n \n         if len_diff == 1:\n             explanation += [\n-                \"{} contains one more item: {}\".format(dir_with_more, extra)\n+                \"{} contains one more item: {}\".format(dir_with_more, extra_repr)\n             ]\n         else:\n             explanation += [\n                 \"%s contains %d more items, first extra item: %s\"\n-                % (dir_with_more, len_diff, extra)\n+                % (dir_with_more, len_diff, extra_repr)\n             ]\n     return explanation",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-5692",
    "model_patch": "diff --git a/src/_pytest/junitxml.py b/src/_pytest/junitxml.py\nindex 15c630b1d..15f4b43c6 100644\n--- a/src/_pytest/junitxml.py\n+++ b/src/_pytest/junitxml.py\n@@ -11,6 +11,7 @@ src/main/resources/org/jenkinsci/plugins/xunit/types/model/xsd/junit-10.xsd\n import functools\n import os\n import re\n+import socket\n import sys\n import time\n \n@@ -666,6 +667,8 @@ class LogXML:\n             skipped=self.stats[\"skipped\"],\n             tests=numtests,\n             time=\"%.3f\" % suite_time_delta,\n+            timestamp=time.strftime(\"%Y-%m-%dT%H:%M:%S\", time.gmtime(self.suite_start_time)),\n+            hostname=socket.gethostname(),\n         )\n         logfile.write(Junit.testsuites([suite_node]).unicode(indent=0))\n         logfile.close()",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-6116",
    "model_patch": "diff --git a/src/_pytest/main.py b/src/_pytest/main.py\nindex 843c5b5f7..78c580395 100644\n--- a/src/_pytest/main.py\n+++ b/src/_pytest/main.py\n@@ -107,6 +107,7 @@ def pytest_addoption(parser):\n \n     group = parser.getgroup(\"collect\", \"collection\")\n     group.addoption(\n+        \"-C\",\n         \"--collectonly\",\n         \"--collect-only\",\n         action=\"store_true\",",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-7168",
    "model_patch": "diff --git a/src/_pytest/_io/saferepr.py b/src/_pytest/_io/saferepr.py\nindex 23af4d0bb..25f1d0e12 100644\n--- a/src/_pytest/_io/saferepr.py\n+++ b/src/_pytest/_io/saferepr.py\n@@ -19,8 +19,21 @@ def _format_repr_exception(exc: BaseException, obj: Any) -> str:\n         raise\n     except BaseException as exc:\n         exc_info = \"unpresentable exception ({})\".format(_try_repr_or_str(exc))\n+    # Protect against __getattribute__ and other failures when accessing object attributes\n+    try:\n+        class_name = obj.__class__.__name__\n+    except (KeyboardInterrupt, SystemExit):\n+        raise\n+    except BaseException:\n+        class_name = \"<unknown type>\"\n+    try:\n+        obj_id = id(obj)\n+    except (KeyboardInterrupt, SystemExit):\n+        raise\n+    except BaseException:\n+        obj_id = 0\n     return \"<[{} raised in repr()] {} object at 0x{:x}>\".format(\n-        exc_info, obj.__class__.__name__, id(obj)\n+        exc_info, class_name, obj_id\n     )\n \n \ndiff --git a/testing/io/test_saferepr.py b/testing/io/test_saferepr.py\nindex 06084202e..2e4583c57 100644\n--- a/testing/io/test_saferepr.py\n+++ b/testing/io/test_saferepr.py\n@@ -154,3 +154,19 @@ def test_pformat_dispatch():\n     assert _pformat_dispatch(\"a\") == \"'a'\"\n     assert _pformat_dispatch(\"a\" * 10, width=5) == \"'aaaaaaaaaa'\"\n     assert _pformat_dispatch(\"foo bar\", width=5) == \"('foo '\\n 'bar')\"\n+\n+\n+def test_broken_getattribute():\n+    \"\"\"Test saferepr() when both __getattribute__ and __repr__ raise exceptions.\"\"\"\n+    class SomeClass:\n+        def __getattribute__(self, attr):\n+            raise\n+\n+        def __repr__(self):\n+            raise\n+\n+    # This should not raise INTERNALERROR\n+    s = saferepr(SomeClass())\n+    # Should contain the class name or fallback\n+    assert \"SomeClass\" in s or \"<unknown type>\" in s\n+    assert \"0x\" in s  # Should contain hex address",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-7220",
    "model_patch": "diff --git a/src/_pytest/_code/code.py b/src/_pytest/_code/code.py\nindex 7b17d7612..35a8b541f 100644\n--- a/src/_pytest/_code/code.py\n+++ b/src/_pytest/_code/code.py\n@@ -575,6 +575,7 @@ class ExceptionInfo(Generic[_E]):\n         funcargs: bool = False,\n         truncate_locals: bool = True,\n         chain: bool = True,\n+        initialpaths: Optional[Tuple[Any, ...]] = None,\n     ) -> Union[\"ReprExceptionInfo\", \"ExceptionChainRepr\"]:\n         \"\"\"\n         Return str()able representation of this exception info.\n@@ -600,6 +601,10 @@ class ExceptionInfo(Generic[_E]):\n \n         :param bool chain: if chained exceptions in Python 3 should be shown.\n \n+        :param initialpaths:\n+            Optional tuple of initial paths for computing relative paths.\n+            This ensures paths remain consistent even if tests change the working directory.\n+\n         .. versionchanged:: 3.9\n \n             Added the ``chain`` parameter.\n@@ -623,6 +628,7 @@ class ExceptionInfo(Generic[_E]):\n             truncate_locals=truncate_locals,\n             chain=chain,\n         )\n+        fmt._initialpaths = initialpaths\n         return fmt.repr_excinfo(self)\n \n     def match(self, regexp: \"Union[str, Pattern]\") -> \"Literal[True]\":\n@@ -656,6 +662,9 @@ class FormattedExcinfo:\n     truncate_locals = attr.ib(type=bool, default=True)\n     chain = attr.ib(type=bool, default=True)\n     astcache = attr.ib(default=attr.Factory(dict), init=False, repr=False)\n+    # The directory where pytest was invoked - used for computing relative paths\n+    # to ensure paths remain consistent even if tests change the working directory.\n+    _initialpaths = attr.ib(type=Optional[Tuple[Any, ...]], default=None, init=False, repr=False)\n \n     def _getindent(self, source: \"Source\") -> int:\n         # figure out indent for given source\n@@ -790,8 +799,17 @@ class FormattedExcinfo:\n \n     def _makepath(self, path):\n         if not self.abspath:\n+            # Use the initial working directory (invocation directory) for computing\n+            # relative paths to ensure paths remain consistent even if tests change\n+            # the working directory via fixtures.\n             try:\n-                np = py.path.local().bestrelpath(path)\n+                if self._initialpaths:\n+                    # Use the first initial path as the base directory for relative paths\n+                    base = self._initialpaths[0]\n+                    np = base.bestrelpath(path)\n+                else:\n+                    # Fallback to current directory if no initial paths available\n+                    np = py.path.local().bestrelpath(path)\n             except OSError:\n                 return path\n             if len(np) < len(str(path)):\ndiff --git a/src/_pytest/config/__init__.py b/src/_pytest/config/__init__.py\nindex bb5034ab1..898eb6037 100644\n--- a/src/_pytest/config/__init__.py\n+++ b/src/_pytest/config/__init__.py\n@@ -897,7 +897,10 @@ class Config:\n         else:\n             style = \"native\"\n         excrepr = excinfo.getrepr(\n-            funcargs=True, showlocals=getattr(option, \"showlocals\", False), style=style\n+            funcargs=True,\n+            showlocals=getattr(option, \"showlocals\", False),\n+            style=style,\n+            initialpaths=self.getinitialnodes(),\n         )\n         res = self.hook.pytest_internalerror(excrepr=excrepr, excinfo=excinfo)\n         if not any(res):\ndiff --git a/src/_pytest/nodes.py b/src/_pytest/nodes.py\nindex 4a79bc861..28128a991 100644\n--- a/src/_pytest/nodes.py\n+++ b/src/_pytest/nodes.py\n@@ -374,6 +374,7 @@ class Node(metaclass=NodeMeta):\n             style=style,\n             tbfilter=False,  # pruned already, or in --fulltrace mode.\n             truncate_locals=truncate_locals,\n+            initialpaths=self.config.getinitialnodes(),\n         )\n \n     def repr_failure(\ndiff --git a/src/_pytest/python.py b/src/_pytest/python.py\nindex 76fccb4a1..635de36fb 100644\n--- a/src/_pytest/python.py\n+++ b/src/_pytest/python.py\n@@ -515,7 +515,11 @@ class Module(nodes.File, PyCollector):\n         try:\n             mod = self.fspath.pyimport(ensuresyspath=importmode)\n         except SyntaxError:\n-            raise self.CollectError(ExceptionInfo.from_current().getrepr(style=\"short\"))\n+            raise self.CollectError(\n+                ExceptionInfo.from_current().getrepr(\n+                    style=\"short\", initialpaths=self.config.getinitialnodes()\n+                )\n+            )\n         except self.fspath.ImportMismatchError as e:\n             raise self.CollectError(\n                 \"import file mismatch:\\n\"\n@@ -531,7 +535,7 @@ class Module(nodes.File, PyCollector):\n             if self.config.getoption(\"verbose\") < 2:\n                 exc_info.traceback = exc_info.traceback.filter(filter_traceback)\n             exc_repr = (\n-                exc_info.getrepr(style=\"short\")\n+                exc_info.getrepr(style=\"short\", initialpaths=self.config.getinitialnodes())\n                 if exc_info.traceback\n                 else exc_info.exconly()\n             )\ndiff --git a/src/_pytest/terminal.py b/src/_pytest/terminal.py\nindex 8ecb5a16b..250fbeda1 100644\n--- a/src/_pytest/terminal.py\n+++ b/src/_pytest/terminal.py\n@@ -754,7 +754,9 @@ class TerminalReporter:\n         self.summary_warnings()\n \n     def pytest_keyboard_interrupt(self, excinfo):\n-        self._keyboardinterrupt_memo = excinfo.getrepr(funcargs=True)\n+        self._keyboardinterrupt_memo = excinfo.getrepr(\n+            funcargs=True, initialpaths=self.config.getinitialnodes()\n+        )\n \n     def pytest_unconfigure(self):\n         if hasattr(self, \"_keyboardinterrupt_memo\"):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-7373",
    "model_patch": "diff --git a/src/_pytest/mark/evaluate.py b/src/_pytest/mark/evaluate.py\nindex 759191668..7bed8084e 100644\n--- a/src/_pytest/mark/evaluate.py\n+++ b/src/_pytest/mark/evaluate.py\n@@ -10,25 +10,7 @@ from typing import Optional\n from ..outcomes import fail\n from ..outcomes import TEST_OUTCOME\n from .structures import Mark\n-from _pytest.config import Config\n from _pytest.nodes import Item\n-from _pytest.store import StoreKey\n-\n-\n-evalcache_key = StoreKey[Dict[str, Any]]()\n-\n-\n-def cached_eval(config: Config, expr: str, d: Dict[str, object]) -> Any:\n-    default = {}  # type: Dict[str, object]\n-    evalcache = config._store.setdefault(evalcache_key, default)\n-    try:\n-        return evalcache[expr]\n-    except KeyError:\n-        import _pytest._code\n-\n-        exprcode = _pytest._code.compile(expr, mode=\"eval\")\n-        evalcache[expr] = x = eval(exprcode, d)\n-        return x\n \n \n class MarkEvaluator:\n@@ -98,7 +80,10 @@ class MarkEvaluator:\n                     self.expr = expr\n                     if isinstance(expr, str):\n                         d = self._getglobals()\n-                        result = cached_eval(self.item.config, expr, d)\n+                        import _pytest._code\n+\n+                        exprcode = _pytest._code.compile(expr, mode=\"eval\")\n+                        result = eval(exprcode, d)\n                     else:\n                         if \"reason\" not in mark.kwargs:\n                             # XXX better be checked at collection time",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-7432",
    "model_patch": "diff --git a/src/_pytest/skipping.py b/src/_pytest/skipping.py\nindex 7bd975e5a..a3c9d53b4 100644\n--- a/src/_pytest/skipping.py\n+++ b/src/_pytest/skipping.py\n@@ -270,29 +270,29 @@ def pytest_runtest_makereport(item: Item, call: CallInfo[None]):\n         else:\n             rep.longrepr = \"Unexpected success\"\n         rep.outcome = \"failed\"\n-    elif item.config.option.runxfail:\n-        pass  # don't interfere\n-    elif call.excinfo and isinstance(call.excinfo.value, xfail.Exception):\n-        assert call.excinfo.value.msg is not None\n-        rep.wasxfail = \"reason: \" + call.excinfo.value.msg\n-        rep.outcome = \"skipped\"\n-    elif not rep.skipped and xfailed:\n-        if call.excinfo:\n-            raises = xfailed.raises\n-            if raises is not None and not isinstance(call.excinfo.value, raises):\n-                rep.outcome = \"failed\"\n-            else:\n-                rep.outcome = \"skipped\"\n-                rep.wasxfail = xfailed.reason\n-        elif call.when == \"call\":\n-            if xfailed.strict:\n-                rep.outcome = \"failed\"\n-                rep.longrepr = \"[XPASS(strict)] \" + xfailed.reason\n-            else:\n-                rep.outcome = \"passed\"\n-                rep.wasxfail = xfailed.reason\n-    elif (\n-        item._store.get(skipped_by_mark_key, True)\n+    elif not item.config.option.runxfail:\n+        if call.excinfo and isinstance(call.excinfo.value, xfail.Exception):\n+            assert call.excinfo.value.msg is not None\n+            rep.wasxfail = \"reason: \" + call.excinfo.value.msg\n+            rep.outcome = \"skipped\"\n+        elif not rep.skipped and xfailed:\n+            if call.excinfo:\n+                raises = xfailed.raises\n+                if raises is not None and not isinstance(call.excinfo.value, raises):\n+                    rep.outcome = \"failed\"\n+                else:\n+                    rep.outcome = \"skipped\"\n+                    rep.wasxfail = xfailed.reason\n+            elif call.when == \"call\":\n+                if xfailed.strict:\n+                    rep.outcome = \"failed\"\n+                    rep.longrepr = \"[XPASS(strict)] \" + xfailed.reason\n+                else:\n+                    rep.outcome = \"passed\"\n+                    rep.wasxfail = xfailed.reason\n+\n+    if (\n+        item._store.get(skipped_by_mark_key, False)\n         and rep.skipped\n         and type(rep.longrepr) is tuple\n     ):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-7490",
    "model_patch": "diff --git a/src/_pytest/skipping.py b/src/_pytest/skipping.py\nindex 335e10996..11a82ba2d 100644\n--- a/src/_pytest/skipping.py\n+++ b/src/_pytest/skipping.py\n@@ -238,10 +238,9 @@ def pytest_runtest_setup(item: Item) -> None:\n         item._store[skipped_by_mark_key] = True\n         skip(skipped.reason)\n \n-    if not item.config.option.runxfail:\n-        item._store[xfailed_key] = xfailed = evaluate_xfail_marks(item)\n-        if xfailed and not xfailed.run:\n-            xfail(\"[NOTRUN] \" + xfailed.reason)\n+    item._store[xfailed_key] = xfailed = evaluate_xfail_marks(item)\n+    if xfailed and not item.config.option.runxfail and not xfailed.run:\n+        xfail(\"[NOTRUN] \" + xfailed.reason)\n \n \n @hookimpl(hookwrapper=True)\n@@ -250,12 +249,16 @@ def pytest_runtest_call(item: Item) -> Generator[None, None, None]:\n     if xfailed is None:\n         item._store[xfailed_key] = xfailed = evaluate_xfail_marks(item)\n \n-    if not item.config.option.runxfail:\n-        if xfailed and not xfailed.run:\n-            xfail(\"[NOTRUN] \" + xfailed.reason)\n+    if xfailed and not item.config.option.runxfail and not xfailed.run:\n+        xfail(\"[NOTRUN] \" + xfailed.reason)\n \n     yield\n \n+    # The test run may have added an xfail mark dynamically.\n+    xfailed = item._store.get(xfailed_key, None)\n+    if xfailed is None:\n+        item._store[xfailed_key] = xfailed = evaluate_xfail_marks(item)\n+\n \n @hookimpl(hookwrapper=True)\n def pytest_runtest_makereport(item: Item, call: CallInfo[None]):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-8365",
    "model_patch": "diff --git a/src/_pytest/tmpdir.py b/src/_pytest/tmpdir.py\nindex 29c7e19d7..038b724b7 100644\n--- a/src/_pytest/tmpdir.py\n+++ b/src/_pytest/tmpdir.py\n@@ -154,7 +154,12 @@ def get_user() -> Optional[str]:\n     import getpass\n \n     try:\n-        return getpass.getuser()\n+        # Sanitize the username to only include characters valid for\n+        # directory names (#8365).\n+        user = getpass.getuser()\n+        # Replace any character that is not alphanumeric or underscore with underscore\n+        user = re.sub(r\"[^\\w]\", \"_\", user)\n+        return user\n     except (ImportError, KeyError):\n         return None\n \ndiff --git a/testing/test_tmpdir.py b/testing/test_tmpdir.py\nindex d123287aa..1c01617dd 100644\n--- a/testing/test_tmpdir.py\n+++ b/testing/test_tmpdir.py\n@@ -246,6 +246,32 @@ def test_get_user(monkeypatch):\n     assert get_user() is None\n \n \n+def test_get_user_with_illegal_characters(monkeypatch, tmp_path):\n+    \"\"\"Test that get_user() sanitizes usernames with illegal characters (#8365).\"\"\"\n+    # Mock getpass.getuser to return a username with illegal characters\n+    import getpass\n+\n+    # Test with a domain username like \"contoso\\john_doe\"\n+    monkeypatch.setattr(getpass, \"getuser\", lambda: \"contoso\\\\john_doe\")\n+    assert get_user() == \"contoso_john_doe\"\n+\n+    # Test with other illegal characters\n+    monkeypatch.setattr(getpass, \"getuser\", lambda: \"user/name:with*illegal?chars\")\n+    assert get_user() == \"user_name_with_illegal_chars\"\n+\n+    # Test that valid usernames are unchanged\n+    monkeypatch.setattr(getpass, \"getuser\", lambda: \"john_doe\")\n+    assert get_user() == \"john_doe\"\n+\n+    # Test that the sanitized username can be used to create a directory\n+    monkeypatch.setattr(getpass, \"getuser\", lambda: \"contoso\\\\john_doe\")\n+    config = cast(Config, FakeConfig(tmp_path))\n+    t = TempPathFactory.from_config(config, _ispytest=True)\n+    # This should not raise an error\n+    basetemp = t.getbasetemp()\n+    assert basetemp.exists()\n+\n+\n class TestNumberedDir:\n     PREFIX = \"fun-\"",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-8906",
    "model_patch": "diff --git a/src/_pytest/python.py b/src/_pytest/python.py\nindex 79dfb7320..0d0729c86 100644\n--- a/src/_pytest/python.py\n+++ b/src/_pytest/python.py\n@@ -610,8 +610,9 @@ class Module(nodes.File, PyCollector):\n             raise self.CollectError(\n                 \"Using pytest.skip outside of a test is not allowed. \"\n                 \"To decorate a test function, use the @pytest.mark.skip \"\n-                \"or @pytest.mark.skipif decorators instead, and to skip a \"\n-                \"module use `pytestmark = pytest.mark.{skip,skipif}.\"\n+                \"or @pytest.mark.skipif decorators instead. \"\n+                \"To skip a module, use `pytest.skip(..., allow_module_level=True)` \"\n+                \"or `pytestmark = pytest.mark.{skip,skipif}.\"\n             ) from e\n         self.config.pluginmanager.consider_module(mod)\n         return mod",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-9359",
    "model_patch": "diff --git a/src/_pytest/_code/source.py b/src/_pytest/_code/source.py\nindex 6f54057c0..53c941eda 100644\n--- a/src/_pytest/_code/source.py\n+++ b/src/_pytest/_code/source.py\n@@ -149,7 +149,20 @@ def get_statement_startend2(lineno: int, node: ast.AST) -> Tuple[int, Optional[i\n     values: List[int] = []\n     for x in ast.walk(node):\n         if isinstance(x, (ast.stmt, ast.ExceptHandler)):\n-            values.append(x.lineno - 1)\n+            # For functions, async functions, and classes with decorators,\n+            # the lineno points to the first decorator in Python 3.9.0-3.9.4.\n+            # We need to use the line of the actual definition instead.\n+            if isinstance(x, (ast.FunctionDef, ast.AsyncFunctionDef, ast.ClassDef)):\n+                if x.decorator_list:\n+                    # Use the line of the first decorator (1-indexed).\n+                    # This ensures that decorators are not included in the\n+                    # statement range of the previous statement.\n+                    # Convert to 0-indexed by subtracting 1.\n+                    values.append(x.decorator_list[0].lineno - 1)\n+                else:\n+                    values.append(x.lineno - 1)\n+            else:\n+                values.append(x.lineno - 1)\n             for name in (\"finalbody\", \"orelse\"):\n                 val: Optional[List[ast.stmt]] = getattr(x, name, None)\n                 if val:",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-10297",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-10508",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-10949",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-11040",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-11281",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-12471",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-13142",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-13241",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-13439",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-13496",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-13497",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-13584",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-13779",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-14087",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-14092",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-14894",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-14983",
    "model_patch": "diff --git a/sklearn/model_selection/_split.py b/sklearn/model_selection/_split.py\nindex c49a3ce6ae..bfd30dae5a 100644\n--- a/sklearn/model_selection/_split.py\n+++ b/sklearn/model_selection/_split.py\n@@ -1163,6 +1163,9 @@ class _RepeatedSplits(metaclass=ABCMeta):\n                      **self.cvargs)\n         return cv.get_n_splits(X, y, groups) * self.n_repeats\n \n+    def __repr__(self):\n+        return _build_repr(self)\n+\n \n class RepeatedKFold(_RepeatedSplits):\n     \"\"\"Repeated K-Fold cross validator.",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-15512",
    "model_patch": "diff --git a/sklearn/cluster/_affinity_propagation.py b/sklearn/cluster/_affinity_propagation.py\nindex 4806afee90..26bd25490d 100644\n--- a/sklearn/cluster/_affinity_propagation.py\n+++ b/sklearn/cluster/_affinity_propagation.py\n@@ -151,6 +151,7 @@ def affinity_propagation(S, preference=None, convergence_iter=15, max_iter=200,\n     e = np.zeros((n_samples, convergence_iter))\n \n     ind = np.arange(n_samples)\n+    converged = False\n \n     for it in range(max_iter):\n         # tmp = A + S; compute responsibilities\n@@ -193,10 +194,14 @@ def affinity_propagation(S, preference=None, convergence_iter=15, max_iter=200,\n             se = np.sum(e, axis=1)\n             unconverged = (np.sum((se == convergence_iter) + (se == 0))\n                            != n_samples)\n-            if (not unconverged and (K > 0)) or (it == max_iter):\n+            if (not unconverged and (K > 0)):\n+                converged = True\n                 if verbose:\n                     print(\"Converged after %d iterations.\" % it)\n                 break\n+            elif it == max_iter - 1:\n+                # Reached max_iter without convergence\n+                break\n     else:\n         if verbose:\n             print(\"Did not converge\")\n@@ -204,7 +209,7 @@ def affinity_propagation(S, preference=None, convergence_iter=15, max_iter=200,\n     I = np.flatnonzero(E)\n     K = I.size  # Identify exemplars\n \n-    if K > 0:\n+    if K > 0 and converged:\n         c = np.argmax(S[:, I], axis=1)\n         c[I] = np.arange(K)  # Identify clusters\n         # Refine the final set of exemplars and clusters and return results",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-15535",
    "model_patch": "diff --git a/sklearn/metrics/cluster/_supervised.py b/sklearn/metrics/cluster/_supervised.py\nindex 4bddae35c9..869237f566 100644\n--- a/sklearn/metrics/cluster/_supervised.py\n+++ b/sklearn/metrics/cluster/_supervised.py\n@@ -43,10 +43,10 @@ def check_clusterings(labels_true, labels_pred):\n         The predicted labels.\n     \"\"\"\n     labels_true = check_array(\n-        labels_true, ensure_2d=False, ensure_min_samples=0\n+        labels_true, ensure_2d=False, ensure_min_samples=0, dtype=None\n     )\n     labels_pred = check_array(\n-        labels_pred, ensure_2d=False, ensure_min_samples=0\n+        labels_pred, ensure_2d=False, ensure_min_samples=0, dtype=None\n     )\n \n     # input checks",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-25500",
    "model_patch": "diff --git a/sklearn/calibration.py b/sklearn/calibration.py\nindex 2c4a33616d..34aadd2e9b 100644\n--- a/sklearn/calibration.py\n+++ b/sklearn/calibration.py\n@@ -760,7 +760,7 @@ class _CalibratedClassifier:\n                 # When binary, `predictions` consists only of predictions for\n                 # clf.classes_[1] but `pos_class_indices` = 0\n                 class_idx += 1\n-            proba[:, class_idx] = calibrator.predict(this_pred)\n+            proba[:, class_idx] = np.asarray(calibrator.predict(this_pred)).ravel()\n \n         # Normalize the probabilities\n         if n_classes == 2:",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-25570",
    "model_patch": "diff --git a/sklearn/compose/_column_transformer.py b/sklearn/compose/_column_transformer.py\nindex a261451177..52e653222a 100644\n--- a/sklearn/compose/_column_transformer.py\n+++ b/sklearn/compose/_column_transformer.py\n@@ -381,18 +381,18 @@ class ColumnTransformer(TransformerMixin, _BaseComposition):\n         output_config = _get_output_config(\"transform\", self)\n         for name, trans, columns in transformers:\n             if replace_strings:\n-                # replace 'passthrough' with identity transformer and\n-                # skip in case of 'drop'\n+                # skip in case of 'drop' or empty column selection\n+                if trans == \"drop\":\n+                    continue\n+                if _is_empty_column_selection(columns):\n+                    continue\n+                # replace 'passthrough' with identity transformer\n                 if trans == \"passthrough\":\n                     trans = FunctionTransformer(\n                         accept_sparse=True,\n                         check_inverse=False,\n                         feature_names_out=\"one-to-one\",\n                     ).set_output(transform=output_config[\"dense\"])\n-                elif trans == \"drop\":\n-                    continue\n-                elif _is_empty_column_selection(columns):\n-                    continue\n \n             if column_as_strings:\n                 # Convert all columns to using their string labels",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-25638",
    "model_patch": "diff --git a/sklearn/utils/multiclass.py b/sklearn/utils/multiclass.py\nindex 5eaef2fde8..bdf74667ba 100644\n--- a/sklearn/utils/multiclass.py\n+++ b/sklearn/utils/multiclass.py\n@@ -340,9 +340,24 @@ def type_of_target(y, input_name=\"\"):\n             return \"binary\"  # []\n         # 2-D empty array: [[]]\n         return \"unknown\"\n-    if not issparse(y) and y.dtype == object and not isinstance(y.flat[0], str):\n-        # [obj_1] and not [\"label_1\"]\n-        return \"unknown\"\n+    if not issparse(y) and y.dtype == object:\n+        if not isinstance(y.flat[0], str):\n+            # Check if this is a pandas nullable dtype array with numeric/boolean values\n+            # Try to infer the appropriate dtype by checking if all elements are numeric\n+            try:\n+                # Try to convert to float - this will work for numeric values from nullable dtypes\n+                y_converted = xp.asarray(y, dtype=float)\n+                # Check if the conversion preserved the data (not all NaN)\n+                if not xp.all(xp.isnan(y_converted)):\n+                    # Conversion successful - use the converted array\n+                    y = y_converted\n+            except (TypeError, ValueError):\n+                # Conversion failed - these are actual objects, not numeric\n+                pass\n+\n+        if y.dtype == object:\n+            # [obj_1] and not [\"label_1\"]\n+            return \"unknown\"\n \n     # Check if multioutput\n     if y.ndim == 2 and y.shape[1] > 1:",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "scikit-learn__scikit-learn-25747",
    "model_patch": "diff --git a/sklearn/utils/_set_output.py b/sklearn/utils/_set_output.py\nindex 335773c6af..bdd917dd9d 100644\n--- a/sklearn/utils/_set_output.py\n+++ b/sklearn/utils/_set_output.py\n@@ -55,7 +55,7 @@ def _wrap_in_pandas_container(\n     if isinstance(data_to_wrap, pd.DataFrame):\n         if columns is not None:\n             data_to_wrap.columns = columns\n-        if index is not None:\n+        if index is not None and len(data_to_wrap.index) == len(index):\n             data_to_wrap.index = index\n         return data_to_wrap",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sphinx-doc__sphinx-10325",
    "model_patch": "diff --git a/sphinx/ext/autodoc/__init__.py b/sphinx/ext/autodoc/__init__.py\nindex 62631f7ff..d1a83ed69 100644\n--- a/sphinx/ext/autodoc/__init__.py\n+++ b/sphinx/ext/autodoc/__init__.py\n@@ -109,12 +109,12 @@ def exclude_members_option(arg: Any) -> Union[object, Set[str]]:\n     return {x.strip() for x in arg.split(',') if x.strip()}\n \n \n-def inherited_members_option(arg: Any) -> Union[object, Set[str]]:\n-    \"\"\"Used to convert the :members: option to auto directives.\"\"\"\n+def inherited_members_option(arg: Any) -> Union[object, List[str]]:\n+    \"\"\"Used to convert the :inherited-members: option to auto directives.\"\"\"\n     if arg in (None, True):\n-        return 'object'\n+        return ['object']\n     else:\n-        return arg\n+        return [x.strip() for x in arg.split(',') if x.strip()]\n \n \n def member_order_option(arg: Any) -> Optional[str]:\n@@ -682,7 +682,7 @@ class Documenter:\n         def is_filtered_inherited_member(name: str, obj: Any) -> bool:\n             if inspect.isclass(self.object):\n                 for cls in self.object.__mro__:\n-                    if cls.__name__ == self.options.inherited_members and cls != self.object:\n+                    if cls.__name__ in self.options.inherited_members and cls != self.object:\n                         # given member is a member of specified *super class*\n                         return True\n                     elif name in cls.__dict__:",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sphinx-doc__sphinx-10451",
    "model_patch": "diff --git a/sphinx/ext/autodoc/typehints.py b/sphinx/ext/autodoc/typehints.py\nindex d912cd7d5..39878b5e1 100644\n--- a/sphinx/ext/autodoc/typehints.py\n+++ b/sphinx/ext/autodoc/typehints.py\n@@ -115,7 +115,15 @@ def modify_field_list(node: nodes.field_list, annotations: Dict[str, str],\n         if name == 'return':\n             continue\n \n+        # Check if this parameter is already documented, handling *args and **kwargs\n+        # The annotations dict uses 'args' and 'kwargs' (without * and **)\n+        # but docstrings may use '*args' and '**kwargs'\n         arg = arguments.get(name, {})\n+        if name == 'args' and '*args' in arguments:\n+            arg = arguments['*args']\n+        elif name == 'kwargs' and '**kwargs' in arguments:\n+            arg = arguments['**kwargs']\n+\n         if not arg.get('type'):\n             field = nodes.field()\n             field += nodes.field_name('', 'type ' + name)\n@@ -170,7 +178,17 @@ def augment_descriptions_with_types(\n     for name in annotations:\n         if name in ('return', 'returns'):\n             continue\n-        if name in has_description and name not in has_type:\n+\n+        # Check if the parameter has a description, handling *args and **kwargs\n+        # The annotations dict uses 'args' and 'kwargs' (without * and **)\n+        # but docstrings may use '*args' and '**kwargs'\n+        has_param_description = (\n+            name in has_description or\n+            (name == 'args' and '*args' in has_description) or\n+            (name == 'kwargs' and '**kwargs' in has_description)\n+        )\n+\n+        if has_param_description and name not in has_type:\n             field = nodes.field()\n             field += nodes.field_name('', 'type ' + name)\n             field += nodes.field_body('', nodes.paragraph('', annotations[name]))\ndiff --git a/tests/roots/test-ext-autodoc/target/typehints.py b/tests/roots/test-ext-autodoc/target/typehints.py\nindex 6b0d6142c..d04a2e2b8 100644\n--- a/tests/roots/test-ext-autodoc/target/typehints.py\n+++ b/tests/roots/test-ext-autodoc/target/typehints.py\n@@ -99,3 +99,15 @@ class _ClassWithDocumentedInit:\n \n         :param x: Some integer\n         \"\"\"\n+\n+\n+class _ClassWithDocumentedInitAndStarArgs:\n+    \"\"\"Class docstring.\"\"\"\n+\n+    def __init__(self, x: int, *args: int, **kwargs: int) -> None:\n+        \"\"\"Init docstring.\n+\n+        :param x: Some integer\n+        :param *args: Some integer\n+        :param **kwargs: Some integer\n+        \"\"\"\ndiff --git a/tests/test_ext_autodoc_configs.py b/tests/test_ext_autodoc_configs.py\nindex c075a8e2d..847b70f07 100644\n--- a/tests/test_ext_autodoc_configs.py\n+++ b/tests/test_ext_autodoc_configs.py\n@@ -1108,6 +1108,53 @@ def test_autodoc_typehints_description_for_invalid_node(app):\n     restructuredtext.parse(app, text)  # raises no error\n \n \n+@pytest.mark.sphinx('text', testroot='ext-autodoc',\n+                    confoverrides={'autodoc_typehints': \"description\"})\n+def test_autodoc_typehints_description_with_star_args(app):\n+    \"\"\"Test that *args and **kwargs are not duplicated when documented.\"\"\"\n+    (app.srcdir / 'index.rst').write_text(\n+        '.. autoclass:: target.typehints._ClassWithDocumentedInitAndStarArgs\\n'\n+        '   :special-members: __init__\\n',\n+        encoding='utf8'\n+    )\n+    app.build()\n+    context = (app.outdir / 'index.txt').read_text(encoding='utf8')\n+    # Check that *args and **kwargs appear with their types, not duplicated\n+    assert ('class target.typehints._ClassWithDocumentedInitAndStarArgs(x, *args, **kwargs)\\n'\n+            '\\n'\n+            '   Class docstring.\\n'\n+            '\\n'\n+            '   Parameters:\\n'\n+            '      **x** (*int*) --\\n'\n+            '\\n'\n+            '      ***args** (*int*) --\\n'\n+            '\\n'\n+            '      ****kwargs** (*int*) --\\n'\n+            '\\n'\n+            '   Return type:\\n'\n+            '      None\\n'\n+            '\\n'\n+            '   __init__(x, *args, **kwargs)\\n'\n+            '\\n'\n+            '      Init docstring.\\n'\n+            '\\n'\n+            '      Parameters:\\n'\n+            '         **x** (*int*) -- Some integer\\n'\n+            '\\n'\n+            '         ***args** (*int*) --\\n'\n+            '\\n'\n+            '            Some integer\\n'\n+            '\\n'\n+            '         ****kwargs** (*int*) --\\n'\n+            '\\n'\n+            '            Some integer\\n'\n+            '\\n'\n+            '      Return type:\\n'\n+            '         None\\n' == context)\n+    # Ensure no duplication (e.g., both '**args**' and '***args**' should not appear)\n+    assert '**args** (*int*) --\\n' not in context  # Should be ***args**, not **args**\n+\n+\n @pytest.mark.sphinx('text', testroot='ext-autodoc',\n                     confoverrides={'autodoc_typehints': \"both\"})\n def test_autodoc_typehints_both(app):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sphinx-doc__sphinx-11445",
    "model_patch": "diff --git a/sphinx/util/rst.py b/sphinx/util/rst.py\nindex 7a1538325..fe3ab99cf 100644\n--- a/sphinx/util/rst.py\n+++ b/sphinx/util/rst.py\n@@ -25,7 +25,7 @@ except ImportError:\n \n logger = logging.getLogger(__name__)\n \n-docinfo_re = re.compile(':\\\\w+:.*?')\n+docinfo_re = re.compile(r'^:\\w+:.*$')\n symbols_re = re.compile(r'([!-\\-/:-@\\[-`{-~])')  # symbols without dot(0x2e)\n SECTIONING_CHARS = ['=', '-', '~']\n \n@@ -80,7 +80,7 @@ def prepend_prolog(content: StringList, prolog: str) -> None:\n     if prolog:\n         pos = 0\n         for line in content:\n-            if docinfo_re.match(line):\n+            if docinfo_re.match(line) and '`' not in line:\n                 pos += 1\n             else:\n                 break\ndiff --git a/tests/test_util_rst.py b/tests/test_util_rst.py\nindex 40a2ee68b..12e1cb77a 100644\n--- a/tests/test_util_rst.py\n+++ b/tests/test_util_rst.py\n@@ -78,6 +78,33 @@ def test_prepend_prolog_without_CR(app):\n                                       ('dummy.rst', 1, 'Sphinx is a document generator')]\n \n \n+def test_prepend_prolog_with_domain_directive_heading(app):\n+    # Test that domain directive headings are not treated as docinfo\n+    # This is a regression test for issue #11445\n+    prolog = '.. |psf| replace:: Python Software Foundation\\n'\n+    content = StringList([':mod:`mypackage2`',\n+                          '=================',\n+                          '',\n+                          'Content',\n+                          '',\n+                          'Subheading',\n+                          '----------'],\n+                         'mypackage.rst')\n+    prepend_prolog(content, prolog)\n+\n+    # The prolog should be inserted at the beginning, NOT after the heading\n+    # The heading and its underline must remain consecutive\n+    assert list(content.xitems()) == [('<rst_prolog>', 0, '.. |psf| replace:: Python Software Foundation'),\n+                                      ('<generated>', 0, ''),\n+                                      ('mypackage.rst', 0, ':mod:`mypackage2`'),\n+                                      ('mypackage.rst', 1, '================='),\n+                                      ('mypackage.rst', 2, ''),\n+                                      ('mypackage.rst', 3, 'Content'),\n+                                      ('mypackage.rst', 4, ''),\n+                                      ('mypackage.rst', 5, 'Subheading'),\n+                                      ('mypackage.rst', 6, '----------')]\n+\n+\n def test_textwidth():\n     assert textwidth('Hello') == 5\n     assert textwidth('\u0440\u0443\u0441\u0441\u043a\u0438\u0439 \u044f\u0437\u044b\u043a') == 12",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sphinx-doc__sphinx-7686",
    "model_patch": "diff --git a/sphinx/ext/autosummary/generate.py b/sphinx/ext/autosummary/generate.py\nindex a57c73fb7..d498275ea 100644\n--- a/sphinx/ext/autosummary/generate.py\n+++ b/sphinx/ext/autosummary/generate.py\n@@ -246,7 +246,13 @@ def generate_autosummary_content(name: str, obj: Any, parent: Any,\n     ns.update(context)\n \n     if doc.objtype == 'module':\n-        ns['members'] = dir(obj)\n+        # Filter members based on imported_members setting\n+        if imported_members:\n+            ns['members'] = dir(obj)\n+        else:\n+            # Only include members that are defined in this module\n+            ns['members'] = [name for name in dir(obj)\n+                            if getattr(safe_getattr(obj, name, None), '__module__', None) == obj.__name__]\n         ns['functions'], ns['all_functions'] = \\\n             get_members(obj, {'function'}, imported=imported_members)\n         ns['classes'], ns['all_classes'] = \\",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sphinx-doc__sphinx-7738",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sphinx-doc__sphinx-7975",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sphinx-doc__sphinx-8273",
    "model_patch": "diff --git a/sphinx/builders/manpage.py b/sphinx/builders/manpage.py\nindex 4166dece9..d8c093c8f 100644\n--- a/sphinx/builders/manpage.py\n+++ b/sphinx/builders/manpage.py\n@@ -8,6 +8,7 @@\n     :license: BSD, see LICENSE for details.\n \"\"\"\n \n+import os\n from os import path\n from typing import Any, Dict, List, Set, Tuple, Union\n \n@@ -82,8 +83,13 @@ class ManualPageBuilder(Builder):\n \n             targetname = '%s.%s' % (name, section)\n             logger.info(darkgreen(targetname) + ' { ', nonl=True)\n+\n+            # Create section subdirectory (e.g., man1, man3, etc.)\n+            sectiondir = path.join(self.outdir, 'man%s' % section)\n+            if not path.exists(sectiondir):\n+                os.makedirs(sectiondir)\n             destination = FileOutput(\n-                destination_path=path.join(self.outdir, targetname),\n+                destination_path=path.join(sectiondir, targetname),\n                 encoding='utf-8')\n \n             tree = self.env.get_doctree(docname)\ndiff --git a/tests/test_build_manpage.py b/tests/test_build_manpage.py\nindex c3c41a2ae..6cc7cdb39 100644\n--- a/tests/test_build_manpage.py\n+++ b/tests/test_build_manpage.py\n@@ -17,9 +17,9 @@ from sphinx.config import Config\n @pytest.mark.sphinx('man')\n def test_all(app, status, warning):\n     app.builder.build_all()\n-    assert (app.outdir / 'sphinxtests.1').exists()\n+    assert (app.outdir / 'man1' / 'sphinxtests.1').exists()\n \n-    content = (app.outdir / 'sphinxtests.1').read_text()\n+    content = (app.outdir / 'man1' / 'sphinxtests.1').read_text()\n     assert r'\\fBprint \\fP\\fIi\\fP\\fB\\en\\fP' in content\n     assert r'\\fBmanpage\\en\\fP' in content\n \n@@ -33,7 +33,7 @@ def test_all(app, status, warning):\n @pytest.mark.sphinx('man', testroot='directive-code')\n def test_captioned_code_block(app, status, warning):\n     app.builder.build_all()\n-    content = (app.outdir / 'python.1').read_text()\n+    content = (app.outdir / 'man1' / 'python.1').read_text()\n \n     assert ('.sp\\n'\n             'caption \\\\fItest\\\\fP rb\\n'\n@@ -64,5 +64,5 @@ def test_default_man_pages():\n @pytest.mark.sphinx('man', testroot='markup-rubric')\n def test_rubric(app, status, warning):\n     app.build()\n-    content = (app.outdir / 'python.1').read_text()\n+    content = (app.outdir / 'man1' / 'python.1').read_text()\n     assert 'This is a rubric\\n' in content\ndiff --git a/tests/test_smartquotes.py b/tests/test_smartquotes.py\nindex 6276e6a74..f3a889468 100644\n--- a/tests/test_smartquotes.py\n+++ b/tests/test_smartquotes.py\n@@ -33,7 +33,7 @@ def test_text_builder(app, status, warning):\n def test_man_builder(app, status, warning):\n     app.build()\n \n-    content = (app.outdir / 'python.1').read_text()\n+    content = (app.outdir / 'man1' / 'python.1').read_text()\n     assert '\\\\-\\\\- \"Sphinx\" is a tool that makes it easy ...' in content\n \n \n@@ -88,5 +88,5 @@ def test_smartquotes_excludes_language(app, status, warning):\n def test_smartquotes_excludes_builders(app, status, warning):\n     app.build()\n \n-    content = (app.outdir / 'python.1').read_text()\n+    content = (app.outdir / 'man1' / 'python.1').read_text()\n     assert '\u2013 \u201cSphinx\u201d is a tool that makes it easy \u2026' in content",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sphinx-doc__sphinx-8282",
    "model_patch": "diff --git a/sphinx/ext/autodoc/__init__.py b/sphinx/ext/autodoc/__init__.py\nindex 978fd5df8..baf631aea 100644\n--- a/sphinx/ext/autodoc/__init__.py\n+++ b/sphinx/ext/autodoc/__init__.py\n@@ -1266,6 +1266,9 @@ class FunctionDocumenter(DocstringSignatureMixin, ModuleLevelDocumenter):  # typ\n                 overload = evaluate_signature(overload, __globals__,\n                                               self.env.config.autodoc_type_aliases)\n \n+                if self.env.config.autodoc_typehints in ('none', 'description'):\n+                    kwargs.setdefault('show_annotation', False)\n+\n                 sig = stringify_signature(overload, **kwargs)\n                 sigs.append(sig)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sphinx-doc__sphinx-8435",
    "model_patch": "diff --git a/sphinx/ext/autodoc/__init__.py b/sphinx/ext/autodoc/__init__.py\nindex 171a3e7b0..5c958ad05 100644\n--- a/sphinx/ext/autodoc/__init__.py\n+++ b/sphinx/ext/autodoc/__init__.py\n@@ -1702,7 +1702,7 @@ class DataDocumenter(ModuleLevelDocumenter):\n         if not self.options.annotation:\n             # obtain annotation for this data\n             try:\n-                annotations = get_type_hints(self.parent)\n+                annotations = get_type_hints(self.parent, None, self.config.autodoc_type_aliases)\n             except NameError:\n                 # Failed to evaluate ForwardRef (maybe TYPE_CHECKING)\n                 annotations = safe_getattr(self.parent, '__annotations__', {})\n@@ -2093,7 +2093,7 @@ class AttributeDocumenter(DocstringStripSignatureMixin, ClassLevelDocumenter):\n         if not self.options.annotation:\n             # obtain type annotation for this attribute\n             try:\n-                annotations = get_type_hints(self.parent)\n+                annotations = get_type_hints(self.parent, None, self.config.autodoc_type_aliases)\n             except NameError:\n                 # Failed to evaluate ForwardRef (maybe TYPE_CHECKING)\n                 annotations = safe_getattr(self.parent, '__annotations__', {})",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sphinx-doc__sphinx-8474",
    "model_patch": "diff --git a/sphinx/domains/std.py b/sphinx/domains/std.py\nindex 4bde57930..8d4857888 100644\n--- a/sphinx/domains/std.py\n+++ b/sphinx/domains/std.py\n@@ -852,8 +852,9 @@ class StandardDomain(Domain):\n             if fignumber is None:\n                 return contnode\n         except ValueError:\n-            logger.warning(__(\"no number is assigned for %s: %s\"), figtype, labelid,\n-                           location=node)\n+            logger.warning(__(\"Failed to create a cross reference. Any number is not \"\n+                              \"assigned: %s\"),\n+                           labelid, location=node)\n             return contnode\n \n         try:\ndiff --git a/tests/test_build_html.py b/tests/test_build_html.py\nindex 6b66a2c67..42de6f356 100644\n--- a/tests/test_build_html.py\n+++ b/tests/test_build_html.py\n@@ -660,7 +660,7 @@ def test_numfig_without_numbered_toctree_warn(app, warning):\n \n     warnings = warning.getvalue()\n     assert 'index.rst:47: WARNING: numfig is disabled. :numref: is ignored.' not in warnings\n-    assert 'index.rst:55: WARNING: no number is assigned for section: index' in warnings\n+    assert 'index.rst:55: WARNING: Failed to create a cross reference. Any number is not assigned: index' in warnings\n     assert 'index.rst:56: WARNING: invalid numfig_format: invalid' in warnings\n     assert 'index.rst:57: WARNING: invalid numfig_format: Fig %s %s' in warnings\n \n@@ -768,7 +768,7 @@ def test_numfig_with_numbered_toctree_warn(app, warning):\n     app.build()\n     warnings = warning.getvalue()\n     assert 'index.rst:47: WARNING: numfig is disabled. :numref: is ignored.' not in warnings\n-    assert 'index.rst:55: WARNING: no number is assigned for section: index' in warnings\n+    assert 'index.rst:55: WARNING: Failed to create a cross reference. Any number is not assigned: index' in warnings\n     assert 'index.rst:56: WARNING: invalid numfig_format: invalid' in warnings\n     assert 'index.rst:57: WARNING: invalid numfig_format: Fig %s %s' in warnings\n \n@@ -873,7 +873,7 @@ def test_numfig_with_prefix_warn(app, warning):\n     app.build()\n     warnings = warning.getvalue()\n     assert 'index.rst:47: WARNING: numfig is disabled. :numref: is ignored.' not in warnings\n-    assert 'index.rst:55: WARNING: no number is assigned for section: index' in warnings\n+    assert 'index.rst:55: WARNING: Failed to create a cross reference. Any number is not assigned: index' in warnings\n     assert 'index.rst:56: WARNING: invalid numfig_format: invalid' in warnings\n     assert 'index.rst:57: WARNING: invalid numfig_format: Fig %s %s' in warnings\n \n@@ -979,7 +979,7 @@ def test_numfig_with_secnum_depth_warn(app, warning):\n     app.build()\n     warnings = warning.getvalue()\n     assert 'index.rst:47: WARNING: numfig is disabled. :numref: is ignored.' not in warnings\n-    assert 'index.rst:55: WARNING: no number is assigned for section: index' in warnings\n+    assert 'index.rst:55: WARNING: Failed to create a cross reference. Any number is not assigned: index' in warnings\n     assert 'index.rst:56: WARNING: invalid numfig_format: invalid' in warnings\n     assert 'index.rst:57: WARNING: invalid numfig_format: Fig %s %s' in warnings",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sphinx-doc__sphinx-8506",
    "model_patch": "diff --git a/sphinx/domains/std.py b/sphinx/domains/std.py\nindex c87217c56..6cacfc4e8 100644\n--- a/sphinx/domains/std.py\n+++ b/sphinx/domains/std.py\n@@ -43,7 +43,7 @@ logger = logging.getLogger(__name__)\n \n \n # RE for option descriptions\n-option_desc_re = re.compile(r'((?:/|--|-|\\+)?[^\\s=[]+)(=?\\s*.*)')\n+option_desc_re = re.compile(r'((?:/|--|-|\\+)?[^\\s=]+)(=?\\s*.*)')\n # RE for grammar tokens\n token_re = re.compile(r'`(\\w+)`', re.U)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sphinx-doc__sphinx-8595",
    "model_patch": "diff --git a/sphinx/ext/autodoc/__init__.py b/sphinx/ext/autodoc/__init__.py\nindex d85d79617..c9f90acca 100644\n--- a/sphinx/ext/autodoc/__init__.py\n+++ b/sphinx/ext/autodoc/__init__.py\n@@ -1074,7 +1074,7 @@ class ModuleDocumenter(Documenter):\n     def get_object_members(self, want_all: bool) -> Tuple[bool, ObjectMembers]:\n         members = self.get_module_members()\n         if want_all:\n-            if not self.__all__:\n+            if self.__all__ is None:\n                 # for implicit module members, check __module__ to avoid\n                 # documenting imported objects\n                 return True, list(members.values())",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sphinx-doc__sphinx-8627",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sphinx-doc__sphinx-8713",
    "model_patch": "diff --git a/sphinx/ext/napoleon/docstring.py b/sphinx/ext/napoleon/docstring.py\nindex 755088ca5..a5a986e49 100644\n--- a/sphinx/ext/napoleon/docstring.py\n+++ b/sphinx/ext/napoleon/docstring.py\n@@ -682,7 +682,13 @@ class GoogleDocstring:\n         return self._parse_generic_section(_('Notes'), use_admonition)\n \n     def _parse_other_parameters_section(self, section: str) -> List[str]:\n-        return self._format_fields(_('Other Parameters'), self._consume_fields())\n+        if self._config.napoleon_use_param:\n+            # Allow to declare multiple parameters at once (ex: x, y: int)\n+            fields = self._consume_fields(multiple=True)\n+            return self._format_docutils_params(fields)\n+        else:\n+            fields = self._consume_fields()\n+            return self._format_fields(_('Other Parameters'), fields)\n \n     def _parse_parameters_section(self, section: str) -> List[str]:\n         if self._config.napoleon_use_param:",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sphinx-doc__sphinx-8721",
    "model_patch": "diff --git a/sphinx/ext/viewcode.py b/sphinx/ext/viewcode.py\nindex a7d52a91c..060604e25 100644\n--- a/sphinx/ext/viewcode.py\n+++ b/sphinx/ext/viewcode.py\n@@ -182,6 +182,8 @@ def collect_pages(app: Sphinx) -> Generator[Tuple[str, Dict[str, Any], str], Non\n     env = app.builder.env\n     if not hasattr(env, '_viewcode_modules'):\n         return\n+    if app.builder.name.startswith(\"epub\") and not env.config.viewcode_enable_epub:\n+        return\n     highlighter = app.builder.highlighter  # type: ignore\n     urito = app.builder.get_relative_uri",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sphinx-doc__sphinx-8801",
    "model_patch": "diff --git a/sphinx/ext/autodoc/importer.py b/sphinx/ext/autodoc/importer.py\nindex 477aae247..a936410b1 100644\n--- a/sphinx/ext/autodoc/importer.py\n+++ b/sphinx/ext/autodoc/importer.py\n@@ -307,9 +307,13 @@ def get_class_members(subject: Any, objpath: List[str], attrgetter: Callable\n                 analyzer = ModuleAnalyzer.for_module(modname)\n                 analyzer.analyze()\n                 for (ns, name), docstring in analyzer.attr_docs.items():\n-                    if ns == qualname and name not in members:\n-                        members[name] = ObjectMember(name, INSTANCEATTR, class_=cls,\n-                                                     docstring='\\n'.join(docstring))\n+                    if ns == qualname:\n+                        if name not in members:\n+                            members[name] = ObjectMember(name, INSTANCEATTR, class_=cls,\n+                                                         docstring='\\n'.join(docstring))\n+                        elif members[name].docstring is None:\n+                            # Update docstring for annotation-only member\n+                            members[name].docstring = '\\n'.join(docstring)\n             except (AttributeError, PycodeError):\n                 pass\n     except AttributeError:\ndiff --git a/tests/roots/test-ext-autodoc/target/annotations.py b/tests/roots/test-ext-autodoc/target/annotations.py\nindex ef600e2af..0543f21ab 100644\n--- a/tests/roots/test-ext-autodoc/target/annotations.py\n+++ b/tests/roots/test-ext-autodoc/target/annotations.py\n@@ -39,3 +39,10 @@ class Foo:\n \n     def __init__(self):\n         self.attr2: myint = None  #: docstring\n+\n+\n+class Bar(Foo):\n+    \"\"\"docstring\"\"\"\n+\n+    #: docstring for Bar\n+    attr3: myint\ndiff --git a/tests/test_ext_autodoc_autoclass.py b/tests/test_ext_autodoc_autoclass.py\nindex 488b72263..9673bbc58 100644\n--- a/tests/test_ext_autodoc_autoclass.py\n+++ b/tests/test_ext_autodoc_autoclass.py\n@@ -191,3 +191,33 @@ def test_class_alias(app):\n         '',\n         '   alias of :class:`target.classes.Foo`',\n     ]\n+\n+\n+@pytest.mark.skipif(sys.version_info < (3, 6), reason='python 3.6+ is required.')\n+@pytest.mark.sphinx('html', testroot='ext-autodoc')\n+def test_inherited_annotation_only_member(app):\n+    options = {'members': True,\n+               'inherited-members': True}\n+    actual = do_autodoc(app, 'class', 'target.annotations.Bar', options)\n+    assert list(actual) == [\n+        '',\n+        '.. py:class:: Bar()',\n+        '   :module: target.annotations',\n+        '',\n+        '   docstring',\n+        '',\n+        '',\n+        '   .. py:attribute:: Bar.attr1',\n+        '      :module: target.annotations',\n+        '      :type: myint',\n+        '',\n+        '      docstring',\n+        '',\n+        '',\n+        '   .. py:attribute:: Bar.attr3',\n+        '      :module: target.annotations',\n+        '      :type: myint',\n+        '',\n+        '      docstring for Bar',\n+        '',\n+    ]",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-11400",
    "model_patch": "diff --git a/sympy/printing/ccode.py b/sympy/printing/ccode.py\nindex 30a07a7b59..659096f513 100644\n--- a/sympy/printing/ccode.py\n+++ b/sympy/printing/ccode.py\n@@ -251,6 +251,13 @@ def _print_For(self, expr):\n     def _print_sign(self, func):\n         return '((({0}) > 0) - (({0}) < 0))'.format(self._print(func.args[0]))\n \n+    def _print_sinc(self, expr):\n+        from sympy.functions.elementary.trigonometric import sin\n+        from sympy.relational import Ne\n+        from sympy.functions import Piecewise\n+        x = expr.args[0]\n+        return self._print(Piecewise((sin(x)/x, Ne(x, 0)), (1, True)))\n+\n     def indent_code(self, code):\n         \"\"\"Accepts a string of code or a list of code lines\"\"\"\n \ndiff --git a/sympy/printing/tests/test_ccode.py b/sympy/printing/tests/test_ccode.py\nindex d8e449d853..7c673976c6 100644\n--- a/sympy/printing/tests/test_ccode.py\n+++ b/sympy/printing/tests/test_ccode.py\n@@ -1,7 +1,7 @@\n from sympy.core import (pi, oo, symbols, Rational, Integer,\n                         GoldenRatio, EulerGamma, Catalan, Lambda, Dummy, Eq)\n from sympy.functions import (Piecewise, sin, cos, Abs, exp, ceiling, sqrt,\n-                             gamma, sign)\n+                             gamma, sign, sinc)\n from sympy.sets import Range\n from sympy.logic import ITE\n from sympy.codegen import For, aug_assign, Assignment\n@@ -479,6 +479,12 @@ def test_ccode_sign():\n     expr = sign(cos(x))\n     assert ccode(expr) == '(((cos(x)) > 0) - ((cos(x)) < 0))'\n \n+def test_ccode_sinc():\n+    # sinc(x) should print as a Piecewise expression\n+    assert ccode(sinc(x)) == '((x != 0) ? (\\n   sin(x)/x\\n)\\n: (\\n   1\\n))'\n+    theta = symbols('theta')\n+    assert ccode(sinc(theta)) == '((theta != 0) ? (\\n   sin(theta)/theta\\n)\\n: (\\n   1\\n))'\n+\n def test_ccode_Assignment():\n     assert ccode(Assignment(x, y + z)) == 'x = y + z;'\n     assert ccode(aug_assign(x, '+', y + z)) == 'x += y + z;'",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-11870",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-11897",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-12171",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-12236",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-12419",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-12454",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-12481",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-13031",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-13043",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-13146",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-13177",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-13437",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-13471",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-13480",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-13647",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-13773",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-13895",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-13915",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-13971",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-14024",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-14308",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-14317",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-14396",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-14774",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-14817",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-11564",
    "model_patch": "diff --git a/django/core/files/storage.py b/django/core/files/storage.py\nindex 4c27fce605..2aca8a63ab 100644\n--- a/django/core/files/storage.py\n+++ b/django/core/files/storage.py\n@@ -7,6 +7,7 @@ from django.core.exceptions import SuspiciousFileOperation\n from django.core.files import File, locks\n from django.core.files.move import file_move_safe\n from django.core.signals import setting_changed\n+from django.urls import get_script_prefix\n from django.utils import timezone\n from django.utils._os import safe_join\n from django.utils.crypto import get_random_string\n@@ -332,7 +333,11 @@ class FileSystemStorage(Storage):\n         url = filepath_to_uri(name)\n         if url is not None:\n             url = url.lstrip('/')\n-        return urljoin(self.base_url, url)\n+        url = urljoin(self.base_url, url)\n+        script_name = get_script_prefix()\n+        if script_name != '/':\n+            url = urljoin(script_name, url)\n+        return url\n \n     def _datetime_from_timestamp(self, ts):\n         \"\"\"\ndiff --git a/django/templatetags/static.py b/django/templatetags/static.py\nindex 39712aaba0..5c79e68637 100644\n--- a/django/templatetags/static.py\n+++ b/django/templatetags/static.py\n@@ -2,6 +2,7 @@ from urllib.parse import quote, urljoin\n \n from django import template\n from django.apps import apps\n+from django.urls import get_script_prefix\n from django.utils.encoding import iri_to_uri\n from django.utils.html import conditional_escape\n \n@@ -48,6 +49,9 @@ class PrefixNode(template.Node):\n \n     def render(self, context):\n         prefix = self.handle_simple(self.name)\n+        script_name = get_script_prefix()\n+        if script_name != '/':\n+            prefix = urljoin(script_name, prefix)\n         if self.varname is None:\n             return prefix\n         context[self.varname] = prefix\n@@ -117,7 +121,11 @@ class StaticNode(template.Node):\n             from django.contrib.staticfiles.storage import staticfiles_storage\n             return staticfiles_storage.url(path)\n         else:\n-            return urljoin(PrefixNode.handle_simple(\"STATIC_URL\"), quote(path))\n+            url = urljoin(PrefixNode.handle_simple(\"STATIC_URL\"), quote(path))\n+            script_name = get_script_prefix()\n+            if script_name != '/':\n+                url = urljoin(script_name, url)\n+            return url\n \n     @classmethod\n     def handle_token(cls, parser, token):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-12589",
    "model_patch": "diff --git a/django/db/models/sql/compiler.py b/django/db/models/sql/compiler.py\nindex 63ca817355..312a8c4542 100644\n--- a/django/db/models/sql/compiler.py\n+++ b/django/db/models/sql/compiler.py\n@@ -103,7 +103,12 @@ class SQLCompiler:\n             # Converts string references to expressions.\n             for expr in self.query.group_by:\n                 if not hasattr(expr, 'as_sql'):\n-                    expressions.append(self.query.resolve_ref(expr))\n+                    resolved_expr = self.query.resolve_ref(expr)\n+                    # If the resolved expression is an annotation, wrap it in a\n+                    # Ref to ensure it's properly referenced in the GROUP BY clause.\n+                    if expr in self.query.annotation_select:\n+                        resolved_expr = Ref(expr, resolved_expr)\n+                    expressions.append(resolved_expr)\n                 else:\n                     expressions.append(expr)\n         # Note that even if the group_by is set, it is only the minimal\ndiff --git a/tests/aggregation/tests.py b/tests/aggregation/tests.py\nindex 95b77ef87b..1f6449c12f 100644\n--- a/tests/aggregation/tests.py\n+++ b/tests/aggregation/tests.py\n@@ -1294,3 +1294,18 @@ class AggregateTestCase(TestCase):\n         # with self.assertNumQueries(1) as ctx:\n         #     self.assertSequenceEqual(books_qs, [book])\n         # self.assertEqual(ctx[0]['sql'].count('SELECT'), 2)\n+\n+    @skipUnlessDBFeature('supports_subqueries_in_group_by')\n+    def test_aggregation_subquery_annotation_in_values_group_by(self):\n+        \"\"\"\n+        Subquery annotations can be grouped against when selected through\n+        values() (#12589).\n+        \"\"\"\n+        latest_book_pubdate_qs = Book.objects.filter(\n+            publisher=OuterRef('pk'),\n+        ).order_by('-pubdate').values('pubdate')[:1]\n+        publishers = Publisher.objects.annotate(\n+            latest_pubdate=Subquery(latest_book_pubdate_qs),\n+        ).values('latest_pubdate').annotate(total=Count('pk'))\n+        # Should not raise \"column reference latest_pubdate is ambiguous\"\n+        self.assertGreater(len(list(publishers)), 0)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "astropy__astropy-12907",
    "model_patch": "diff --git a/astropy/modeling/separable.py b/astropy/modeling/separable.py\nindex a308e27297..45bea36085 100644\n--- a/astropy/modeling/separable.py\n+++ b/astropy/modeling/separable.py\n@@ -242,7 +242,7 @@ def _cstack(left, right):\n         cright = _coord_matrix(right, 'right', noutp)\n     else:\n         cright = np.zeros((noutp, right.shape[1]))\n-        cright[-right.shape[0]:, -right.shape[1]:] = 1\n+        cright[-right.shape[0]:, -right.shape[1]:] = right\n \n     return np.hstack([cleft, cright])",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "astropy__astropy-14182",
    "model_patch": "diff --git a/astropy/io/ascii/rst.py b/astropy/io/ascii/rst.py\nindex abdeba8efb..78e42b7d63 100644\n--- a/astropy/io/ascii/rst.py\n+++ b/astropy/io/ascii/rst.py\n@@ -57,8 +57,8 @@ class RST(FixedWidth):\n     data_class = SimpleRSTData\n     header_class = SimpleRSTHeader\n \n-    def __init__(self):\n-        super().__init__(delimiter_pad=None, bookend=False)\n+    def __init__(self, header_rows=None):\n+        super().__init__(delimiter_pad=None, bookend=False, header_rows=header_rows)\n \n     def write(self, lines):\n         lines = super().write(lines)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "astropy__astropy-14365",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "astropy__astropy-14995",
    "model_patch": "diff --git a/astropy/nddata/mixins/ndarithmetic.py b/astropy/nddata/mixins/ndarithmetic.py\nindex 4153dfccb2..de70b29314 100644\n--- a/astropy/nddata/mixins/ndarithmetic.py\n+++ b/astropy/nddata/mixins/ndarithmetic.py\n@@ -517,11 +517,17 @@ class NDArithmeticMixin:\n             self.mask is None and operand is not None and operand.mask is None\n         ) or handle_mask is None:\n             return None\n-        elif self.mask is None and operand is not None:\n+        elif self.mask is None and operand is not None and operand.mask is not None:\n             # Make a copy so there is no reference in the result.\n             return deepcopy(operand.mask)\n+        elif self.mask is None and operand is not None:\n+            # operand has no mask\n+            return None\n         elif operand is None:\n             return deepcopy(self.mask)\n+        elif operand.mask is None:\n+            # self has a mask but operand doesn't\n+            return deepcopy(self.mask)\n         else:\n             # Now lets calculate the resulting mask (operation enforces copy)\n             return handle_mask(self.mask, operand.mask, **kwds)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-15308",
    "model_patch": "diff --git a/sympy/printing/latex.py b/sympy/printing/latex.py\nindex a0eb97792e..fc7b4bb617 100644\n--- a/sympy/printing/latex.py\n+++ b/sympy/printing/latex.py\n@@ -1470,6 +1470,14 @@ def _print_Adjoint(self, expr):\n         else:\n             return r\"%s^\\dagger\" % self._print(mat)\n \n+    def _print_Trace(self, expr):\n+        mat = expr.arg\n+        from sympy.matrices import MatrixSymbol\n+        if not isinstance(mat, MatrixSymbol):\n+            return r\"\\mathrm{Tr}\\left(%s\\right)\" % self._print(mat)\n+        else:\n+            return r\"\\mathrm{Tr}\\left(%s\\right)\" % self._print(mat)\n+\n     def _print_MatAdd(self, expr):\n         terms = [self._print(t) for t in expr.args]\n         l = []",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-15345",
    "model_patch": "diff --git a/sympy/printing/mathematica.py b/sympy/printing/mathematica.py\nindex ea7e3a2d94..9e281df32a 100644\n--- a/sympy/printing/mathematica.py\n+++ b/sympy/printing/mathematica.py\n@@ -116,6 +116,12 @@ def _print_Derivative(self, expr):\n         dvars = [i[0] if i[1] == 1 else i for i in expr.variable_count]\n         return \"Hold[D[\" + ', '.join(self.doprint(a) for a in [dexpr] + dvars) + \"]]\"\n \n+    def _print_Max(self, expr):\n+        return \"Max[\" + ', '.join(self.doprint(a) for a in expr.args) + \"]\"\n+\n+    def _print_Min(self, expr):\n+        return \"Min[\" + ', '.join(self.doprint(a) for a in expr.args) + \"]\"\n+\n \n def mathematica_code(expr, **settings):\n     r\"\"\"Converts an expr to a string of the Wolfram Mathematica code\ndiff --git a/sympy/printing/tests/test_mathematica.py b/sympy/printing/tests/test_mathematica.py\nindex dd636d0623..9a3607f8b3 100644\n--- a/sympy/printing/tests/test_mathematica.py\n+++ b/sympy/printing/tests/test_mathematica.py\n@@ -1,5 +1,5 @@\n from sympy.core import (S, pi, oo, symbols, Function,\n-                        Rational, Integer, Tuple, Derivative)\n+                        Rational, Integer, Tuple, Derivative, Max, Min)\n from sympy.integrals import Integral\n from sympy.concrete import Sum\n from sympy.functions import exp, sin, cos, conjugate\n@@ -90,3 +90,10 @@ def test_Sum():\n                      (y, -oo, oo))) == \\\n         \"Hold[Sum[Exp[-x^2 - y^2], {x, -Infinity, Infinity}, \" \\\n         \"{y, -Infinity, Infinity}]]\"\n+\n+\n+def test_MaxMin():\n+    assert mcode(Max(x, 2)) == \"Max[x, 2]\"\n+    assert mcode(Min(x, 2)) == \"Min[x, 2]\"\n+    assert mcode(Max(x, y, z)) == \"Max[x, y, z]\"\n+    assert mcode(Min(x, y, z)) == \"Min[x, y, z]\"",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-15346",
    "model_patch": "diff --git a/sympy/simplify/trigsimp.py b/sympy/simplify/trigsimp.py\nindex 8ba346adbe..032d6175c6 100644\n--- a/sympy/simplify/trigsimp.py\n+++ b/sympy/simplify/trigsimp.py\n@@ -1143,8 +1143,8 @@ def _futrig(e, **kwargs):\n         lambda x: _eapply(factor, x, trigs),\n         TR14,  # factored powers of identities\n         [identity, lambda x: _eapply(_mexpand, x, trigs)],\n-        TRmorrie,\n         TR10i,  # sin-cos products > sin-cos of sums\n+        TRmorrie,\n         [identity, TR8],  # sin-cos products -> sin-cos of sums\n         [identity, lambda x: TR2i(TR2(x))],  # tan -> sin-cos -> tan\n         [",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-15609",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-15678",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-16106",
    "model_patch": "diff --git a/sympy/printing/mathml.py b/sympy/printing/mathml.py\nindex 1aa0ee01a2..58e403144b 100644\n--- a/sympy/printing/mathml.py\n+++ b/sympy/printing/mathml.py\n@@ -477,6 +477,16 @@ def _print_int(self, p):\n         dom_element.appendChild(self.dom.createTextNode(str(p)))\n         return dom_element\n \n+    def _print_IndexedBase(self, expr):\n+        return self._print(expr.label)\n+\n+    def _print_Indexed(self, expr):\n+        x = self.dom.createElement('apply')\n+        x.appendChild(self._print(expr.base))\n+        for index in expr.indices:\n+            x.appendChild(self._print(index))\n+        return x\n+\n \n class MathMLPresentationPrinter(MathMLPrinterBase):\n     \"\"\"Prints an expression to the Presentation MathML markup language.\n@@ -1270,6 +1280,29 @@ def _print_Lambda(self, e):\n         x.appendChild(mrow)\n         return x\n \n+    def _print_IndexedBase(self, expr):\n+        return self._print(expr.label)\n+\n+    def _print_Indexed(self, expr):\n+        # Print the base with subscript indices\n+        msub = self.dom.createElement('msub')\n+        msub.appendChild(self._print(expr.base))\n+\n+        # Join all indices with commas\n+        if len(expr.indices) > 1:\n+            mrow = self.dom.createElement('mrow')\n+            for i, index in enumerate(expr.indices):\n+                if i > 0:\n+                    mo = self.dom.createElement('mo')\n+                    mo.appendChild(self.dom.createTextNode(','))\n+                    mrow.appendChild(mo)\n+                mrow.appendChild(self._print(index))\n+            msub.appendChild(mrow)\n+        else:\n+            msub.appendChild(self._print(expr.indices[0]))\n+\n+        return msub\n+\n \n def mathml(expr, printer='content', **settings):\n     \"\"\"Returns the MathML representation of expr. If printer is presentation then",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-16281",
    "model_patch": "diff --git a/sympy/printing/pretty/pretty.py b/sympy/printing/pretty/pretty.py\nindex 6d3cc05bd3..023511c43a 100644\n--- a/sympy/printing/pretty/pretty.py\n+++ b/sympy/printing/pretty/pretty.py\n@@ -474,14 +474,14 @@ def _print_Product(self, expr):\n         func = expr.term\n         pretty_func = self._print(func)\n \n-        horizontal_chr = xobj('_', 1)\n-        corner_chr = xobj('_', 1)\n-        vertical_chr = xobj('|', 1)\n-\n         if self._use_unicode:\n-            # use unicode corners\n             horizontal_chr = xobj('-', 1)\n             corner_chr = u'\\N{BOX DRAWINGS LIGHT DOWN AND HORIZONTAL}'\n+            vertical_chr = xobj('|', 1)\n+        else:\n+            horizontal_chr = xobj('_', 1)\n+            corner_chr = xobj('_', 1)\n+            vertical_chr = xobj('|', 1)\n \n         func_height = pretty_func.height()\n \n@@ -490,10 +490,19 @@ def _print_Product(self, expr):\n         sign_height = 0\n \n         for lim in expr.limits:\n-            width = (func_height + 2) * 5 // 3 - 2\n+            # Make the product sign narrower\n+            width = max(func_height - 1, 1)\n             sign_lines = []\n-            sign_lines.append(corner_chr + (horizontal_chr*width) + corner_chr)\n-            for i in range(func_height + 1):\n+\n+            if self._use_unicode:\n+                # Use extended top bar with unicode\n+                sign_lines.append(horizontal_chr + corner_chr + (horizontal_chr*width) + corner_chr + horizontal_chr)\n+            else:\n+                # ASCII mode\n+                sign_lines.append(corner_chr + (horizontal_chr*width) + corner_chr)\n+\n+            # Only add func_height lines (not func_height + 1) to avoid empty line at bottom\n+            for i in range(func_height):\n                 sign_lines.append(vertical_chr + (' '*width) + vertical_chr)\n \n             pretty_sign = stringPict('')\ndiff --git a/sympy/printing/pretty/tests/test_pretty.py b/sympy/printing/pretty/tests/test_pretty.py\nindex cfaa65a7a2..50acb90c0e 100644\n--- a/sympy/printing/pretty/tests/test_pretty.py\n+++ b/sympy/printing/pretty/tests/test_pretty.py\n@@ -2053,26 +2053,24 @@ def test_pretty_product():\n \n     unicode_str = \\\n u(\"\"\"\\\n-    l           \\n\\\n-\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c      \\n\\\n-\u2502        \u2502  \u239b 2\u239e\\n\\\n-\u2502        \u2502  \u239cn \u239f\\n\\\n-\u2502        \u2502 f\u239c\u2500\u2500\u239f\\n\\\n-\u2502        \u2502  \u239d9 \u23a0\\n\\\n-\u2502        \u2502      \\n\\\n-       2        \\n\\\n-  n = k         \"\"\")\n-    ascii_str = \\\n-\"\"\"\\\n-    l           \\n\\\n-__________      \\n\\\n-|        |  / 2\\\\\\n\\\n-|        |  |n |\\n\\\n-|        | f|--|\\n\\\n-|        |  \\\\9 /\\n\\\n-|        |      \\n\\\n-       2        \\n\\\n-  n = k         \"\"\"\n+   l         \\n\\\n+\u2500\u252c\u2500\u2500\u2500\u252c\u2500      \\n\\\n+ \u2502   \u2502   \u239b 2\u239e\\n\\\n+ \u2502   \u2502   \u239cn \u239f\\n\\\n+ \u2502   \u2502  f\u239c\u2500\u2500\u239f\\n\\\n+ \u2502   \u2502   \u239d9 \u23a0\\n\\\n+      2      \\n\\\n+ n = k         \"\"\")\n+    ascii_str = \\\n+\"\"\"\\\n+  l         \\n\\\n+_____       \\n\\\n+|   |   / 2\\\\\\n\\\n+|   |   |n |\\n\\\n+|   |  f|--|\\n\\\n+|   |   \\\\9 /\\n\\\n+     2      \\n\\\n+n = k         \"\"\"\n \n     assert pretty(expr) == ascii_str\n     assert upretty(expr) == unicode_str\n@@ -2081,26 +2079,24 @@ def test_pretty_product():\n \n     unicode_str = \\\n u(\"\"\"\\\n-    m          l           \\n\\\n-\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c \u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c      \\n\\\n-\u2502        \u2502 \u2502        \u2502  \u239b 2\u239e\\n\\\n-\u2502        \u2502 \u2502        \u2502  \u239cn \u239f\\n\\\n-\u2502        \u2502 \u2502        \u2502 f\u239c\u2500\u2500\u239f\\n\\\n-\u2502        \u2502 \u2502        \u2502  \u239d9 \u23a0\\n\\\n-\u2502        \u2502 \u2502        \u2502      \\n\\\n-  l = 1           2        \\n\\\n-             n = k         \"\"\")\n-    ascii_str = \\\n-\"\"\"\\\n-    m          l           \\n\\\n-__________ __________      \\n\\\n-|        | |        |  / 2\\\\\\n\\\n-|        | |        |  |n |\\n\\\n-|        | |        | f|--|\\n\\\n-|        | |        |  \\\\9 /\\n\\\n-|        | |        |      \\n\\\n-  l = 1           2        \\n\\\n-             n = k         \"\"\"\n+   m       l         \\n\\\n+\u2500\u252c\u2500\u2500\u2500\u252c\u2500 \u2500\u252c\u2500\u2500\u2500\u252c\u2500      \\n\\\n+ \u2502   \u2502   \u2502   \u2502   \u239b 2\u239e\\n\\\n+ \u2502   \u2502   \u2502   \u2502   \u239cn \u239f\\n\\\n+ \u2502   \u2502   \u2502   \u2502  f\u239c\u2500\u2500\u239f\\n\\\n+ \u2502   \u2502   \u2502   \u2502   \u239d9 \u23a0\\n\\\n+ l = 1        2      \\n\\\n+         n = k         \"\"\")\n+    ascii_str = \\\n+\"\"\"\\\n+  m     l         \\n\\\n+_____ _____       \\n\\\n+|   | |   |   / 2\\\\\\n\\\n+|   | |   |   |n |\\n\\\n+|   | |   |  f|--|\\n\\\n+|   | |   |   \\\\9 /\\n\\\n+l = 1      2      \\n\\\n+      n = k         \"\"\"\n \n     assert pretty(expr) == ascii_str\n     assert upretty(expr) == unicode_str",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-16503",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-16792",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-16988",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-17022",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-17139",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-17630",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-17655",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-18057",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-18087",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-18189",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-18199",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-18532",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-18621",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-18698",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-18835",
    "model_patch": "diff --git a/sympy/utilities/iterables.py b/sympy/utilities/iterables.py\nindex d96e76263b..eaf12f2484 100644\n--- a/sympy/utilities/iterables.py\n+++ b/sympy/utilities/iterables.py\n@@ -2109,7 +2109,20 @@ def uniq(seq, result=None):\n     try:\n         seen = set()\n         result = result or []\n+        # Record initial size if sequence has __len__\n+        try:\n+            initial_len = len(seq)\n+        except (TypeError, AttributeError):\n+            initial_len = None\n         for i, s in enumerate(seq):\n+            # Check if sequence size has changed during iteration\n+            if initial_len is not None:\n+                try:\n+                    current_len = len(seq)\n+                    if current_len != initial_len:\n+                        raise RuntimeError(\"sequence changed size during iteration\")\n+                except (TypeError, AttributeError):\n+                    pass\n             if not (s in seen or seen.add(s)):\n                 yield s\n     except TypeError:",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-19007",
    "model_patch": "diff --git a/sympy/matrices/expressions/blockmatrix.py b/sympy/matrices/expressions/blockmatrix.py\nindex b821c42845..9190d2578f 100644\n--- a/sympy/matrices/expressions/blockmatrix.py\n+++ b/sympy/matrices/expressions/blockmatrix.py\n@@ -235,15 +235,40 @@ def transpose(self):\n     def _entry(self, i, j, **kwargs):\n         # Find row entry\n         for row_block, numrows in enumerate(self.rowblocksizes):\n-            if (i < numrows) != False:\n-                break\n+            if i.is_Number:\n+                if i < numrows:\n+                    break\n+                else:\n+                    i -= numrows\n             else:\n-                i -= numrows\n+                # For symbolic indices, check if we can determine the relationship\n+                # If we can't determine i < numrows, we need to be more careful\n+                # Check if i is definitely less than numrows\n+                if (i < numrows) == True:\n+                    break\n+                elif (i >= numrows) == True:\n+                    i -= numrows\n+                else:\n+                    # Can't determine - return unevaluated\n+                    from sympy.matrices.expressions.matexpr import MatrixElement\n+                    return MatrixElement(self, i, j)\n         for col_block, numcols in enumerate(self.colblocksizes):\n-            if (j < numcols) != False:\n-                break\n+            if j.is_Number:\n+                if j < numcols:\n+                    break\n+                else:\n+                    j -= numcols\n             else:\n-                j -= numcols\n+                # For symbolic indices, check if we can determine the relationship\n+                # Check if j is definitely less than numcols\n+                if (j < numcols) == True:\n+                    break\n+                elif (j >= numcols) == True:\n+                    j -= numcols\n+                else:\n+                    # Can't determine - return unevaluated\n+                    from sympy.matrices.expressions.matexpr import MatrixElement\n+                    return MatrixElement(self, i, j)\n         return self.blocks[row_block, col_block][i, j]\n \n     @property",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-19254",
    "model_patch": "diff --git a/sympy/polys/factortools.py b/sympy/polys/factortools.py\nindex 93298f47e6..1472275e80 100644\n--- a/sympy/polys/factortools.py\n+++ b/sympy/polys/factortools.py\n@@ -12,7 +12,7 @@\n \n from sympy.polys.densebasic import (\n     dup_LC, dmp_LC, dmp_ground_LC,\n-    dup_TC,\n+    dup_TC, dmp_ground_TC,\n     dup_convert, dmp_convert,\n     dup_degree, dmp_degree,\n     dmp_degree_in, dmp_degree_list,\n@@ -41,7 +41,7 @@\n     dup_sub_mul, dmp_sub_mul,\n     dup_lshift,\n     dup_max_norm, dmp_max_norm,\n-    dup_l1_norm,\n+    dup_l1_norm, dmp_l1_norm,\n     dup_mul_ground, dmp_mul_ground,\n     dup_quo_ground, dmp_quo_ground)\n \n@@ -124,21 +124,36 @@ def dmp_trial_division(f, factors, u, K):\n \n \n def dup_zz_mignotte_bound(f, K):\n-    \"\"\"Mignotte bound for univariate polynomials in `K[x]`. \"\"\"\n-    a = dup_max_norm(f, K)\n-    b = abs(dup_LC(f, K))\n+    \"\"\"Knuth-Cohen bound for univariate polynomials in `K[x]`. \"\"\"\n     n = dup_degree(f)\n+    if n < 0:\n+        return K.zero\n \n-    return K.sqrt(K(n + 1))*2**n*a*b\n+    a = dup_l1_norm(f, K)\n+    b = abs(dup_TC(f, K))\n+\n+    if n == 0:\n+        return b\n+\n+    return K(2)**(n - 1)*K.sqrt(a*a - b*b) + b\n \n \n def dmp_zz_mignotte_bound(f, u, K):\n-    \"\"\"Mignotte bound for multivariate polynomials in `K[X]`. \"\"\"\n-    a = dmp_max_norm(f, u, K)\n-    b = abs(dmp_ground_LC(f, u, K))\n+    \"\"\"Knuth-Cohen bound for multivariate polynomials in `K[X]`. \"\"\"\n+    if not u:\n+        return dup_zz_mignotte_bound(f, K)\n+\n     n = sum(dmp_degree_list(f, u))\n+    if n < 0:\n+        return K.zero\n+\n+    a = dmp_l1_norm(f, u, K)\n+    b = abs(dmp_ground_TC(f, u, K))\n+\n+    if n == 0:\n+        return b\n \n-    return K.sqrt(K(n + 1))*2**n*a*b\n+    return K(2)**(n - 1)*K.sqrt(a*a - b*b) + b\n \n \n def dup_zz_hensel_step(m, f, g, h, s, t, K):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-19487",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-20049",
    "model_patch": "diff --git a/sympy/physics/vector/point.py b/sympy/physics/vector/point.py\nindex d4e3cfcc90..02ae9de6b1 100644\n--- a/sympy/physics/vector/point.py\n+++ b/sympy/physics/vector/point.py\n@@ -519,6 +519,18 @@ def vel(self, frame):\n \n         _check_frame(frame)\n         if not (frame in self._vel_dict):\n+            # Try to calculate velocity from position information\n+            # Find all points that have position defined relative to this point\n+            for other_point in self._pos_dict:\n+                # Check if the other point has velocity defined in the frame\n+                if frame in other_point._vel_dict:\n+                    # Calculate velocity using: v_self = v_other + d/dt(r_self_from_other)\n+                    pos_vector = self.pos_from(other_point)\n+                    other_vel = other_point.vel(frame)\n+                    calculated_vel = other_vel + pos_vector.dt(frame)\n+                    self._vel_dict[frame] = calculated_vel\n+                    return calculated_vel\n+            # If we still can't find velocity, raise an error\n             raise ValueError('Velocity of point ' + self.name + ' has not been'\n                              ' defined in ReferenceFrame ' + frame.name)\n         return self._vel_dict[frame]",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-20154",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-20212",
    "model_patch": "diff --git a/sympy/core/numbers.py b/sympy/core/numbers.py\nindex 2c50002de3..f20db43ce4 100644\n--- a/sympy/core/numbers.py\n+++ b/sympy/core/numbers.py\n@@ -2625,7 +2625,7 @@ def __neg__():\n     def _eval_power(self, expt):\n         if expt.is_positive:\n             return self\n-        if expt.is_negative:\n+        if expt.is_negative or expt.is_extended_negative:\n             return S.ComplexInfinity\n         if expt.is_extended_real is False:\n             return S.NaN",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-20322",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-20442",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-20590",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-20639",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-21055",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-21171",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-21379",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-21612",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-21614",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-21627",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-21847",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-22005",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-22714",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-22840",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-23117",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-23191",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-23262",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-24066",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-24102",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-24152",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-24213",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-24909",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13660",
    "model_patch": "diff --git a/django/core/management/commands/shell.py b/django/core/management/commands/shell.py\nindex 2b306a579e..571d120467 100644\n--- a/django/core/management/commands/shell.py\n+++ b/django/core/management/commands/shell.py\n@@ -84,13 +84,13 @@ class Command(BaseCommand):\n     def handle(self, **options):\n         # Execute the command and exit.\n         if options['command']:\n-            exec(options['command'])\n+            exec(options['command'], {})\n             return\n \n         # Execute stdin if it has anything to read and exit.\n         # Not supported on Windows due to select.select() limitations.\n         if sys.platform != 'win32' and not sys.stdin.isatty() and select.select([sys.stdin], [], [], 0)[0]:\n-            exec(sys.stdin.read())\n+            exec(sys.stdin.read(), {})\n             return\n \n         available_shells = [options['interface']] if options['interface'] else self.shells",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13710",
    "model_patch": "diff --git a/django/contrib/admin/options.py b/django/contrib/admin/options.py\nindex dadd4acfa1..8766ca4e64 100644\n--- a/django/contrib/admin/options.py\n+++ b/django/contrib/admin/options.py\n@@ -2037,10 +2037,17 @@ class InlineModelAdmin(BaseModelAdmin):\n         self.opts = self.model._meta\n         self.has_registered_model = admin_site.is_registered(self.model)\n         super().__init__()\n+        # Check if verbose_name was explicitly set on the Inline class\n+        verbose_name_was_set = self.verbose_name is not None\n         if self.verbose_name is None:\n             self.verbose_name = self.model._meta.verbose_name\n+        # If verbose_name_plural is not set and verbose_name was explicitly set,\n+        # pluralize the verbose_name instead of using the model's verbose_name_plural\n         if self.verbose_name_plural is None:\n-            self.verbose_name_plural = self.model._meta.verbose_name_plural\n+            if verbose_name_was_set:\n+                self.verbose_name_plural = format_lazy('{}{}', self.verbose_name, 's')\n+            else:\n+                self.verbose_name_plural = self.model._meta.verbose_name_plural\n \n     @property\n     def media(self):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13757",
    "model_patch": "diff --git a/django/db/models/fields/json.py b/django/db/models/fields/json.py\nindex 29c6ff0926..e504a285f4 100644\n--- a/django/db/models/fields/json.py\n+++ b/django/db/models/fields/json.py\n@@ -368,12 +368,18 @@ class KeyTransformIsNull(lookups.IsNull):\n     def as_oracle(self, compiler, connection):\n         if not self.rhs:\n             return HasKey(self.lhs.lhs, self.lhs.key_name).as_oracle(compiler, connection)\n-        return super().as_sql(compiler, connection)\n+        # key__isnull=True should exclude objects with JSON null for the key.\n+        lhs, params, key_transforms = self.lhs.preprocess_lhs(compiler, connection)\n+        json_path = compile_json_path(key_transforms)\n+        return \"NOT JSON_EXISTS(%s, '%s')\" % (lhs, json_path), params\n \n     def as_sqlite(self, compiler, connection):\n         if not self.rhs:\n             return HasKey(self.lhs.lhs, self.lhs.key_name).as_sqlite(compiler, connection)\n-        return super().as_sql(compiler, connection)\n+        # key__isnull=True should exclude objects with JSON null for the key.\n+        lhs, params, key_transforms = self.lhs.preprocess_lhs(compiler, connection)\n+        json_path = compile_json_path(key_transforms)\n+        return 'JSON_TYPE(%s, %s) IS NULL' % (lhs, '%s'), tuple(params) + (json_path,)\n \n \n class KeyTransformIn(lookups.In):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13768",
    "model_patch": "diff --git a/django/dispatch/dispatcher.py b/django/dispatch/dispatcher.py\nindex b7d9d26389..8081bfe42d 100644\n--- a/django/dispatch/dispatcher.py\n+++ b/django/dispatch/dispatcher.py\n@@ -1,3 +1,4 @@\n+import logging\n import threading\n import warnings\n import weakref\n@@ -5,6 +6,8 @@ import weakref\n from django.utils.deprecation import RemovedInDjango40Warning\n from django.utils.inspect import func_accepts_kwargs\n \n+logger = logging.getLogger(__name__)\n+\n \n def _make_id(target):\n     if hasattr(target, '__func__'):\n@@ -208,6 +211,7 @@ class Signal:\n             try:\n                 response = receiver(signal=self, sender=sender, **named)\n             except Exception as err:\n+                logger.exception('Error calling %s', receiver.__qualname__)\n                 responses.append((receiver, err))\n             else:\n                 responses.append((receiver, response))",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13925",
    "model_patch": "diff --git a/django/db/models/base.py b/django/db/models/base.py\nindex 4038859cfa..a8519c547f 100644\n--- a/django/db/models/base.py\n+++ b/django/db/models/base.py\n@@ -1299,6 +1299,7 @@ class Model(metaclass=ModelBase):\n     def _check_default_pk(cls):\n         if (\n             cls._meta.pk.auto_created and\n+            cls._meta.pk in cls._meta.local_fields and\n             not settings.is_overridden('DEFAULT_AUTO_FIELD') and\n             not cls._meta.app_config._is_default_auto_field_overridden\n         ):\ndiff --git a/tests/check_framework/test_model_checks.py b/tests/check_framework/test_model_checks.py\nindex d4342ada07..daacdac1d8 100644\n--- a/tests/check_framework/test_model_checks.py\n+++ b/tests/check_framework/test_model_checks.py\n@@ -415,3 +415,15 @@ class ModelDefaultAutoFieldTests(SimpleTestCase):\n                 app_label = 'check_framework.apps.CheckPKConfig'\n \n         self.assertEqual(checks.run_checks(app_configs=apps.get_app_configs()), [])\n+\n+    def test_inherited_pk(self):\n+        class Entity(models.Model):\n+            id = models.BigAutoField(primary_key=True)\n+\n+            class Meta:\n+                abstract = True\n+\n+        class User(Entity):\n+            pass\n+\n+        self.assertEqual(checks.run_checks(app_configs=self.apps.get_app_configs()), [])",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13933",
    "model_patch": "diff --git a/django/forms/models.py b/django/forms/models.py\nindex 422bc5d178..e03a3803cd 100644\n--- a/django/forms/models.py\n+++ b/django/forms/models.py\n@@ -1188,7 +1188,7 @@ class ModelChoiceField(ChoiceField):\n     # This class is a subclass of ChoiceField for purity, but it doesn't\n     # actually use any of ChoiceField's implementation.\n     default_error_messages = {\n-        'invalid_choice': _('Select a valid choice. That choice is not one of'\n+        'invalid_choice': _('Select a valid choice. %(value)s is not one of'\n                             ' the available choices.'),\n     }\n     iterator = ModelChoiceIterator\n@@ -1284,7 +1284,11 @@ class ModelChoiceField(ChoiceField):\n                 value = getattr(value, key)\n             value = self.queryset.get(**{key: value})\n         except (ValueError, TypeError, self.queryset.model.DoesNotExist):\n-            raise ValidationError(self.error_messages['invalid_choice'], code='invalid_choice')\n+            raise ValidationError(\n+                self.error_messages['invalid_choice'],\n+                code='invalid_choice',\n+                params={'value': value},\n+            )\n         return value\n \n     def validate(self, value):\ndiff --git a/tests/admin_widgets/tests.py b/tests/admin_widgets/tests.py\nindex 3c41d9cdfa..466c716cbf 100644\n--- a/tests/admin_widgets/tests.py\n+++ b/tests/admin_widgets/tests.py\n@@ -243,7 +243,9 @@ class AdminForeignKeyRawIdWidget(TestDataMixin, TestCase):\n         # Try posting with a nonexistent pk in a raw id field: this\n         # should result in an error message, not a server exception.\n         response = self.client.post(reverse('admin:admin_widgets_event_add'), post_data)\n-        self.assertContains(response, 'Select a valid choice. That choice is not one of the available choices.')\n+        self.assertContains(response, 'Select a valid choice.')\n+        self.assertContains(response, str(pk))\n+        self.assertContains(response, 'is not one of the available choices.')\n \n     def test_invalid_target_id(self):\n \n@@ -251,7 +253,8 @@ class AdminForeignKeyRawIdWidget(TestDataMixin, TestCase):\n             # This should result in an error message, not a server exception.\n             response = self.client.post(reverse('admin:admin_widgets_event_add'), {\"main_band\": test_str})\n \n-            self.assertContains(response, 'Select a valid choice. That choice is not one of the available choices.')\n+            self.assertContains(response, 'Select a valid choice.')\n+            self.assertContains(response, 'is not one of the available choices.')\n \n     def test_url_params_from_lookup_dict_any_iterable(self):\n         lookup1 = widgets.url_params_from_lookup_dict({'color__in': ('red', 'blue')})\ndiff --git a/tests/model_forms/test_modelchoicefield.py b/tests/model_forms/test_modelchoicefield.py\nindex 8f41ce9c40..9ef34d2c20 100644\n--- a/tests/model_forms/test_modelchoicefield.py\n+++ b/tests/model_forms/test_modelchoicefield.py\n@@ -51,7 +51,7 @@ class ModelChoiceFieldTests(TestCase):\n         # instantiated. This proves clean() checks the database during clean()\n         # rather than caching it at instantiation time.\n         Category.objects.get(url='4th').delete()\n-        msg = \"['Select a valid choice. That choice is not one of the available choices.']\"\n+        msg = \"['Select a valid choice. %s is not one of the available choices.']\" % c4.id\n         with self.assertRaisesMessage(ValidationError, msg):\n             f.clean(c4.id)\n \n@@ -59,9 +59,10 @@ class ModelChoiceFieldTests(TestCase):\n         f = forms.ModelChoiceField(Category.objects.all())\n         self.assertEqual(f.clean(self.c1), self.c1)\n         # An instance of incorrect model.\n-        msg = \"['Select a valid choice. That choice is not one of the available choices.']\"\n+        book = Book.objects.create()\n+        msg = \"['Select a valid choice. %s is not one of the available choices.']\" % book.pk\n         with self.assertRaisesMessage(ValidationError, msg):\n-            f.clean(Book.objects.create())\n+            f.clean(book)\n \n     def test_clean_to_field_name(self):\n         f = forms.ModelChoiceField(Category.objects.all(), to_field_name='slug')\n@@ -214,10 +215,9 @@ class ModelChoiceFieldTests(TestCase):\n \n         book = Book.objects.create(author=Writer.objects.create(name='Test writer'))\n         form = ModelChoiceForm({}, instance=book)\n-        self.assertEqual(\n-            form.errors['author'],\n-            ['Select a valid choice. That choice is not one of the available choices.']\n-        )\n+        # The error message should contain the invalid pk value\n+        self.assertIn('Select a valid choice.', form.errors['author'][0])\n+        self.assertIn('is not one of the available choices.', form.errors['author'][0])\n \n     def test_disabled_modelchoicefield_has_changed(self):\n         field = forms.ModelChoiceField(Author.objects.all(), disabled=True)\ndiff --git a/tests/model_forms/tests.py b/tests/model_forms/tests.py\nindex 9931fa50e3..a579b886a1 100644\n--- a/tests/model_forms/tests.py\n+++ b/tests/model_forms/tests.py\n@@ -1673,10 +1673,10 @@ class ModelFormBasicTests(TestCase):\n         }\n         form = MyForm(data)\n         self.assertIs(form.is_valid(), False)\n-        self.assertEqual(\n-            form.errors,\n-            {'writer': ['Select a valid choice. That choice is not one of the available choices.']},\n-        )\n+        # The error message should contain the invalid pk value\n+        self.assertIn('Select a valid choice.', form.errors['writer'][0])\n+        self.assertIn('%s' % w.pk, form.errors['writer'][0])\n+        self.assertIn('is not one of the available choices.', form.errors['writer'][0])\n \n     def test_validate_foreign_key_to_model_with_overridden_manager(self):\n         class MyForm(forms.ModelForm):\ndiff --git a/tests/model_formsets/tests.py b/tests/model_formsets/tests.py\nindex 98fd501ad6..ff92544804 100644\n--- a/tests/model_formsets/tests.py\n+++ b/tests/model_formsets/tests.py\n@@ -1746,10 +1746,12 @@ class ModelFormsetTest(TestCase):\n             'form-0-name': 'Charles',\n         }\n         formset = AuthorFormSet(data)\n-        self.assertEqual(\n-            formset.errors,\n-            [{'id': ['Select a valid choice. That choice is not one of the available choices.']}],\n-        )\n+        # The error message should contain the invalid value\n+        self.assertEqual(len(formset.errors), 1)\n+        self.assertIn('id', formset.errors[0])\n+        self.assertIn('Select a valid choice.', formset.errors[0]['id'][0])\n+        self.assertIn('abc', formset.errors[0]['id'][0])\n+        self.assertIn('is not one of the available choices.', formset.errors[0]['id'][0])\n \n     def test_validation_with_nonexistent_id(self):\n         AuthorFormSet = modelformset_factory(Author, fields='__all__')\n@@ -1761,10 +1763,12 @@ class ModelFormsetTest(TestCase):\n             'form-0-name': 'Charles',\n         }\n         formset = AuthorFormSet(data)\n-        self.assertEqual(\n-            formset.errors,\n-            [{'id': ['Select a valid choice. That choice is not one of the available choices.']}],\n-        )\n+        # The error message should contain the invalid value\n+        self.assertEqual(len(formset.errors), 1)\n+        self.assertIn('id', formset.errors[0])\n+        self.assertIn('Select a valid choice.', formset.errors[0]['id'][0])\n+        self.assertIn('12345', formset.errors[0]['id'][0])\n+        self.assertIn('is not one of the available choices.', formset.errors[0]['id'][0])\n \n     def test_initial_form_count_empty_data(self):\n         AuthorFormSet = modelformset_factory(Author, fields='__all__')",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-13964",
    "model_patch": "diff --git a/django/db/models/base.py b/django/db/models/base.py\nindex 2428218696..cd3b3a4993 100644\n--- a/django/db/models/base.py\n+++ b/django/db/models/base.py\n@@ -937,6 +937,13 @@ class Model(metaclass=ModelBase):\n                     # Use pk from related object if it has been saved after\n                     # an assignment.\n                     setattr(self, field.attname, obj.pk)\n+                elif not getattr(self, field.attname) and obj.pk:\n+                    # Use pk from related object if the FK value is empty\n+                    # (e.g., empty string for CharField) and the related\n+                    # object now has a pk. This can happen when a related\n+                    # object with a non-auto primary key is assigned before\n+                    # its pk is set.\n+                    setattr(self, field.attname, obj.pk)\n                 # If the relationship's pk/to_field was changed, clear the\n                 # cached relationship.\n                 if getattr(obj, field.target_field.attname) != getattr(self, field.attname):\ndiff --git a/tests/model_fields/test_foreignkey.py b/tests/model_fields/test_foreignkey.py\nindex d30cca9b5c..d306f3137e 100644\n--- a/tests/model_fields/test_foreignkey.py\n+++ b/tests/model_fields/test_foreignkey.py\n@@ -3,7 +3,7 @@ from decimal import Decimal\n from django.apps import apps\n from django.core import checks\n from django.core.exceptions import FieldError\n-from django.db import models\n+from django.db import models, transaction\n from django.test import TestCase, skipIfDBFeature\n from django.test.utils import isolate_apps\n \n@@ -28,6 +28,29 @@ class ForeignKeyTests(TestCase):\n         fk_model_empty = FkToChar.objects.select_related('out').get(id=fk_model_empty.pk)\n         self.assertEqual(fk_model_empty.out, char_model_empty)\n \n+    def test_unsaved_instance_with_non_auto_pk(self):\n+        \"\"\"\n+        Assigning an unsaved instance with a non-auto primary key and then\n+        setting the primary key should properly update the foreign key value\n+        when the parent is saved (#13964).\n+        \"\"\"\n+        with transaction.atomic():\n+            # Create an unsaved parent instance\n+            parent = PrimaryKeyCharModel()\n+            # Create a child and assign the unsaved parent\n+            child = FkToChar(out=parent)\n+            # Set the parent's primary key\n+            parent.string = 'test_pk'\n+            # Save the parent\n+            parent.save()\n+            # Save the child - this should use the parent's PK\n+            child.save()\n+            # Refresh from database to ensure we have the correct values\n+            child.refresh_from_db()\n+            # Verify the FK was set correctly\n+            self.assertEqual(child.out_id, 'test_pk')\n+            self.assertEqual(child.out, parent)\n+\n     @isolate_apps('model_fields')\n     def test_warning_when_unique_true_on_fk(self):\n         class Foo(models.Model):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14016",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14017",
    "model_patch": "diff --git a/django/db/models/query_utils.py b/django/db/models/query_utils.py\nindex c957ffa564..7a513efad1 100644\n--- a/django/db/models/query_utils.py\n+++ b/django/db/models/query_utils.py\n@@ -64,6 +64,12 @@ class Q(tree.Node):\n     def __and__(self, other):\n         return self._combine(other, self.AND)\n \n+    def __rand__(self, other):\n+        return self._combine(other, self.AND)\n+\n+    def __ror__(self, other):\n+        return self._combine(other, self.OR)\n+\n     def __invert__(self):\n         obj = type(self)()\n         obj.add(self, self.AND)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14155",
    "model_patch": "diff --git a/django/urls/resolvers.py b/django/urls/resolvers.py\nindex 9b00e24509..e05011f965 100644\n--- a/django/urls/resolvers.py\n+++ b/django/urls/resolvers.py\n@@ -45,6 +45,10 @@ class ResolverMatch:\n         self.namespaces = [x for x in namespaces if x] if namespaces else []\n         self.namespace = ':'.join(self.namespaces)\n \n+        # Unwrap functools.partial to get the underlying function\n+        if isinstance(func, functools.partial):\n+            func = func.func\n+\n         if not hasattr(func, '__name__'):\n             # A class-based view\n             self._func_path = func.__class__.__module__ + '.' + func.__class__.__name__",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14238",
    "model_patch": "diff --git a/django/db/models/fields/__init__.py b/django/db/models/fields/__init__.py\nindex 0f53d9c30b..0ce7de02c6 100644\n--- a/django/db/models/fields/__init__.py\n+++ b/django/db/models/fields/__init__.py\n@@ -2524,7 +2524,7 @@ class AutoFieldMeta(type):\n         return isinstance(instance, self._subclasses) or super().__instancecheck__(instance)\n \n     def __subclasscheck__(self, subclass):\n-        return subclass in self._subclasses or super().__subclasscheck__(subclass)\n+        return issubclass(subclass, self._subclasses) or super().__subclasscheck__(subclass)\n \n \n class AutoField(AutoFieldMixin, IntegerField, metaclass=AutoFieldMeta):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14382",
    "model_patch": "diff --git a/django/core/management/templates.py b/django/core/management/templates.py\nindex 8dc6068286..f248ab1b71 100644\n--- a/django/core/management/templates.py\n+++ b/django/core/management/templates.py\n@@ -74,7 +74,7 @@ class TemplateCommand(BaseCommand):\n                 raise CommandError(e)\n         else:\n             if app_or_project == 'app':\n-                self.validate_name(os.path.basename(target), 'directory')\n+                self.validate_name(os.path.basename(target.rstrip(os.sep)), 'directory')\n             top_dir = os.path.abspath(os.path.expanduser(target))\n             if not os.path.exists(top_dir):\n                 raise CommandError(\"Destination directory '%s' does not \"",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14411",
    "model_patch": "diff --git a/django/contrib/auth/forms.py b/django/contrib/auth/forms.py\nindex 20d8922799..a1954f8dc8 100644\n--- a/django/contrib/auth/forms.py\n+++ b/django/contrib/auth/forms.py\n@@ -50,6 +50,13 @@ class ReadOnlyPasswordHashWidget(forms.Widget):\n         context['summary'] = summary\n         return context\n \n+    def id_for_label(self, id_):\n+        \"\"\"\n+        Return None because this widget renders a read-only display,\n+        not an input element, so it shouldn't have a label with a 'for' attribute.\n+        \"\"\"\n+        return None\n+\n \n class ReadOnlyPasswordHashField(forms.Field):\n     widget = ReadOnlyPasswordHashWidget",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14534",
    "model_patch": "diff --git a/django/forms/boundfield.py b/django/forms/boundfield.py\nindex 2ff8b0ee26..7fb73cc47f 100644\n--- a/django/forms/boundfield.py\n+++ b/django/forms/boundfield.py\n@@ -277,7 +277,7 @@ class BoundWidget:\n \n     @property\n     def id_for_label(self):\n-        return 'id_%s_%s' % (self.data['name'], self.data['index'])\n+        return self.data['attrs'].get('id') or 'id_%s_%s' % (self.data['name'], self.data['index'])\n \n     @property\n     def choice_label(self):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14580",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14608",
    "model_patch": "diff --git a/django/forms/formsets.py b/django/forms/formsets.py\nindex a89c35599f..1b0d4554e0 100644\n--- a/django/forms/formsets.py\n+++ b/django/forms/formsets.py\n@@ -333,7 +333,7 @@ class BaseFormSet:\n         self._non_form_errors.\n         \"\"\"\n         self._errors = []\n-        self._non_form_errors = self.error_class()\n+        self._non_form_errors = self.error_class(error_class='nonform')\n         empty_forms_count = 0\n \n         if not self.is_bound:  # Stop further processing.\n@@ -380,7 +380,7 @@ class BaseFormSet:\n             # Give self.clean() a chance to do cross-form validation.\n             self.clean()\n         except ValidationError as e:\n-            self._non_form_errors = self.error_class(e.error_list)\n+            self._non_form_errors = self.error_class(e.error_list, error_class='nonform')\n \n     def clean(self):\n         \"\"\"",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14667",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14672",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14730",
    "model_patch": "diff --git a/django/db/models/fields/related.py b/django/db/models/fields/related.py\nindex febaadbb5b..534b4ab830 100644\n--- a/django/db/models/fields/related.py\n+++ b/django/db/models/fields/related.py\n@@ -1214,6 +1214,7 @@ class ManyToManyField(RelatedField):\n             *self._check_relationship_model(**kwargs),\n             *self._check_ignored_options(**kwargs),\n             *self._check_table_uniqueness(**kwargs),\n+            *self._check_related_name_with_symmetrical(**kwargs),\n         ]\n \n     def _check_unique(self, **kwargs):\n@@ -1260,6 +1261,22 @@ class ManyToManyField(RelatedField):\n \n         return warnings\n \n+    def _check_related_name_with_symmetrical(self, **kwargs):\n+        if self.remote_field.symmetrical and self._related_name is not None:\n+            return [\n+                checks.Error(\n+                    'ManyToManyField cannot have a related_name when '\n+                    'symmetrical is True.',\n+                    hint=(\n+                        'If you want to define a related name, use symmetrical=False. '\n+                        'Alternatively, you can omit the related_name argument.'\n+                    ),\n+                    obj=self,\n+                    id='fields.E345',\n+                )\n+            ]\n+        return []\n+\n     def _check_relationship_model(self, from_model=None, **kwargs):\n         if hasattr(self.remote_field.through, '_meta'):\n             qualified_model_name = \"%s.%s\" % (",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14752",
    "model_patch": "diff --git a/django/contrib/admin/views/autocomplete.py b/django/contrib/admin/views/autocomplete.py\nindex 3903e4c98c..af47ce8c91 100644\n--- a/django/contrib/admin/views/autocomplete.py\n+++ b/django/contrib/admin/views/autocomplete.py\n@@ -26,8 +26,7 @@ class AutocompleteJsonView(BaseListView):\n         context = self.get_context_data()\n         return JsonResponse({\n             'results': [\n-                {'id': str(getattr(obj, to_field_name)), 'text': str(obj)}\n-                for obj in context['object_list']\n+                self.serialize_result(obj, to_field_name) for obj in context['object_list']\n             ],\n             'pagination': {'more': context['page_obj'].has_next()},\n         })\n@@ -36,6 +35,13 @@ class AutocompleteJsonView(BaseListView):\n         \"\"\"Use the ModelAdmin's paginator.\"\"\"\n         return self.model_admin.get_paginator(self.request, *args, **kwargs)\n \n+    def serialize_result(self, obj, to_field_name):\n+        \"\"\"Convert the provided object to a dictionary for JSON serialization.\"\"\"\n+        return {\n+            'id': str(getattr(obj, to_field_name)),\n+            'text': str(obj),\n+        }\n+\n     def get_queryset(self):\n         \"\"\"Return queryset based on ModelAdmin.get_search_results().\"\"\"\n         qs = self.model_admin.get_queryset(self.request)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14787",
    "model_patch": "diff --git a/django/utils/decorators.py b/django/utils/decorators.py\nindex 5c9a5d01c7..63f146d4f6 100644\n--- a/django/utils/decorators.py\n+++ b/django/utils/decorators.py\n@@ -38,8 +38,23 @@ def _multi_decorate(decorators, method):\n         # 'func'. Also, wrap method.__get__() in a function because new\n         # attributes can't be set on bound method objects, only on functions.\n         bound_method = partial(method.__get__(self, type(self)))\n+        # functools.partial objects don't have the function attributes that\n+        # decorators often copy via update_wrapper() or @wraps, so copy\n+        # them from the original method to avoid AttributeError.\n+        update_wrapper(bound_method, method)\n         for dec in decorators:\n             bound_method = dec(bound_method)\n+            # Preserve any attributes set by the decorator on the wrapper.\n+            # bound_method may be a functools.partial object which doesn't\n+            # allow setting attributes, so copy them to _wrapper.\n+            for attr in dir(bound_method):\n+                if not attr.startswith('__'):\n+                    try:\n+                        value = getattr(bound_method, attr, None)\n+                        if value is not None and not callable(value):\n+                            setattr(_wrapper, attr, value)\n+                    except (AttributeError, TypeError):\n+                        pass\n         return bound_method(*args, **kwargs)\n \n     # Copy any attributes that a decorator adds to the function it decorates.",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14855",
    "model_patch": "diff --git a/django/contrib/admin/helpers.py b/django/contrib/admin/helpers.py\nindex dd154f72ee..ba8c3463a0 100644\n--- a/django/contrib/admin/helpers.py\n+++ b/django/contrib/admin/helpers.py\n@@ -209,7 +209,11 @@ class AdminReadonlyField:\n             remote_field.model._meta.model_name,\n         )\n         try:\n-            url = reverse(url_name, args=[quote(remote_obj.pk)])\n+            url = reverse(\n+                url_name,\n+                args=[quote(remote_obj.pk)],\n+                current_app=self.model_admin.admin_site.name\n+            )\n             return format_html('<a href=\"{}\">{}</a>', url, remote_obj)\n         except NoReverseMatch:\n             return str(remote_obj)",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14915",
    "model_patch": "diff --git a/django/forms/models.py b/django/forms/models.py\nindex 5dcf923c12..bc7e6959e7 100644\n--- a/django/forms/models.py\n+++ b/django/forms/models.py\n@@ -1171,6 +1171,9 @@ class ModelChoiceIteratorValue:\n             other = other.value\n         return self.value == other\n \n+    def __hash__(self):\n+        return hash(self.value)\n+\n \n class ModelChoiceIterator:\n     def __init__(self, field):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14997",
    "model_patch": "diff --git a/django/db/backends/sqlite3/schema.py b/django/db/backends/sqlite3/schema.py\nindex f0c81c123b..41b5df47b6 100644\n--- a/django/db/backends/sqlite3/schema.py\n+++ b/django/db/backends/sqlite3/schema.py\n@@ -4,7 +4,7 @@ from decimal import Decimal\n from django.apps.registry import Apps\n from django.db import NotSupportedError\n from django.db.backends.base.schema import BaseDatabaseSchemaEditor\n-from django.db.backends.ddl_references import Statement\n+from django.db.backends.ddl_references import Columns, Statement\n from django.db.backends.utils import strip_quotes\n from django.db.models import UniqueConstraint\n from django.db.transaction import atomic\n@@ -442,3 +442,53 @@ class DatabaseSchemaEditor(BaseDatabaseSchemaEditor):\n \n     def _collate_sql(self, collation):\n         return 'COLLATE ' + collation\n+\n+    def _create_unique_sql(\n+        self, model, fields, name=None, condition=None, deferrable=None,\n+        include=None, opclasses=None, expressions=None,\n+    ):\n+        # SQLite doesn't support expressions in unique constraints that use\n+        # table-qualified column names (e.g., \"table\".\"column\"). When expressions\n+        # are just F() references to columns, use the column names directly.\n+        if expressions and not condition and not include and not deferrable:\n+            from django.db.models.expressions import F\n+\n+            # Check if all expressions are simple column references (F() objects)\n+            simple_columns = []\n+            for expr in expressions.source_expressions:\n+                # If the expression is a simple F() reference, extract the column name\n+                if isinstance(expr, F):\n+                    simple_columns.append(expr.name)\n+                else:\n+                    # If any expression is not a simple F() reference, use the default behavior\n+                    simple_columns = None\n+                    break\n+\n+            if simple_columns:\n+                # All expressions are simple F() references, use column names directly\n+                # Get the actual column names from the model fields\n+                columns = []\n+                for field_name in simple_columns:\n+                    try:\n+                        field = model._meta.get_field(field_name)\n+                        columns.append(field.column)\n+                    except Exception:\n+                        # If we can't resolve the field, fall back to default behavior\n+                        simple_columns = None\n+                        break\n+\n+                if simple_columns:\n+                    # Create a unique index using column names instead of expressions\n+                    return Statement(\n+                        self.sql_create_unique,\n+                        table=self.quote_name(model._meta.db_table),\n+                        name=self.quote_name(name),\n+                        columns=Columns(model._meta.db_table, columns, self.quote_name),\n+                    )\n+\n+        # For all other cases, use the default implementation\n+        return super()._create_unique_sql(\n+            model, fields, name=name, condition=condition,\n+            deferrable=deferrable, include=include,\n+            opclasses=opclasses, expressions=expressions,\n+        )",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-14999",
    "model_patch": "diff --git a/django/db/migrations/operations/models.py b/django/db/migrations/operations/models.py\nindex 982816be3a..a871e51e25 100644\n--- a/django/db/migrations/operations/models.py\n+++ b/django/db/migrations/operations/models.py\n@@ -321,11 +321,12 @@ class RenameModel(ModelOperation):\n         if self.allow_migrate_model(schema_editor.connection.alias, new_model):\n             old_model = from_state.apps.get_model(app_label, self.old_name)\n             # Move the main table\n-            schema_editor.alter_db_table(\n-                new_model,\n-                old_model._meta.db_table,\n-                new_model._meta.db_table,\n-            )\n+            if old_model._meta.db_table != new_model._meta.db_table:\n+                schema_editor.alter_db_table(\n+                    new_model,\n+                    old_model._meta.db_table,\n+                    new_model._meta.db_table,\n+                )\n             # Alter the fields pointing to us\n             for related_object in old_model._meta.related_objects:\n                 if related_object.related_model == old_model:\n@@ -354,11 +355,12 @@ class RenameModel(ModelOperation):\n                 # Rename the M2M table that's based on this model's name.\n                 old_m2m_model = old_field.remote_field.through\n                 new_m2m_model = new_field.remote_field.through\n-                schema_editor.alter_db_table(\n-                    new_m2m_model,\n-                    old_m2m_model._meta.db_table,\n-                    new_m2m_model._meta.db_table,\n-                )\n+                if old_m2m_model._meta.db_table != new_m2m_model._meta.db_table:\n+                    schema_editor.alter_db_table(\n+                        new_m2m_model,\n+                        old_m2m_model._meta.db_table,\n+                        new_m2m_model._meta.db_table,\n+                    )\n                 # Rename the column in the M2M table that's based on this\n                 # model's name.\n                 schema_editor.alter_field(",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15061",
    "model_patch": "diff --git a/django/forms/widgets.py b/django/forms/widgets.py\nindex 00c19e2c55..4fa7ae6406 100644\n--- a/django/forms/widgets.py\n+++ b/django/forms/widgets.py\n@@ -849,9 +849,12 @@ class MultiWidget(Widget):\n         return context\n \n     def id_for_label(self, id_):\n-        if id_:\n-            id_ += '_0'\n-        return id_\n+        \"\"\"\n+        Return None to prevent adding a 'for' attribute to the label, since\n+        MultiWidget contains multiple input elements and a label should not\n+        reference just one of them.\n+        \"\"\"\n+        return None\n \n     def value_from_datadict(self, data, files, name):\n         return [",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15202",
    "model_patch": "diff --git a/django/core/validators.py b/django/core/validators.py\nindex 72fbe15551..0606325cc8 100644\n--- a/django/core/validators.py\n+++ b/django/core/validators.py\n@@ -127,7 +127,10 @@ class URLValidator(RegexValidator):\n                 raise\n         else:\n             # Now verify IPv6 in the netloc part\n-            host_match = re.search(r'^\\[(.+)\\](?::\\d{1,5})?$', urlsplit(value).netloc)\n+            try:\n+                host_match = re.search(r'^\\[(.+)\\](?::\\d{1,5})?$', urlsplit(value).netloc)\n+            except ValueError:\n+                raise ValidationError(self.message, code=self.code, params={'value': value})\n             if host_match:\n                 potential_ip = host_match[1]\n                 try:",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15213",
    "model_patch": "diff --git a/django/db/models/expressions.py b/django/db/models/expressions.py\nindex 8642e1f151..5d5aa67e12 100644\n--- a/django/db/models/expressions.py\n+++ b/django/db/models/expressions.py\n@@ -979,7 +979,16 @@ class ExpressionWrapper(SQLiteNumericMixin, Expression):\n         return super().get_group_by_cols()\n \n     def as_sql(self, compiler, connection):\n-        return compiler.compile(self.expression)\n+        try:\n+            sql, params = compiler.compile(self.expression)\n+        except EmptyResultSet:\n+            empty_result_set_value = getattr(self.expression, 'empty_result_set_value', NotImplemented)\n+            if empty_result_set_value is NotImplemented:\n+                raise\n+            sql, params = compiler.compile(Value(empty_result_set_value))\n+        if hasattr(self.expression, 'select_format'):\n+            sql, params = self.expression.select_format(compiler, sql, params)\n+        return sql, params\n \n     def __repr__(self):\n         return \"{}({})\".format(self.__class__.__name__, self.expression)\ndiff --git a/django/db/models/sql/where.py b/django/db/models/sql/where.py\nindex 50ff13be75..9185af1567 100644\n--- a/django/db/models/sql/where.py\n+++ b/django/db/models/sql/where.py\n@@ -214,8 +214,15 @@ class WhereNode(tree.Node):\n         # Wrap filters with a CASE WHEN expression if a database backend\n         # (e.g. Oracle) doesn't support boolean expression in SELECT or GROUP\n         # BY list.\n-        if not compiler.connection.features.supports_boolean_expr_in_select_clause:\n+        import sys\n+        print(f'DEBUG: select_format called with sql={repr(sql)}, params={params}', file=sys.stderr)\n+        if not sql:\n+            # An empty sql means this expression matches everything.\n+            sql = '1' if not compiler.connection.features.supports_boolean_expr_in_select_clause else 'TRUE'\n+            print(f'DEBUG: Empty sql detected, using {repr(sql)}', file=sys.stderr)\n+        elif not compiler.connection.features.supports_boolean_expr_in_select_clause:\n             sql = f'CASE WHEN {sql} THEN 1 ELSE 0 END'\n+        print(f'DEBUG: select_format returning sql={repr(sql)}', file=sys.stderr)\n         return sql, params\n \n     def get_db_converters(self, connection):\ndiff --git a/tests/expressions/tests.py b/tests/expressions/tests.py\nindex dab5474ef4..6bd2a7b3c8 100644\n--- a/tests/expressions/tests.py\n+++ b/tests/expressions/tests.py\n@@ -2025,6 +2025,22 @@ class ExpressionWrapperTests(SimpleTestCase):\n         self.assertEqual(group_by_cols, [expr.expression])\n         self.assertEqual(group_by_cols[0].output_field, expr.output_field)\n \n+    def test_empty_q_in_lookup(self):\n+        \"\"\"Test that ExpressionWrapper(Q(pk__in=[])) produces valid SQL.\"\"\"\n+        from django.db.models import BooleanField\n+        expr = ExpressionWrapper(Q(pk__in=[]), output_field=BooleanField())\n+        # Should not raise an exception and should be able to generate SQL\n+        # The actual SQL generation requires a query, but we can check the expression structure\n+        self.assertIsNotNone(expr.expression)\n+\n+    def test_empty_negated_q_in_lookup(self):\n+        \"\"\"Test that ExpressionWrapper(~Q(pk__in=[])) produces valid SQL.\"\"\"\n+        from django.db.models import BooleanField\n+        expr = ExpressionWrapper(~Q(pk__in=[]), output_field=BooleanField())\n+        # Should not raise an exception and should be able to generate SQL\n+        # The actual SQL generation requires a query, but we can check the expression structure\n+        self.assertIsNotNone(expr.expression)\n+\n \n class OrderByTests(SimpleTestCase):\n     def test_equal(self):",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15252",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15320",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15347",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15388",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15400",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15498",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15695",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15738",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15781",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15789",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15790",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15814",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-15996",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-16820",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-16873",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-16910",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-17051",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "django__django-17087",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "matplotlib__matplotlib-18869",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "mwaskom__seaborn-3190",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "mwaskom__seaborn-3407",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pallets__flask-4045",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pallets__flask-4992",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pallets__flask-5063",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "psf__requests-863",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pydata__xarray-4094",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pydata__xarray-4248",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pydata__xarray-4493",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pydata__xarray-5131",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pylint-dev__pylint-5859",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pylint-dev__pylint-6506",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pylint-dev__pylint-7080",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pylint-dev__pylint-7114",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pylint-dev__pylint-7228",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pylint-dev__pylint-7993",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-11143",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-11148",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "pytest-dev__pytest-5103",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  },
  {
    "instance_id": "sympy__sympy-15011",
    "model_patch": "",
    "model_name_or_path": "sage-agent"
  }
]